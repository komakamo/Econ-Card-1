<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¨ã‚³ãƒãƒŸã‚¯ã‚¹ãƒ»ãƒã‚¹ã‚¿ãƒ¼ - çµŒæ¸ˆå­¦ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS (ãƒ‡ã‚¶ã‚¤ãƒ³ç”¨) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans JP"', 'sans-serif'],
                        mono: ['"Noto Sans JP"', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#06b6d4', // Cyan 500
                            600: '#0891b2', // Cyan 600
                            700: '#0e7490', // Cyan 700
                            900: '#164e63', // Cyan 900
                        },
                        dark: {
                            900: '#0f172a', // Slate 900
                            800: '#1e293b', // Slate 800
                            700: '#334155', // Slate 700
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM (ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (JSXã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes floatUp {
            0% { transform: translate(-50%, 0) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -40px) scale(1.2); opacity: 0; }
        }
        .animate-float-up {
            animation: floatUp 1.2s ease-out forwards;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        .animate-shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in-right {
            animation: slideInRight 0.5s ease-out forwards;
        }

        @keyframes flashRed {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(220, 38, 38, 0.3); }
        }
        .animate-flash-red {
            animation: flashRed 0.5s ease-in-out 3;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(6, 182, 212, 0.2); }
            50% { box-shadow: 0 0 25px rgba(6, 182, 212, 0.6); }
        }
        .animate-pulse-glow {
            animation: pulseGlow 2s infinite;
        }

        @keyframes scrollGrid {
            0% { background-position: 50% 0, 0 0, 0 0; }
            100% { background-position: 50% 0, 40px 40px, 40px 40px; }
        }

        body {
            background-color: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        /* Scrollbar customization */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 5px;
            border: 2px solid #0f172a;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>
<body class="antialiased selection:bg-brand-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Sound Manager (Web Audio API) ---
        const SoundManager = {
            ctx: null,
            isMuted: false,
            masterVolume: 0.5,

            setVolume(vol) {
                this.masterVolume = Math.max(0, Math.min(1, vol));
            },

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },

            playTone(freq, type, duration, vol = 0.1) {
                if (this.isMuted) return;
                try {
                    this.init();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);

                    const finalVol = vol * this.masterVolume;
                    gain.gain.setValueAtTime(finalVol, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + duration);
                } catch (e) {
                    console.error("Audio error:", e);
                }
            },

            playClick() {
                this.playTone(800, 'sine', 0.1, 0.05);
            },

            playError() {
                if (this.isMuted) return;
                try {
                    this.init();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, this.ctx.currentTime);
                    osc.frequency.linearRampToValueAtTime(100, this.ctx.currentTime + 0.3);
                    gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + 0.3);
                } catch (e) {
                    console.error(e);
                }
            },

            playSuccess() {
                this.playTone(1200, 'sine', 0.2, 0.1);
                setTimeout(() => this.playTone(1800, 'sine', 0.4, 0.1), 100);
            },

            playCard(type) {
                if (this.isMuted) return;
                if (type === 'ATTACK') {
                    this.playTone(300, 'square', 0.3, 0.05);
                } else if (type === 'POLICY') {
                    this.playTone(600, 'sine', 0.3, 0.05);
                } else {
                    // PRODUCTION
                    this.playTone(400, 'triangle', 0.1, 0.05);
                    setTimeout(() => this.playTone(600, 'triangle', 0.2, 0.05), 100);
                }
            },

            playGameEnd(win) {
                if (this.isMuted) return;
                if (win) {
                    this.playTone(523.25, 'triangle', 0.2, 0.1); // C5
                    setTimeout(() => this.playTone(659.25, 'triangle', 0.2, 0.1), 200); // E5
                    setTimeout(() => this.playTone(783.99, 'triangle', 0.4, 0.1), 400); // G5
                    setTimeout(() => this.playTone(1046.50, 'triangle', 0.8, 0.1), 600); // C6
                } else {
                    this.playTone(300, 'sawtooth', 0.4, 0.1);
                    setTimeout(() => this.playTone(250, 'sawtooth', 0.4, 0.1), 300);
                    setTimeout(() => this.playTone(200, 'sawtooth', 0.8, 0.1), 600);
                }
            },

            playCrisis() {
                if (this.isMuted) return;
                try {
                    this.init();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'sawtooth';
                    // Siren effect
                    osc.frequency.setValueAtTime(400, this.ctx.currentTime);
                    osc.frequency.linearRampToValueAtTime(600, this.ctx.currentTime + 0.5);
                    osc.frequency.linearRampToValueAtTime(400, this.ctx.currentTime + 1.0);

                    gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 1.0);

                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + 1.0);
                } catch (e) { console.error(e); }
            },

            playDoom() {
                 if (this.isMuted) return;
                try {
                    this.init();
                    // Low rumble
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    const filter = this.ctx.createBiquadFilter();

                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(50, this.ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(30, this.ctx.currentTime + 2.0);

                    filter.type = 'lowpass';
                    filter.frequency.value = 200;

                    gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 2.0);

                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + 2.0);
                } catch (e) { console.error(e); }
            }
        };

        // --- ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (SVGåŸ‹ã‚è¾¼ã¿) ---
        // GitHub Pagesç­‰ã§å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¾å­˜ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚SVGã‚’ç›´æ¥å®šç¾©
        const IconWallet = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>
        );
        const IconTrendingUp = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
        );
        const IconZap = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        );
        const IconShield = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        );
        const IconAlertCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        );
        const IconArrowRight = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        );
        const IconRefreshCw = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
        );
        const IconBookOpen = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        );
        const IconVolume2 = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
        );
        const IconVolumeX = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
        );

        const IconX = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        );

        // --- Visual Effects ---
        const BackgroundEffects = () => {
            const [particles, setParticles] = useState([]);
            const [tickers, setTickers] = useState([]);

            useEffect(() => {
                // Initialize particles (Currency & Charts)
                const symbols = ['Â¥', '$', 'â‚¬', 'Â£', '%', 'BTC', 'ğŸ“ˆ', 'ğŸ“‰', 'â–²', 'â–¼'];
                const colors = ['text-slate-500', 'text-cyan-500', 'text-emerald-500', 'text-amber-500', 'text-rose-500'];

                const initialParticles = Array.from({ length: 40 }).map((_, i) => ({
                    id: i,
                    symbol: symbols[Math.floor(Math.random() * symbols.length)],
                    left: Math.random() * 100, // %
                    duration: 15 + Math.random() * 20, // s
                    delay: -Math.random() * 40, // s
                    size: 10 + Math.random() * 30, // px
                    opacity: 0.1 + Math.random() * 0.3,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    xOffset: (Math.random() - 0.5) * 50 // Drift
                }));
                setParticles(initialParticles);

                // Initialize Ticker Lines (Matrix-like numbers)
                const tickerCount = 6;
                const newTickers = Array.from({ length: tickerCount }).map((_, i) => ({
                    id: i,
                    left: 10 + (i * (80 / tickerCount)) + (Math.random() * 5),
                    speed: 10 + Math.random() * 15,
                    delay: -Math.random() * 20,
                    opacity: 0.1 + Math.random() * 0.1
                }));
                setTickers(newTickers);

            }, []);

            return (
                <div className="fixed inset-0 pointer-events-none z-0 overflow-hidden bg-slate-900">
                    {/* 1. Dynamic Gradient Background */}
                    <div className="absolute inset-0 opacity-40 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-slate-900 to-black"></div>
                    <div className="absolute inset-0 bg-gradient-to-br from-cyan-900/20 via-slate-900/50 to-purple-900/20 animate-pulse-slow"></div>

                    {/* 2. 3D Grid Floor (Retro/Cyber Style) */}
                    <div className="absolute bottom-[-20%] left-[-50%] w-[200%] h-[80vh] opacity-30"
                         style={{ transform: 'perspective(500px) rotateX(60deg)' }}>
                         <div className="w-full h-full bg-[linear-gradient(to_right,rgba(6,182,212,0.3)_1px,transparent_1px),linear-gradient(to_bottom,rgba(6,182,212,0.3)_1px,transparent_1px)] bg-[size:40px_40px] animate-grid-scroll"></div>
                    </div>

                    {/* 3. Ambient Light Blobs (Enhanced) */}
                    <div className="absolute top-[-10%] left-[-10%] w-[60vw] h-[60vw] bg-cyan-500/10 rounded-full blur-[120px] animate-blob mix-blend-screen"></div>
                    <div className="absolute bottom-[-10%] right-[-10%] w-[60vw] h-[60vw] bg-purple-500/10 rounded-full blur-[120px] animate-blob animation-delay-2000 mix-blend-screen"></div>
                    <div className="absolute top-[30%] left-[40%] w-[40vw] h-[40vw] bg-blue-500/10 rounded-full blur-[100px] animate-blob animation-delay-4000 mix-blend-screen"></div>

                    {/* 4. Falling Tickers (Matrix-ish) */}
                    {tickers.map(t => (
                        <div
                            key={t.id}
                            className="absolute top-0 w-8 text-[10px] font-mono leading-none text-cyan-400 break-words text-center opacity-10"
                            style={{
                                left: `${t.left}%`,
                                opacity: t.opacity,
                                animation: `fall ${t.speed}s linear infinite`,
                                animationDelay: `${t.delay}s`,
                                textShadow: '0 0 5px rgba(6,182,212,0.5)'
                            }}
                        >
                            {Array.from({length: 50}).map(() => Math.floor(Math.random()*10)).join('\n')}
                        </div>
                    ))}

                    {/* 5. Chart Line Decoration (Animated) */}
                    <div className="absolute bottom-0 left-0 w-full h-[50vh] opacity-30">
                         <svg className="w-full h-full" viewBox="0 0 1000 200" preserveAspectRatio="none">
                             <defs>
                                 <linearGradient id="gradChart" x1="0%" y1="0%" x2="0%" y2="100%">
                                     <stop offset="0%" stopColor="#06b6d4" stopOpacity="0.4" />
                                     <stop offset="100%" stopColor="#06b6d4" stopOpacity="0" />
                                 </linearGradient>
                                 <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                                    <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                             </defs>
                             <path d="M0,150 Q100,100 200,140 T400,80 T600,120 T800,40 T1000,100 V200 H0 Z" fill="url(#gradChart)" className="animate-pulse-slow" />
                             <path d="M0,150 Q100,100 200,140 T400,80 T600,120 T800,40 T1000,100" fill="none" stroke="#22d3ee" strokeWidth="2" filter="url(#glow)" className="animate-dash" strokeDasharray="2000" strokeDashoffset="2000" />
                         </svg>
                    </div>

                    {/* 6. Floating Particles (Symbols) */}
                    {particles.map(p => (
                        <div
                            key={p.id}
                            className={`absolute select-none font-bold ${p.color}`}
                            style={{
                                left: `${p.left}%`,
                                bottom: '-50px',
                                fontSize: `${p.size}px`,
                                opacity: p.opacity,
                                animation: `floatUpComplex ${p.duration}s linear infinite`,
                                animationDelay: `${p.delay}s`,
                                textShadow: '0 0 10px currentColor',
                                transform: 'translateZ(0)',
                            }}
                        >
                            {p.symbol}
                        </div>
                    ))}

                    <style>{`
                        @keyframes floatUpComplex {
                            0% { transform: translateY(0) rotate(0deg) scale(0.8); opacity: 0; }
                            10% { opacity: var(--opacity); }
                            90% { opacity: var(--opacity); }
                            100% { transform: translateY(-120vh) rotate(360deg) scale(1.2); opacity: 0; }
                        }
                        @keyframes gridScroll {
                            0% { background-position: 0 0; }
                            100% { background-position: 0 40px; }
                        }
                        @keyframes blob {
                            0% { transform: translate(0px, 0px) scale(1); }
                            33% { transform: translate(30px, -50px) scale(1.1); }
                            66% { transform: translate(-20px, 20px) scale(0.9); }
                            100% { transform: translate(0px, 0px) scale(1); }
                        }
                        .animate-blob {
                            animation: blob 10s infinite;
                        }
                        .animate-grid-scroll {
                            animation: gridScroll 2s linear infinite;
                        }
                        @keyframes dash {
                            to { stroke-dashoffset: 0; }
                        }
                        .animate-dash {
                            animation: dash 5s ease-out forwards infinite;
                        }
                        @keyframes fall {
                            0% { transform: translateY(-10%); }
                            100% { transform: translateY(110%); }
                        }
                        @keyframes pulseSlow {
                            0%, 100% { transform: scale(1); opacity: 0.5; }
                            50% { transform: scale(1.1); opacity: 0.8; }
                        }
                        .animate-pulse-slow {
                            animation: pulseSlow 8s ease-in-out infinite;
                        }
                    `}</style>
                </div>
            );
        };

        const IconSettings = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        );

        const IconGlobe = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
        );

        const IconAward = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 17 17 23 15.79 13.88"></polyline></svg>
        );

        const IconStar = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
        );

        const IconLock = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        );

        const IconType = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>
        );

        // --- Localization Helpers ---
        const UI_TEXT = {
            ja: {
                title: "ã‚¨ã‚³ãƒãƒŸã‚¯ã‚¹ãƒ»ãƒã‚¹ã‚¿ãƒ¼",
                subtitle: "çµŒæ¸ˆå­¦ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ",
                turn: "TURN",
                goal: "ç›®æ¨™",
                start: "Start",
                reset: "Reset",
                startGame: "ã‚²ãƒ¼ãƒ é–‹å§‹",
                playAgain: "ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤",
                victory: "VICTORY",
                defeat: "GAME OVER",
                victoryDesc: "çµŒæ¸ˆç›®æ¨™é”æˆ",
                defeatDesc: "æ”¿æ¨©å´©å£Š / çµŒæ¸ˆæ•—åŒ—",
                resultReport: "Result Report",
                nextGoal: "Next Goal",
                comboGuide: "Combo Guide (ã‚³ãƒ³ãƒœå›³é‘‘)",
                comboHint: "â˜… ãƒ’ãƒ³ãƒˆ",
                comboHintDesc: "ç›´å‰ã«ãƒ—ãƒ¬ã‚¤ã—ãŸã‚«ãƒ¼ãƒ‰ã®ã‚¿ã‚°ã¨å™›ã¿åˆã†ã¨<br/>åŠ¹æœãŒ1.3å€ã«ãªã‚Šã¾ã™ï¼",
                cardInfo: "ã‚«ãƒ¼ãƒ‰è§£èª¬",
                cardInfoDesc: "ã‚«ãƒ¼ãƒ‰ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’åˆã‚ã›ã‚‹ã¨<br/>è©³ã—ã„è§£èª¬ãŒè¡¨ç¤ºã•ã‚Œã¾ã™",
                memo: "çµŒæ¸ˆãƒ¡ãƒ¢",
                detail: "åŠ¹æœè©³ç´°",
                myCountry: "è‡ªå›½ (ã‚ãªãŸ)",
                rivalCountry: "ãƒ©ã‚¤ãƒãƒ«å›½",
                gdp: "GDP",
                money: "è³‡é‡‘æ®‹é«˜",
                income: "åæ”¯",
                interest: "åˆ©æ‰•",
                support: "å›½æ°‘æ”¯æŒç‡",
                debt: "å‚µå‹™æ®‹é«˜",
                inflation: "ã‚¤ãƒ³ãƒ•ãƒ¬",
                trillion: "å…†",
                selectPlaystyle: "Select Playstyle (æ€æƒ³ãƒ»æ´¾é–¥)",
                selectDifficulty: "Select Difficulty",
                yourHand: "Your Hand",
                bond: "å›½å‚µç™ºè¡Œ",
                endTurn: "ã‚¿ãƒ¼ãƒ³çµ‚äº†",
                discard: "Discard / Last Played",
                deck: "DECK",
                noCards: "No cards available",
                log: "Game Log",
                live: "LIVE",
                cost: "Cost",
                successRate: "æˆåŠŸç‡",
                cardTypeProd: "ç”Ÿç”£",
                cardTypePolicy: "æ”¿ç­–",
                cardTypeAttack: "å¤–äº¤",
                tagInfra: "ã‚¤ãƒ³ãƒ•ãƒ©",
                tagInfraDesc: "ã€Œè¨­å‚™æŠ•è³‡ã€ã‚„ã€Œå…¬å…±äº‹æ¥­ã€ã§ä»˜ä¸ã€‚ç”Ÿç”£ç³»ã‚«ãƒ¼ãƒ‰ã®åŠ¹æœã‚’é«˜ã‚ã¾ã™ã€‚",
                tagEdu: "æ•™è‚²ãƒ»äººæ",
                tagEduDesc: "ã€Œäººæè‚²æˆã€ã§ä»˜ä¸ã€‚æŠ€è¡“ç³»ã‚«ãƒ¼ãƒ‰ã®åœŸå°ã¨ãªã‚Šã¾ã™ã€‚",
                tagInno: "ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³",
                tagInnoDesc: "ã€ŒæŠ€è¡“é©æ–°ã€ã§ä»˜ä¸ã€‚æ¬¡ã®æŠ€è¡“æŠ•è³‡ã‚’å¤§ãããƒ–ãƒ¼ã‚¹ãƒˆã—ã¾ã™ã€‚",
                tagTech: "å…ˆç«¯æŠ€è¡“",
                tagTechDesc: "ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ç­‰ã€‚ITé©å‘½æœŸã«åŠ¹æœãŒå€å¢—ã™ã‚‹å¼·åŠ›ãªã‚¿ã‚°ã€‚",
                turnSummary: "ã‚¿ãƒ¼ãƒ³ã‚µãƒãƒªãƒ¼",
                highlight: "ã“ã®ã‚¿ãƒ¼ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ",
                outlook: "æ¬¡ã‚¿ãƒ¼ãƒ³ã¸ã®æ³¨æ„",
                continue: "ç¶šã‘ã‚‹",
                ideologyMission: "æ€æƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ (Sãƒ©ãƒ³ã‚¯)",
                ideologyMissionDesc: "ç¾åœ¨ã®æ€æƒ³ã§Sãƒ©ãƒ³ã‚¯ã‚’ç²å¾—ã™ã‚‹ãŸã‚ã®æ¡ä»¶ã§ã™ã€‚",
                encyclopedia: "çµŒæ¸ˆã‚«ãƒ¼ãƒ‰å›³é‘‘",
                collectionProgress: "åé›†ç‡",
                unknown: "æœªç™ºè¦‹",
                cardDetail: "ã‚«ãƒ¼ãƒ‰è©³ç´°",
                close: "é–‰ã˜ã‚‹",
                tags: "é–¢é€£ã‚¿ã‚°",
                playToUnlock: "ãƒ—ãƒ¬ã‚¤ã—ã¦è§£ç¦",
            },
            en: {
                title: "Economics Master",
                subtitle: "Strategic Card Game",
                turn: "TURN",
                goal: "GOAL",
                start: "Start",
                reset: "Reset",
                startGame: "START GAME",
                playAgain: "Play Again",
                victory: "VICTORY",
                defeat: "GAME OVER",
                victoryDesc: "Economic Goal Achieved",
                defeatDesc: "Administration Collapse / Defeat",
                resultReport: "Result Report",
                nextGoal: "Next Goal",
                comboGuide: "Combo Guide",
                comboHint: "â˜… Hint",
                comboHintDesc: "Match tags with the last played card<br/>for a 1.3x Effect Bonus!",
                cardInfo: "Card Info",
                cardInfoDesc: "Hover over a card to see<br/>detailed information.",
                memo: "Econ Memo",
                detail: "Effect Details",
                myCountry: "My Country (YOU)",
                rivalCountry: "Rival Country",
                gdp: "GDP",
                money: "Funds",
                income: "Income",
                interest: "Interest",
                support: "Support",
                debt: "Debt",
                inflation: "Inflation",
                trillion: "T",
                selectPlaystyle: "Select Playstyle",
                selectDifficulty: "Select Difficulty",
                yourHand: "Your Hand",
                bond: "Issue Bonds",
                endTurn: "End Turn",
                discard: "Discard / Last Played",
                deck: "DECK",
                noCards: "No cards available",
                log: "Game Log",
                live: "LIVE",
                cost: "Cost",
                successRate: "Success",
                cardTypeProd: "PROD",
                cardTypePolicy: "POLICY",
                cardTypeAttack: "DIPLO",
                tagInfra: "Infrastructure",
                tagInfraDesc: "Granted by 'Investment' or 'Public Works'. Boosts production cards.",
                tagEdu: "Education",
                tagEduDesc: "Granted by 'Human Capital'. Foundation for technology cards.",
                tagInno: "Innovation",
                tagInnoDesc: "Granted by 'Tech Innovation'. Boosts next tech investment.",
                tagTech: "High-Tech",
                tagTechDesc: "Startups etc. Doubles effect during IT Revolution.",
                turnSummary: "Turn Summary",
                highlight: "This Turn's Highlight",
                outlook: "Next Turn's Outlook",
                continue: "Continue",
                ideologyMission: "Ideology Mission (S Rank)",
                ideologyMissionDesc: "Conditions to achieve S Rank with the current ideology.",
                encyclopedia: "Card Encyclopedia",
                collectionProgress: "Collection",
                unknown: "Unknown",
                cardDetail: "Card Detail",
                close: "Close",
                tags: "Tags",
                playToUnlock: "Play to Unlock",
            }
        };

        const getLoc = (obj, key, lang) => {
             if (lang === 'en' && obj[key + '_en']) return obj[key + '_en'];
             return obj[key];
        };

        const t = (key, lang) => {
            return UI_TEXT[lang][key] || UI_TEXT['ja'][key] || key;
        };

        // --- ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å®šç¾© ---

        const CARD_TYPES = {
            PRODUCTION: {
                label: 'ç”Ÿç”£',
                label_en: 'PROD',
                baseStyle: 'bg-slate-800 border-cyan-800 hover:border-cyan-400 hover:shadow-cyan-500/20 text-cyan-100',
                headerStyle: 'bg-cyan-950/50 text-cyan-400 border-b border-cyan-900',
                icon: <IconZap size={14} className="text-cyan-400" />
            },
            POLICY: {
                label: 'æ”¿ç­–',
                label_en: 'POLICY',
                baseStyle: 'bg-slate-800 border-emerald-800 hover:border-emerald-400 hover:shadow-emerald-500/20 text-emerald-100',
                headerStyle: 'bg-emerald-950/50 text-emerald-400 border-b border-emerald-900',
                icon: <IconBookOpen size={14} className="text-emerald-400" />
            },
            ATTACK: {
                label: 'å¤–äº¤',
                label_en: 'DIPLO',
                baseStyle: 'bg-slate-800 border-rose-800 hover:border-rose-400 hover:shadow-rose-500/20 text-rose-100',
                headerStyle: 'bg-rose-950/50 text-rose-400 border-b border-rose-900',
                icon: <IconShield size={14} className="text-rose-400" />
            },
        };

        const EVENTS = [
            {
                id: 1,
                name: 'åŸæ²¹ã‚·ãƒ§ãƒƒã‚¯',
                name_en: 'Oil Shock',
                description: 'è³‡æºä¾¡æ ¼é«˜é¨°ã§ã‚ã‚‰ã‚†ã‚‹æ”¿ç­–ã‚³ã‚¹ãƒˆãŒ20%ä¸Šæ˜‡ã—ã¾ã™ã€‚',
                description_en: 'Resource prices soar, increasing all policy costs by 20%.',
                effect: { costMultiplier: 1.2 },
            },
            {
                id: 2,
                name: 'ç·Šç¸®è²¡æ”¿',
                name_en: 'Fiscal Austerity',
                description: 'è²¡æ”¿å†å»ºã®ãŸã‚åå…¥ãŒæ¯ã‚¿ãƒ¼ãƒ³3å…†å††æ¸›å°‘ã—ã¾ã™ã€‚',
                description_en: 'Income decreases by 3 trillion/turn for fiscal reconstruction.',
                effect: { incomePenalty: 3 },
            },
            {
                id: 3,
                name: 'æŠ€è¡“é©æ–°ãƒ–ãƒ¼ãƒ ',
                name_en: 'Tech Innovation Boom',
                description: 'ã‚«ãƒ¼ãƒ‰ã®çµŒæ¸ˆåŠ¹æœãŒ1.3å€ã«å¢—å¹…ã—ã¾ã™ã€‚',
                description_en: 'Economic effects of cards amplified by 1.3x.',
                effect: { effectMultiplier: 1.3 },
            },
            {
                id: 4,
                name: 'æ™¯æ°—å¾Œé€€',
                name_en: 'Recession',
                description: 'ã‚«ãƒ¼ãƒ‰ã®çµŒæ¸ˆåŠ¹æœãŒ0.7å€ã«ç¸®å°ã—ã€è³‡é‡‘ç¹°ã‚ŠãŒå³ã—ããªã‚Šã¾ã™ã€‚',
                description_en: 'Economic effects reduced by 0.7x, and funding becomes difficult.',
                effect: { effectMultiplier: 0.7, costMultiplier: 1.1 },
            },
        ];

        const ERAS = {
            GROWTH: {
                id: 'GROWTH',
                name: 'é«˜åº¦çµŒæ¸ˆæˆé•·æœŸ',
                name_en: 'High Growth Era',
                description: 'GDPâ†‘ ã‚¤ãƒ³ãƒ•ãƒ¬â†‘',
                description_en: 'Increased GDP growth, inflation accelerates',
                bgClass: 'bg-orange-900/10',
                effectDesc: 'GDPä¸Šæ˜‡åŠ¹æœå¢—ãƒ»ã‚¤ãƒ³ãƒ•ãƒ¬åŠ é€Ÿ',
                effectDesc_en: 'GDP growth bonus, Inflation accelerates'
            },
            STAGNATION: {
                id: 'STAGNATION',
                name: 'ãƒãƒ–ãƒ«å´©å£Šãƒ»åœæ»æœŸ',
                name_en: 'Bubble Burst / Stagnation',
                description: 'ã‚³ã‚¹ãƒˆå¢—ãƒ»ãƒ‡ãƒ•ãƒ¬ãƒ»åç›Šæ¸›',
                description_en: 'Card costs up, income down, deflation',
                bgClass: 'bg-slate-950',
                effectDesc: 'ã‚«ãƒ¼ãƒ‰ã‚³ã‚¹ãƒˆå¢—ãƒ»åç›Šæ¸›ãƒ»ãƒ‡ãƒ•ãƒ¬é€²è¡Œ',
                effectDesc_en: 'Costs increase, Income decreases, Deflation'
            },
            IT_REV: {
                id: 'IT_REV',
                name: 'ITé©å‘½ãƒ»æ–°æ™‚ä»£',
                name_en: 'IT Revolution',
                description: 'æŠ€è¡“ã‚«ãƒ¼ãƒ‰åŠ¹æœ2å€',
                description_en: 'Technology cards effect doubled',
                bgClass: 'bg-cyan-950/20',
                effectDesc: 'æŠ€è¡“ç³»ã‚«ãƒ¼ãƒ‰ã®åŠ¹æœãŒ2å€',
                effectDesc_en: 'Technology cards effect doubled'
            }
        };

        const IDEOLOGIES = {
            KEYNESIAN: {
                id: 'KEYNESIAN',
                name: 'ã‚±ã‚¤ãƒ³ã‚ºæ´¾',
                name_en: 'Keynesian',
                label: 'ç©æ¥µè²¡æ”¿',
                label_en: 'Active Fiscal',
                description: 'ä¸æ³æ™‚ã¯æ”¿åºœæ”¯å‡ºã§éœ€è¦ã‚’å‰µå‡ºã—ã¾ã™ã€‚',
                description_en: 'Create demand via government spending during recession.',
                features: ['å…¬å…±äº‹æ¥­ãƒ»é‡‘èç·©å’Œ å¤šã‚', 'åˆæœŸæ”¯æŒç‡ é«˜', 'åˆæœŸå‚µå‹™ ã‚ã‚Š'],
                features_en: ['Public Works/Easing', 'High Initial Support', 'Initial Debt'],
                initialStats: { support: 80, debt: 50, money: 120 },
                deckWeights: { 3: 3, 4: 2, 6: 2 },
                rankCriteria: { minGdp: 400, maxInflation: 4, minInflation: 2, maxDebt: 100 },
                title: "å¤§ææ…Œãƒã‚¹ã‚¿ãƒ¼",
                title_en: "Depression Buster",
                rankCriteria_text: "GDPâ‰¥400T, ã‚¤ãƒ³ãƒ•ãƒ¬2-4%, å‚µå‹™â‰¤100T, æ”¯æŒç‡â‰¥60, AAA",
                rankCriteria_text_en: "GDPâ‰¥400T, Inf 2-4%, Debtâ‰¤100T, Supportâ‰¥60, AAA"
            },
            MONETARIST: {
                id: 'MONETARIST',
                name: 'ãƒãƒã‚¿ãƒªã‚¹ãƒˆ',
                name_en: 'Monetarist',
                label: 'è¦å¾‹é‡è¦–',
                label_en: 'Discipline',
                description: 'é€šè²¨ä¾›çµ¦ã‚’ç®¡ç†ã—ã€ã‚¤ãƒ³ãƒ•ãƒ¬æŠ‘åˆ¶ã‚’æœ€å„ªå…ˆã—ã¾ã™ã€‚',
                description_en: 'Control money supply, prioritize inflation control.',
                features: ['å¢—ç¨ãƒ»é‡‘èå¼•ãç· ã‚', 'ã‚¤ãƒ³ãƒ•ãƒ¬æŠ‘åˆ¶ã§é«˜è©•ä¾¡', 'å …å®Ÿãªé‹å–¶'],
                features_en: ['Tax Hikes/Tightening', 'High Rating for Low Inf', 'Steady Management'],
                initialStats: { support: 60, debt: 0, money: 70 },
                deckWeights: { 5: 3, 4: 2, 11: 2 },
                rankCriteria: { minGdp: 350, maxInflation: 2, minInflation: -1, maxDebt: 80 },
                bonusCondition: (stats) => stats.inflation >= -1 && stats.inflation <= 2,
                title: "ã‚¤ãƒ³ãƒ•ãƒ¬ãƒãƒ³ã‚¿ãƒ¼",
                title_en: "Inflation Hunter",
                rankCriteria_text: "GDPâ‰¥350T, ã‚¤ãƒ³ãƒ•ãƒ¬-1-2%, å‚µå‹™â‰¤80T, æ”¯æŒç‡â‰¥60, AAA",
                rankCriteria_text_en: "GDPâ‰¥350T, Inf -1-2%, Debtâ‰¤80T, Supportâ‰¥60, AAA"
            },
            SUPPLY_SIDE: {
                id: 'SUPPLY_SIDE',
                name: 'ã‚µãƒ—ãƒ©ã‚¤ã‚µã‚¤ãƒ‰',
                name_en: 'Supply-Side',
                label: 'æˆé•·æˆ¦ç•¥',
                label_en: 'Growth Strategy',
                description: 'è¦åˆ¶ç·©å’Œã¨æŠ•è³‡ã§ä¾›çµ¦åŠ›ã‚’é«˜ã‚ã€GDPæˆé•·ã‚’ä¿ƒã—ã¾ã™ã€‚',
                description_en: 'Deregulation and investment to boost supply and GDP.',
                features: ['è¨­å‚™æŠ•è³‡ãƒ»æŠ€è¡“é©æ–°', 'GDPé‡è¦–', 'å¤§å™¨æ™©æˆ'],
                features_en: ['Investment/Innovation', 'GDP Focus', 'Late Bloomer'],
                initialStats: { support: 70, debt: 20, money: 100 },
                deckWeights: { 1: 3, 2: 3, 8: 3 },
                rankCriteria: { minGdp: 450, maxInflation: 6, minInflation: 0, maxDebt: 150 },
                title: "æˆé•·ã®é­”è¡“å¸«",
                title_en: "Growth Magician",
                rankCriteria_text: "GDPâ‰¥450T, ã‚¤ãƒ³ãƒ•ãƒ¬0-6%, å‚µå‹™â‰¤150T, æ”¯æŒç‡â‰¥60, AAA",
                rankCriteria_text_en: "GDPâ‰¥450T, Inf 0-6%, Debtâ‰¤150T, Supportâ‰¥60, AAA"
            },
            MMT: {
                id: 'MMT',
                name: 'MMTæ´¾',
                name_en: 'MMT School',
                label: 'ç¾ä»£è²¨å¹£ç†è«–',
                label_en: 'Modern Monetary Theory',
                description: 'ã€Œè‡ªå›½é€šè²¨å»ºã¦ã®å›½å‚µã¯ç ´ç¶»ã—ãªã„ã€ã¨ã—ã€ã‚¤ãƒ³ãƒ•ãƒ¬ã‚’ä¸Šé™ã«ç©æ¥µè²¡æ”¿ã‚’è¡Œã„ã¾ã™ã€‚',
                description_en: 'Spend aggressively, constrained only by inflation, assuming sovereign debt won\'t default.',
                features: ['è²¡æ”¿èµ¤å­—å®¹èª', 'é«˜ã‚¤ãƒ³ãƒ•ãƒ¬è¨±å®¹', 'é›‡ç”¨é‡è¦–'],
                features_en: ['Deficit OK', 'High Inflation OK', 'Job Focus'],
                initialStats: { support: 70, debt: 100, money: 150 },
                deckWeights: { 3: 4, 10: 2, 4: 3 },
                rankCriteria: { minGdp: 500, maxInflation: 8, minInflation: 2, maxDebt: Number.MAX_SAFE_INTEGER, ignoreRating: true },
                title: "è²¡æ”¿ã®è§£æ”¾è€…",
                title_en: "Fiscal Liberator",
                rankCriteria_text: "GDPâ‰¥500T, ã‚¤ãƒ³ãƒ•ãƒ¬2-8%, å‚µå‹™ä¸å•, æ”¯æŒç‡â‰¥60",
                rankCriteria_text_en: "GDPâ‰¥500T, Inf 2-8%, Any Debt, Supportâ‰¥60",
                unlockCondition: (progress) => (progress.monetarist_rank_a_count || 0) >= 3,
                unlockHint: "ãƒãƒã‚¿ãƒªã‚¹ãƒˆã§Aãƒ©ãƒ³ã‚¯ä»¥ä¸Šã‚’3å›ç²å¾—",
                unlockHint_en: "Achieve A Rank 3 times with Monetarist"
            }
        };

        const ACHIEVEMENTS = {
            HIGH_SUPPORT: {
                id: 'HIGH_SUPPORT',
                name: 'åœ§å€’çš„æ”¯æŒ',
                name_en: 'Overwhelming Support',
                description: 'æ”¯æŒç‡90%ä»¥ä¸Šã§ã‚¯ãƒªã‚¢',
                description_en: 'Clear with over 90% support',
                check: (player, isWin) => isWin && player.support >= 90,
                icon: IconStar,
                unlocksCard: 201,
            },
            // Future achievements can be added here
        };

        const ALL_CARDS = [
            {
                id: 201,
                name: 'å›½æ°‘çš†ä¿é™ºåˆ¶åº¦',
                name_en: 'Universal Health Care',
                cost: 50,
                type: 'POLICY',
                supportChange: 15,
                effect: (me, opp) => ({
                    ...me,
                    income: Math.max(0, me.income - 10),
                    activeEffects: [...(me.activeEffects || []), {
                        name: 'å¥åº·å¢—é€²',
                        name_en: 'Health Boost',
                        turnsLeft: 5,
                        effect: (s) => ({ ...s, gdp: s.gdp + 10, support: s.support + 1 })
                    }]
                }),
                description: 'å…¨å›½æ°‘ã«åŒ»ç™‚ä¿é™ºã‚’æä¾›ã—ã¾ã™ã€‚è²¡æ”¿è² æ‹…ã¯å¤§ãã„ã§ã™ãŒã€é•·æœŸçš„ã«è¦‹ã¦å›½æ°‘ã®å¹¸ç¦åº¦ã¨ç”Ÿç”£æ€§ã‚’é«˜ã‚ã¾ã™ã€‚',
                description_en: 'Provide health insurance to all citizens. A heavy fiscal burden, but increases long-term happiness and productivity.',
                tip: 'ã€ç¤¾ä¼šä¿éšœã€‘å……å®Ÿã—ãŸç¤¾ä¼šä¿éšœã¯ã€å›½æ°‘ã®ç”Ÿæ´»æº€è¶³åº¦ã‚’é«˜ã‚ã€å®‰å®šã—ãŸç¤¾ä¼šã®åŸºç›¤ã¨ãªã‚Šã¾ã™ã€‚',
                tip_en: '[Social Security] A robust social security system enhances citizen well-being and forms the foundation of a stable society.',
                requiredAchievement: 'HIGH_SUPPORT',
            },
            {
                id: 1,
                name: 'è¨­å‚™æŠ•è³‡',
                name_en: 'Capital Investment',
                cost: 30,
                type: 'PRODUCTION',
                effect: (me, opp) => ({ ...me, income: me.income + 5, gdp: me.gdp + 10 }),
                description: 'å·¥å ´ã®æ©Ÿæ¢°ãªã©ã‚’è³¼å…¥ã—ã€ç”Ÿç”£èƒ½åŠ›ã‚’é«˜ã‚ã¾ã™ã€‚',
                description_en: 'Purchase factory machinery to increase production capacity.',
                tip: 'ã€æŠ•è³‡ã®ä¹—æ•°åŠ¹æœã€‘æŠ•è³‡ã¯å°†æ¥ã®ç”Ÿç”£åŠ›ã¨æ‰€å¾—ã‚’å¢—ã‚„ã—ã¾ã™ã€‚',
                tip_en: '[Multiplier Effect] Investment increases future production capacity and income.',
                providesTag: 'infrastructure',
                combosWith: ['infrastructure']
            },
            {
                id: 2,
                name: 'æŠ€è¡“é©æ–°',
                name_en: 'Tech Innovation',
                cost: 60,
                type: 'PRODUCTION',
                effect: (me, opp) => ({ ...me, income: me.income + 10, gdp: me.gdp + 30 }),
                description: 'AIã‚„ãƒ­ãƒœãƒƒãƒˆãªã©ã®æ–°æŠ€è¡“ã‚’å°å…¥ã—ã€åŠ¹ç‡ã‚’åŠ‡çš„ã«ä¸Šã’ã¾ã™ã€‚',
                description_en: 'Adopt AI/robots to dramatically increase efficiency.',
                tip: 'ã€ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã€‘æŠ€è¡“é€²æ­©ã¯çµŒæ¸ˆæˆé•·ã®æœ€å¤§ã®è¦å› ã®ä¸€ã¤ã§ã™ã€‚',
                tip_en: '[Innovation] Tech progress is a major growth factor.',
                providesTags: ['innovation', 'tech'],
                combosWith: ['education', 'infrastructure']
            },
            {
                id: 3,
                name: 'å…¬å…±äº‹æ¥­',
                name_en: 'Public Works',
                cost: 40,
                type: 'POLICY',
                inflationChange: 2,
                supportChange: 8,
                effect: (me, opp) => ({
                    ...me,
                    gdp: me.gdp + 40,
                    activeEffects: [...(me.activeEffects || []), {
                        name: 'å…¬å…±äº‹æ¥­ã®ç¶­æŒè²»',
                        name_en: 'Maintenance Cost',
                        turnsLeft: 3,
                        effect: (s) => ({ ...s, income: Math.max(0, s.income - 5) })
                    }]
                }),
                description: 'å¤§è¦æ¨¡ãªã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™ã‚’è¡Œã„ã¾ã™ã€‚GDPã¯å¤§ããä¼¸ã³ã¾ã™ãŒã€å°†æ¥ã®ç¶­æŒè²»ãŒã‹ã•ã¿ã¾ã™ã€‚',
                description_en: 'Large-scale infrastructure. Boosts GDP but increases maintenance costs.',
                tip: 'ã€è²¡æ”¿æ”¿ç­–ã€‘æ”¿åºœæ”¯å‡ºã¯å³åŠ¹æ€§ãŒã‚ã‚Šã¾ã™ãŒã€å°†æ¥ã®è²¡æ”¿ç¡¬ç›´åŒ–ï¼ˆç¶­æŒè²»å¢—å¤§ï¼‰ã‚’æ‹›ããƒªã‚¹ã‚¯ã‚‚ã‚ã‚Šã¾ã™ã€‚',
                tip_en: '[Fiscal Policy] Quick impact, but risks future fiscal rigidity.',
                providesTag: 'infrastructure'
            },
            {
                id: 10,
                name: 'ãƒãƒ”ãƒ¥ãƒªã‚ºãƒ æ”¿ç­–',
                name_en: 'Populist Policy',
                cost: 10,
                type: 'POLICY',
                supportChange: 20,
                inflationChange: 1,
                effect: (me, opp) => ({
                    ...me,
                    gdp: Math.max(0, me.gdp - 15),
                    activeEffects: [...(me.activeEffects || []), {
                        name: 'ãƒãƒ©ãƒã‚­ã®ãƒ„ã‚±',
                        name_en: 'Cost of Populism',
                        turnsLeft: 2,
                        effect: (s) => ({ ...s, inflation: s.inflation + 3 })
                    }]
                }),
                description: 'ç¾é‡‘çµ¦ä»˜ãªã©ã§æ”¯æŒç‡ã‚’çˆ†ä¸Šã’ã—ã¾ã™ãŒã€æˆé•·ã‚’é˜»å®³ã—ã€è¿‘ã„å°†æ¥ã‚¤ãƒ³ãƒ•ãƒ¬ã‚’æ‹›ãã¾ã™ã€‚',
                description_en: 'Cash handouts boost support, but hinder growth and cause inflation.',
                tip: 'ã€ãƒãƒ”ãƒ¥ãƒªã‚ºãƒ ã€‘çŸ­æœŸçš„ãªäººæ°—å–ã‚Šæ”¿ç­–ã¯ã€é•·æœŸçš„ã«ã¯çµŒæ¸ˆã®åŸºç¤çš„æ¡ä»¶ï¼ˆãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ã‚ºï¼‰ã‚’æ‚ªåŒ–ã•ã›ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚',
                tip_en: '[Populism] Short-term popularity often harms long-term fundamentals.'
            },
            {
                id: 11,
                name: 'å¤§è¦æ¨¡æ§‹é€ æ”¹é©',
                name_en: 'Structural Reform',
                cost: 30,
                type: 'POLICY',
                supportChange: -15,
                effect: (me, opp) => ({
                    ...me,
                    activeEffects: [...(me.activeEffects || []), {
                        name: 'æ”¹é©ã®æˆæœ',
                        name_en: 'Reform Success',
                        turnsLeft: 3,
                        effect: (s) => ({ ...s, gdp: s.gdp + 50 })
                    }]
                }),
                description: 'æ—¢å¾—æ¨©ç›Šã‚’æ‰“ç ´ã—ã¾ã™ã€‚å›½æ°‘ã®åç™ºã‚’æ‹›ãã¾ã™ãŒã€æ•°ã‚¿ãƒ¼ãƒ³å¾Œã«å¤§ããªæˆé•·ã‚’ã‚‚ãŸã‚‰ã—ã¾ã™ã€‚',
                description_en: 'Break vested interests. Unpopular now, but brings huge growth later.',
                tip: 'ã€æ§‹é€ æ”¹é©ã€‘è¦åˆ¶ç·©å’Œã‚„å¸‚å ´é–‹æ”¾ã¯ã€çŸ­æœŸçš„ã«ã¯ç—›ã¿ï¼ˆå¤±æ¥­ã‚„åç™ºï¼‰ã‚’ä¼´ã„ã¾ã™ãŒã€é•·æœŸçš„ã«ã¯ç”Ÿç”£æ€§ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚',
                tip_en: '[Structural Reform] Deregulation causes short-term pain but long-term gain.'
            },
            {
                id: 4,
                name: 'é‡‘èç·©å’Œ',
                name_en: 'Monetary Easing',
                cost: 0,
                type: 'POLICY',
                inflationChange: 1.5,
                supportChange: 2,
                effect: (me, opp) => ({ ...me, money: me.money + 40 }),
                description: 'å¸‚å ´ã«ãŠé‡‘ã‚’æµã—è¾¼ã¿ã€ä¸€æ™‚çš„ã«è³‡é‡‘ã‚’æ½¤æ²¢ã«ã—ã¾ã™ã€‚',
                description_en: 'Supply money to the market for liquidity.',
                tip: 'ã€ãƒãƒã‚¿ãƒªãƒ¼ãƒ™ãƒ¼ã‚¹ã€‘é‡‘åˆ©ã‚’ä¸‹ã’ãŸã‚ŠãŠé‡‘ã®ä¾›çµ¦é‡ã‚’å¢—ã‚„ã—ã€æŠ•è³‡ã‚’ä¿ƒã—ã¾ã™ã€‚',
                tip_en: '[Monetary Base] Lowering rates promotes investment.'
            },
            {
                id: 5,
                name: 'å¢—ç¨',
                name_en: 'Tax Hike',
                cost: 0,
                type: 'POLICY',
                inflationChange: -1,
                supportChange: -12,
                baseSuccessRate: 90,
                effect: (me, opp) => ({ ...me, money: me.money + 60, gdp: me.gdp - 10 }),
                description: 'ç¨ç‡ã‚’ä¸Šã’è³‡é‡‘ã‚’ç¢ºä¿ã—ã¾ã™ãŒã€æ™¯æ°—ã¯å°‘ã—å†·ãˆè¾¼ã¿ã¾ã™ã€‚',
                description_en: 'Raise taxes to secure funds, cooling the economy.',
                tip: 'ã€ç·Šç¸®è²¡æ”¿ã€‘è²¡æºç¢ºä¿ã«ã¯æœ‰åŠ¹ã§ã™ãŒã€æ¶ˆè²»ã‚„æŠ•è³‡ã‚’æŠ‘åˆ¶ã™ã‚‹å‰¯ä½œç”¨ãŒã‚ã‚Šã¾ã™ã€‚',
                tip_en: '[Fiscal Austerity] Secures revenue but suppresses consumption.',
                onFailure: (me) => ({ ...me, support: Math.max(0, me.support - 10) })
            },
            {
                id: 6,
                name: 'ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—æ”¯æ´',
                name_en: 'Startup Support',
                cost: 20,
                type: 'PRODUCTION',
                supportChange: 4,
                effect: (me, opp) => ({ ...me, income: me.income + 8 }),
                description: 'èµ·æ¥­å®¶ã‚’æ”¯æ´ã—ã€æ–°ãŸãªãƒ“ã‚¸ãƒã‚¹ã‚’è‚²ã¦ã¾ã™ã€‚',
                description_en: 'Support entrepreneurs to nurture new business.',
                tip: 'ã€æ–°ç”£æ¥­å‰µå‡ºã€‘æ–°ã—ã„ä¼æ¥­ã¯å°†æ¥ã®å¤§ããªç¨åæºã¨ãªã‚Šã¾ã™ã€‚',
                tip_en: '[New Industry] New firms become future tax sources.',
                providesTags: ['tech'],
                combosWith: ['innovation', 'education']
            },
            {
                id: 7,
                name: 'é–¢ç¨å¼•ãä¸Šã’',
                name_en: 'Tariff Hike',
                cost: 15,
                type: 'ATTACK',
                targetSupportChange: -5,
                targetEffect: (opp) => ({ ...opp, income: Math.max(0, opp.income - 5), money: Math.max(0, opp.money - 10) }),
                description: 'è¼¸å…¥å“ã«ç¨é‡‘ã‚’ã‹ã‘ã€ç›¸æ‰‹å›½ã®è¼¸å‡ºç”£æ¥­ã«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã¾ã™ã€‚',
                description_en: 'Tax imports to damage rival export industries.',
                tip: 'ã€ä¿è­·è²¿æ˜“ã€‘è‡ªå›½ç”£æ¥­ã‚’å®ˆã‚‹ä¸€æ–¹ã§ã€è²¿æ˜“æˆ¦äº‰ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚',
                tip_en: '[Protectionism] Protects domestic industry but risks trade war.'
            },
            {
                id: 8,
                name: 'äººæè‚²æˆ',
                name_en: 'Human Capital',
                cost: 25,
                type: 'PRODUCTION',
                supportChange: 5,
                effect: (me, opp) => ({ ...me, income: me.income + 3, gdp: me.gdp + 15 }),
                description: 'æ•™è‚²ã«æŠ•è³‡ã—ã€åŠ´åƒè€…ã®ã‚¹ã‚­ãƒ«ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚',
                description_en: 'Invest in education to improve skills.',
                tip: 'ã€äººçš„è³‡æœ¬ã€‘æ•™è‚²ãƒ¬ãƒ™ãƒ«ã®å‘ä¸Šã¯ã€é•·æœŸçš„ãªçµŒæ¸ˆæˆé•·ã«ä¸å¯æ¬ ã§ã™ã€‚',
                tip_en: '[Human Capital] Education is essential for long-term growth.',
                providesTag: 'education'
            },
            {
                id: 9,
                name: 'å¤§è¦æ¨¡é‡‘èç·©å’Œ',
                name_en: 'Massive Easing',
                cost: 0,
                type: 'POLICY',
                inflationChange: 3,
                supportChange: 5,
                baseSuccessRate: 80,
                effect: (me, opp) => ({ ...me, money: me.money + 100 }),
                description: 'ç•°æ¬¡å…ƒã®é‡‘èç·©å’Œã‚’è¡Œã„ã€å¸‚å ´ã«å¤§é‡ã®è³‡é‡‘ã‚’ä¾›çµ¦ã—ã¾ã™ã€‚',
                description_en: 'Unprecedented easing. High risk of losing market confidence.',
                tip: 'ã€ãƒªã‚¹ã‚¯ã€‘å¤±æ•—ã™ã‚‹ã¨å¸‚å ´ã®ä¿¡èªã‚’å¤±ã„ã€æ”¯æŒç‡ãŒæ€¥è½ã—ã¾ã™ã€‚',
                tip_en: '[Risk] Failure crashes support rate.',
                onFailure: (me) => ({ ...me, support: Math.max(0, me.support - 20) })
            },
            // --- Mission Reward Cards ---
            {
                id: 101,
                name: 'ç·Šæ€¥åˆ©ä¸‹ã’',
                name_en: 'Emergency Rate Cut',
                cost: 0,
                type: 'POLICY',
                effect: (me, opp) => ({ ...me, inflation: Math.max(-2, me.inflation - 3), gdp: me.gdp + 20 }),
                description: 'ã€ãƒŸãƒƒã‚·ãƒ§ãƒ³å ±é…¬ã€‘é‡‘èæ”¿ç­–ã‚’ç·å‹•å“¡ã—ã€ã‚¤ãƒ³ãƒ•ãƒ¬ã‚’å¼·åŠ›ã«æŠ‘åˆ¶ã—ã¤ã¤æ™¯æ°—ã‚’åˆºæ¿€ã—ã¾ã™ã€‚',
                description_en: '[Mission Reward] Mobilize monetary policy to strongly curb inflation while stimulating the economy.',
                tip: 'ã€éä¼çµ±çš„é‡‘èæ”¿ç­–ã€‘å±æ©Ÿå¯¾å¿œæ™‚ã«ã¯ã€é€šå¸¸ã®æ”¿ç­–ã®æ ã‚’è¶…ãˆãŸå¤§èƒ†ãªæªç½®ãŒå–ã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚',
                tip_en: '[Unconventional Monetary Policy] In a crisis, bold measures beyond normal policy may be taken.',
            },
            {
                id: 102,
                name: 'å›½å‚µè²·ã„ã‚ªãƒš',
                name_en: 'QE Operation',
                cost: 0,
                type: 'POLICY',
                effect: (me, opp) => ({ ...me, debt: Math.max(0, me.debt - 50), money: me.money + 50, inflation: clampInflation(me.inflation + 1) }),
                description: 'ã€ãƒŸãƒƒã‚·ãƒ§ãƒ³å ±é…¬ã€‘ä¸­å¤®éŠ€è¡ŒãŒå›½å‚µã‚’è²·ã„å–ã‚Šã€æ”¿åºœå‚µå‹™ã‚’åœ§ç¸®ã—ã¤ã¤å¸‚å ´ã«è³‡é‡‘ã‚’ä¾›çµ¦ã—ã¾ã™ã€‚',
                description_en: '[Mission Reward] The central bank buys government bonds, reducing debt while supplying funds to the market.',
                tip: 'ã€é‡çš„ç·©å’Œã€‘å¸‚å ´ã«è³‡é‡‘ã‚’ä¾›çµ¦ã™ã‚‹ã“ã¨ã§é‡‘åˆ©ã‚’ä¸‹ã’ã€çµŒæ¸ˆã‚’æ´»æ€§åŒ–ã•ã›ã‚‹åŠ¹æœãŒæœŸå¾…ã•ã‚Œã¾ã™ãŒã€ã‚¤ãƒ³ãƒ•ãƒ¬åœ§åŠ›ã‚‚ç”Ÿã¿ã¾ã™ã€‚',
                tip_en: '[Quantitative Easing] Expected to lower interest rates and stimulate the economy, but also creates inflationary pressure.',
            },
            {
                id: 999,
                name: 'ãƒ˜ãƒªã‚³ãƒ—ã‚¿ãƒ¼ãƒãƒãƒ¼',
                name_en: 'Helicopter Money',
                cost: 0,
                type: 'POLICY',
                inflationChange: 5,
                supportChange: 10,
                effect: (me, opp) => ({ ...me, money: me.money + 200 }),
                description: 'å›½æ°‘ã«ç›´æ¥ç¾é‡‘ã‚’é…ã‚Šã¾ã™ã€‚è¶…å¼·åŠ›ãªæ™¯æ°—åˆºæ¿€ç­–ã§ã™ãŒã€æ¿€ã—ã„ã‚¤ãƒ³ãƒ•ãƒ¬ã‚’æ‹›ãã¾ã™ã€‚',
                description_en: 'Direct cash handout. Huge stimulus, but causes severe inflation.',
                tip: 'ã€ç¦ã˜æ‰‹ã€‘ä¸­å¤®éŠ€è¡ŒãŒç´™å¹£ã‚’åˆ·ã£ã¦ã°ã‚‰æ’’ãæ”¿ç­–ã€‚ãƒã‚¤ãƒ‘ãƒ¼ã‚¤ãƒ³ãƒ•ãƒ¬ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚',
                tip_en: '[Last Resort] Printing money to distribute. Risks hyperinflation.',
                unlockCondition: (progress) => (progress.total_inflation_combos || 0) >= 10,
                unlockHint: "ã‚¤ãƒ³ãƒ•ãƒ¬ã‚³ãƒ³ãƒœï¼ˆã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒœï¼‰ã‚’ç´¯è¨ˆ10å›è¡Œã†",
                unlockHint_en: "Perform 10 Inflation Combos total"
            }
        ];

        const MISSIONS = [
            {
                id: 'INFLATION_CRISIS',
                name: 'ã‚¤ãƒ³ãƒ•ãƒ¬å±æ©Ÿ',
                name_en: 'Inflation Crisis',
                trigger: (player) => player.inflation >= 5 && player.inflation < 8,
                objective: (player) => player.inflation < 5,
                objective_text: '3ã‚¿ãƒ¼ãƒ³ä»¥å†…ã«ã‚¤ãƒ³ãƒ•ãƒ¬ã‚’ 5% æœªæº€ã«ã›ã‚ˆ',
                objective_text_en: 'Reduce inflation below 5% within 3 turns',
                turns: 3,
                rewardCardId: 101,
            },
            {
                id: 'DEBT_SPIRAL',
                name: 'å‚µå‹™ã‚¹ãƒ‘ã‚¤ãƒ©ãƒ«æ‡¸å¿µ',
                name_en: 'Debt Spiral Risk',
                trigger: (player) => player.debt >= 150 && player.debt < 250,
                objective: (player) => player.debt < 150,
                objective_text: '3ã‚¿ãƒ¼ãƒ³ä»¥å†…ã«å‚µå‹™ã‚’ 150å…† ä»¥ä¸‹ã«æˆ»ã›',
                objective_text_en: 'Reduce debt below 150T within 3 turns',
                turns: 3,
                rewardCardId: 102,
            }
        ];

        const DIFFICULTY_SETTINGS = {
            BEGINNER: {
                id: 'BEGINNER',
                label: 'ãƒ“ã‚®ãƒŠãƒ¼',
                label_en: 'Beginner',
                targetGdp: 200,
                initialMoney: 120,
                initialDebt: 0,
                eventDamageMultiplier: 0.5,
                description: 'å‹åˆ©æ¡ä»¶GDPãŒä½ãã€åˆæœŸè³‡é‡‘ãŒå¤šã„ã€‚ã‚¤ãƒ™ãƒ³ãƒˆã®æ‚ªå½±éŸ¿ã‚‚åŠæ¸›ã—ã¾ã™ã€‚',
                description_en: 'Low target GDP, high initial funds. Event damage halved.'
            },
            NORMAL: {
                id: 'NORMAL',
                label: 'ãƒãƒ¼ãƒãƒ«',
                label_en: 'Normal',
                targetGdp: 300,
                initialMoney: 80,
                initialDebt: 0,
                eventDamageMultiplier: 1.0,
                description: 'æ¨™æº–çš„ãªãƒãƒ©ãƒ³ã‚¹ã§ã™ã€‚',
                description_en: 'Standard balance.'
            },
            HARD: {
                id: 'HARD',
                label: 'ãƒãƒ¼ãƒ‰',
                label_en: 'Hard',
                targetGdp: 400,
                initialMoney: 60,
                initialDebt: 30,
                eventDamageMultiplier: 1.5,
                description: 'ç›®æ¨™GDPãŒé«˜ãã€åˆæœŸå‚µå‹™ã‚’æŠ±ãˆãŸçŠ¶æ…‹ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã€‚ã‚¤ãƒ™ãƒ³ãƒˆã®æ‚ªå½±éŸ¿ã‚‚å¼·ã¾ã‚Šã¾ã™ã€‚',
                description_en: 'High target GDP, start with debt. Stronger event damage.'
            }
        };

        const INFLATION_MIN = -5;
        const INFLATION_MAX = 15;

        const RATING_TIERS = [
            { label: 'AAA', threshold: 0, interestMultiplier: 1, eventDamageMultiplier: 1 },
            { label: 'BBB', threshold: 150, interestMultiplier: 1.25, eventDamageMultiplier: 1.1 },
            { label: 'CCC', threshold: 250, interestMultiplier: 1.6, eventDamageMultiplier: 1.25 },
            { label: 'D', threshold: 400, interestMultiplier: 2, eventDamageMultiplier: 1.5 },
        ];

        const getRatingByDebt = (debt = 0) => {
            const sorted = [...RATING_TIERS].sort((a, b) => b.threshold - a.threshold);
            const found = sorted.find(tier => debt >= tier.threshold);
            return found?.label ?? 'AAA';
        };

        const getRatingInfo = (rating = 'AAA') => RATING_TIERS.find(tier => tier.label === rating) ?? RATING_TIERS[0];

        const clampInflation = (value) => Math.min(INFLATION_MAX, Math.max(INFLATION_MIN, Number(value.toFixed(1))));

        // AI Logic Constants
        const MAX_STANDARD_CARD_ID = 100; // AI only plays cards with ID < 100

        const applyInflationDrift = (value, target = 0) => {
            const diff = target - value;
            const step = 0.3;
            if (Math.abs(diff) < step) return target;
            return clampInflation(value + (diff > 0 ? step : -step));
        };

        const applyInflationChange = (state, delta = 0) => {
            if (!delta) return state;
            return { ...state, inflation: clampInflation((state.inflation ?? 0) + delta) };
        };

        const calculateInflatedCost = (baseCost, inflationRate = 0) => {
            return Math.max(0, Math.round(baseCost * (1 + inflationRate / 100)));
        };

        const calculateSuccessRate = (card, support) => {
            const base = card.baseSuccessRate ?? 100;
            if (base >= 100) return 100;
            // Bonus: (Support - 50) * 0.5. Support 70 -> +10%. Support 30 -> -10%.
            const bonus = (support - 50) * 0.5;
            return Math.min(100, Math.max(0, Math.round(base + bonus)));
        };

        const evaluateGame = (player, difficulty, isWin, ideology = null, lang = 'ja', completedMissionCount = 0) => {
            // 1. Basic Stats
            const gdp = player.gdp;
            const inflation = player.inflation;
            const debt = player.debt;
            const support = player.support;
            const rating = player.rating;

            // 2. Comments
            let comments = [];
            let nextGoals = [];

            // Ideology Rank Criteria (Defaults to Standard/Keynesian if null)
            const criteria = ideology?.rankCriteria || { minGdp: 400, maxInflation: 4, minInflation: 2, maxDebt: 100 };

            // Inflation Eval
            let inflationEval = lang === 'en' ? "Optimal" : "é©æ­£";
            if (inflation < 0) {
                inflationEval = lang === 'en' ? "Deflationary" : "ãƒ‡ãƒ•ãƒ¬æ°—å‘³";
                comments.push(lang === 'en' ? "Need to escape deflation" : "ãƒ‡ãƒ•ãƒ¬è„±å´ãŒå¿…è¦ã§ã™");
            }
            else if (inflation < criteria.minInflation) { inflationEval = lang === 'en' ? "Low" : "ã‚„ã‚„ä½ã„"; }
            else if (inflation <= criteria.maxInflation) { inflationEval = lang === 'en' ? "Ideal" : "ç†æƒ³çš„"; }
            else if (inflation <= 8) { inflationEval = lang === 'en' ? "High" : "ã‚„ã‚„é«˜ã„"; }
            else {
                inflationEval = lang === 'en' ? "Dangerous" : "å±é™ºæ°´åŸŸ";
                comments.push(lang === 'en' ? "Control inflation immediately" : "ã‚¤ãƒ³ãƒ•ãƒ¬æŠ‘åˆ¶ã‚’æœ€å„ªå…ˆã«");
            }

            // Rank Logic
            let rank = 'C';
            let rankColor = 'text-slate-400';
            let rankLabel = 'NORMAL';

            if (!isWin) {
                rank = 'E';
                rankLabel = 'FAILED';
                rankColor = 'text-gray-500';
                nextGoals.push(lang === 'en' ? "Try to clear the game first!" : "ã¾ãšã¯ã‚¯ãƒªã‚¢ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼");
            } else {
                // Check S (Ideology Specific)
                // Default S: GDP 400, Inf 2-4, Debt 100, AAA, Support 60
                const isS = gdp >= criteria.minGdp
                            && (inflation >= criteria.minInflation && inflation <= criteria.maxInflation)
                            && debt <= criteria.maxDebt
                            && (criteria.ignoreRating || rating === 'AAA')
                            && support >= 60;

                // Check A (Relaxed S)
                const isA = gdp >= (criteria.minGdp * 0.75)
                            && (inflation >= (criteria.minInflation - 2) && inflation <= (criteria.maxInflation + 2))
                            && debt <= (criteria.maxDebt + 100)
                            && (criteria.ignoreRating || rating === 'AAA' || rating === 'BBB')
                            && support >= 50;

                // Monetarist Bonus: If inflation is perfectly managed, boost rank
                const bonusAchieved = ideology?.bonusCondition && ideology.bonusCondition(player);
                const effectiveRank = isS ? 'S' : (isA ? 'A' : 'B');

                // Mission Bonus: 1+ completed missions can boost an A rank to S
                const missionBonus = completedMissionCount > 0;

                if (isS || (isA && bonusAchieved && effectiveRank !== 'S') || (isA && missionBonus)) {
                    rank = 'S';
                    rankLabel = 'LEGENDARY';
                    rankColor = 'text-yellow-400 drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]';
                    if(missionBonus && !isS) {
                        nextGoals.unshift(lang === 'en' ? "Crisis Averted! A rank promoted to S." : "å±æ©Ÿå›é¿ãƒœãƒ¼ãƒŠã‚¹ã§Aãƒ©ãƒ³ã‚¯ã‹ã‚‰æ˜‡æ ¼ï¼");
                    }
                    if(bonusAchieved) nextGoals.push(lang === 'en' ? "Bonus Goal (Inflation Control) Achieved!" : "ãƒœãƒ¼ãƒŠã‚¹ç›®æ¨™ï¼ˆã‚¤ãƒ³ãƒ•ãƒ¬æŠ‘åˆ¶ï¼‰ã‚‚é”æˆï¼");
                    nextGoals.push(lang === 'en' ? "Perfect Management! No higher title exists." : "å®Œç’§ãªæ‰‹è…•ã§ã™ï¼ã“ã‚Œä»¥ä¸Šã®ç§°å·ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
                } else if (isA) {
                    rank = 'A';
                    rankLabel = 'EXCELLENT';
                    rankColor = 'text-emerald-400';
                    // Advice for S
                    if (gdp < criteria.minGdp) nextGoals.push(lang === 'en' ? `Aim for GDP ${criteria.minGdp}T next` : `æ¬¡ã¯GDP ${criteria.minGdp}å…†å††ã‚’ç›®æŒ‡ãã†`);
                    if (inflation < criteria.minInflation || inflation > criteria.maxInflation) nextGoals.push(lang === 'en' ? `Keep Inflation ${criteria.minInflation}-${criteria.maxInflation}%` : `ã‚¤ãƒ³ãƒ•ãƒ¬ç‡ ${criteria.minInflation}-${criteria.maxInflation}% ã‚’ç›®æŒ‡ãã†`);
                    if (debt > criteria.maxDebt) nextGoals.push(lang === 'en' ? `Keep Debt under ${criteria.maxDebt}T` : `å‚µå‹™ ${criteria.maxDebt}å…†å††ä»¥ä¸‹ã®å¥å…¨è²¡æ”¿ã‚’ç›®æŒ‡ãã†`);
                    if (completedMissionCount === 0) nextGoals.push(lang === 'en' ? "Complete a mission for a rank bonus!" : "ãƒŸãƒƒã‚·ãƒ§ãƒ³é”æˆã§ãƒ©ãƒ³ã‚¯ãƒœãƒ¼ãƒŠã‚¹ï¼");
                } else {
                    rank = 'B';
                    rankLabel = 'GOOD';
                    rankColor = 'text-cyan-400';
                     // Advice for A
                    if (inflation > 6) nextGoals.push(lang === 'en' ? "Keep Inflation under 5% for Rank A" : "ã‚¤ãƒ³ãƒ•ãƒ¬ã‚’ 5%ä»¥ä¸‹ ã«æŠ‘ãˆã¦Aãƒ©ãƒ³ã‚¯ã‚’ç›®æŒ‡ãã†");
                    if (debt > 200) nextGoals.push(lang === 'en' ? "Reduce Debt to maintain Rating" : "å‚µå‹™ã‚’æ¸›ã‚‰ã—ã¦æ ¼ä»˜ã‘ã‚’ç¶­æŒã—ã‚ˆã†");
                    if (support < 50) nextGoals.push(lang === 'en' ? "Keep Support above 50%" : "æ”¯æŒç‡ 50%ä»¥ä¸Š ã‚’ã‚­ãƒ¼ãƒ—ã—ã‚ˆã†");
                }
            }

            // Default advice if empty
            if (nextGoals.length === 0) nextGoals.push(lang === 'en' ? "Aim for even greater heights..." : "ã•ã‚‰ãªã‚‹é«˜ã¿ã‚’ç›®æŒ‡ã—ã¦...");

            return {
                rank,
                rankLabel,
                rankColor,
                stats: [
                    { label: lang === 'en' ? 'Final GDP' : 'æœ€çµ‚GDP', value: `${gdp}${t('trillion', lang)}`, note: gdp >= 400 ? (lang === 'en' ? 'S Rank' : 'SåŸºæº–é”æˆ') : '' },
                    { label: lang === 'en' ? 'Inflation' : 'ã‚¤ãƒ³ãƒ•ãƒ¬ç‡', value: `${inflation.toFixed(1)}%`, note: inflationEval },
                    { label: lang === 'en' ? 'Debt' : 'å‚µå‹™æ®‹é«˜', value: `${debt}${t('trillion', lang)}`, note: `${lang === 'en' ? 'Rating' : 'æ ¼ä»˜'}:${rating}` },
                    { label: lang === 'en' ? 'Support' : 'æ”¯æŒç‡', value: `${support}%`, note: support >= 60 ? (lang === 'en' ? 'High' : 'é«˜æ”¯æŒ') : '' },
                ],
                nextGoal: nextGoals[0]
            };
        };

        // --- Visual Components ---

        const ComboOverlay = ({ message, show }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center pointer-events-none animate-fade-in">
                    <div
                        // The key forces a re-render and re-animation when the message changes
                        key={message}
                        className="text-5xl md:text-7xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-amber-600 drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)] animate-pop-in"
                        style={{ textStroke: '1px rgba(0,0,0,0.3)', WebkitTextStroke: '1px rgba(0,0,0,0.3)' }}
                    >
                        {message}
                    </div>
                </div>
            );
        };

        const NumberCounter = ({ value, duration = 1000 }) => {
            const [displayValue, setDisplayValue] = useState(value);

            useEffect(() => {
                let startTime;
                let animationFrameId;
                const startValue = displayValue;
                const endValue = value;

                if (startValue === endValue) return;

                const animate = (currentTime) => {
                    if (!startTime) startTime = currentTime;
                    const progress = Math.min((currentTime - startTime) / duration, 1);
                    // Ease out quart
                    const ease = 1 - Math.pow(1 - progress, 4);

                    const current = Math.floor(startValue + (endValue - startValue) * ease);
                    setDisplayValue(current);

                    if (progress < 1) {
                        animationFrameId = requestAnimationFrame(animate);
                    }
                };
                animationFrameId = requestAnimationFrame(animate);

                return () => cancelAnimationFrame(animationFrameId);
            }, [value]);

            return <span>{displayValue}</span>;
        };

        const TurnOverlay = ({ turn, show }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center pointer-events-none">
                    <div className="bg-slate-900/90 text-cyan-400 text-6xl font-black px-12 py-6 rounded-2xl border-4 border-cyan-500 shadow-[0_0_50px_rgba(6,182,212,0.5)] animate-pop-in">
                        TURN {turn}
                    </div>
                </div>
            );
        };

        const CrisisOverlay = ({ message, show, type = 'danger' }) => {
             if (!show) return null;
             const color = type === 'danger' ? 'text-red-500 border-red-600 bg-red-950/90' : 'text-amber-500 border-amber-600 bg-amber-950/90';

             return (
                <div className="fixed inset-0 z-[110] flex items-center justify-center pointer-events-none">
                    <div className="absolute inset-0 animate-flash-red"></div>
                    <div className={`px-12 py-8 rounded-xl border-4 shadow-2xl animate-pop-in flex flex-col items-center ${color}`}>
                         <IconAlertCircle size={64} className="mb-4 animate-bounce" />
                         <h2 className="text-5xl font-black tracking-tighter uppercase mb-2 text-center whitespace-pre-wrap">{message}</h2>
                         <p className="text-xl font-bold opacity-80 uppercase tracking-widest">EMERGENCY ALERT</p>
                    </div>
                </div>
             );
        };

        const TurnSummaryPanel = ({ data, onContinue, lang }) => {
            if (!data) return null;

            return (
                <div className="fixed inset-0 z-[100] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-slate-800 border-2 border-slate-700 p-8 rounded-2xl shadow-2xl max-w-md w-full text-center relative overflow-hidden animate-pop-in">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 to-purple-500"></div>

                        <h2 className="text-2xl font-black text-white mb-6 tracking-tighter">{t('turnSummary', lang).toUpperCase()} {data.turn}</h2>

                        {/* Highlight Section */}
                        <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700/50 mb-6 text-left">
                             <div className="flex items-center gap-2 mb-3">
                                <IconTrendingUp size={16} className="text-yellow-400" />
                                <span className="text-xs font-bold text-yellow-300 uppercase tracking-wider">{t('highlight', lang)}</span>
                            </div>
                            <p className="text-lg text-slate-200 leading-relaxed font-medium">
                                {data.highlight}
                            </p>
                        </div>

                        {/* Warning Section */}
                        <div className="bg-rose-900/20 border border-rose-500/30 rounded-xl p-4 mb-8 text-left">
                            <div className="flex items-center gap-2 mb-3">
                                <IconAlertCircle size={16} className="text-rose-400" />
                                <span className="text-xs font-bold text-rose-300 uppercase tracking-wider">{t('outlook', lang)}</span>
                            </div>
                            <ul className="text-sm text-rose-100 leading-relaxed font-medium list-disc list-inside space-y-1">
                                {data.warnings.map((warning, i) => (
                                    <li key={i}>{warning}</li>
                                ))}
                            </ul>
                        </div>

                        <button
                            onClick={onContinue}
                            className="w-full py-3 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-xl font-bold text-base shadow-lg shadow-cyan-900/20 hover:scale-105 transition-transform active:scale-95 flex items-center justify-center gap-2"
                        >
                            {t('continue', lang)} <IconArrowRight size={18} />
                        </button>
                    </div>
                </div>
            );
        };

        const Confetti = () => {
            const particles = Array.from({ length: 50 }).map((_, i) => ({
                id: i,
                left: Math.random() * 100 + '%',
                animationDelay: Math.random() * 2 + 's',
                bg: ['#06b6d4', '#ec4899', '#eab308'][Math.floor(Math.random() * 3)]
            }));

            return (
                <div className="fixed inset-0 pointer-events-none z-[60] overflow-hidden">
                    {particles.map(p => (
                        <div
                            key={p.id}
                            style={{
                                position: 'absolute',
                                top: '-10px',
                                left: p.left,
                                width: '10px',
                                height: '10px',
                                backgroundColor: p.bg,
                                animation: `fall ${2 + Math.random() * 3}s linear infinite`,
                                animationDelay: p.animationDelay
                            }}
                        />
                    ))}
                    <style>{`
                        @keyframes fall {
                            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
                            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
                        }
                    `}</style>
                </div>
            );
        };

        const CardInfoPanel = ({ card, lang }) => {
            if (!card) {
                return (
                     <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 flex flex-col items-center justify-center text-center h-48 animate-fade-in hidden lg:flex">
                        <div className="p-3 rounded-full bg-slate-800 mb-3 opacity-50">
                            <IconBookOpen size={24} className="text-slate-400" />
                        </div>
                        <h3 className="text-sm font-bold text-slate-500 mb-1">{t('cardInfo', lang)}</h3>
                        <p className="text-xs text-slate-600" dangerouslySetInnerHTML={{ __html: t('cardInfoDesc', lang)}}></p>
                     </div>
                );
            }

            const typeInfo = CARD_TYPES[card.type];

            return (
                <div className="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden animate-fade-in shadow-lg">
                    {/* Header */}
                    <div className={`px-4 py-3 border-b border-slate-800 flex items-center gap-2 ${typeInfo?.headerStyle?.replace('bg-', 'bg-opacity-20 bg-')}`}>
                         {typeInfo?.icon}
                         <span className="font-bold text-sm tracking-wider">{getLoc(card, 'name', lang)}</span>
                    </div>

                    <div className="p-4 space-y-4">
                        {/* Tip Section */}
                        <div className="bg-indigo-950/30 border border-indigo-900/50 rounded-xl p-3 relative overflow-hidden">
                             <div className="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                             <div className="flex items-start gap-2 mb-1">
                                 <IconBookOpen size={14} className="text-indigo-400 mt-0.5" />
                                 <span className="text-xs font-bold text-indigo-300">{t('memo', lang)}</span>
                             </div>
                             <p className="text-xs text-slate-300 leading-relaxed pl-1">
                                {getLoc(card, 'tip', lang)}
                             </p>
                        </div>

                        {/* Description */}
                        <div>
                            <div className="text-[10px] font-bold text-slate-500 uppercase mb-1">{t('detail', lang)}</div>
                            <p className="text-xs text-slate-400 leading-relaxed">
                                {getLoc(card, 'description', lang)}
                            </p>
                        </div>

                        {/* Tags */}
                        {(card.providesTags || card.providesTag) && (
                            <div className="flex flex-wrap gap-1 pt-2 border-t border-slate-800/50">
                                {[].concat(card.providesTags || [], card.providesTag || []).filter(Boolean).map(tag => (
                                    <span key={tag} className="text-[10px] px-2 py-1 rounded bg-slate-800 text-slate-500 font-mono">
                                        #{tag}
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ComboGuidePanel = ({ lang }) => {
            const combos = [
                {
                    tag: 'infrastructure',
                    label: t('tagInfra', lang),
                    desc: t('tagInfraDesc', lang),
                    color: 'text-amber-400 bg-amber-900/20 border-amber-500/30'
                },
                {
                    tag: 'education',
                    label: t('tagEdu', lang),
                    desc: t('tagEduDesc', lang),
                    color: 'text-emerald-400 bg-emerald-900/20 border-emerald-500/30'
                },
                {
                    tag: 'innovation',
                    label: t('tagInno', lang),
                    desc: t('tagInnoDesc', lang),
                    color: 'text-cyan-400 bg-cyan-900/20 border-cyan-500/30'
                },
                {
                    tag: 'tech',
                    label: t('tagTech', lang),
                    desc: t('tagTechDesc', lang),
                    color: 'text-purple-400 bg-purple-900/20 border-purple-500/30'
                }
            ];

            return (
                <div className="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-lg mt-6">
                    <div className="bg-slate-800/50 p-3 border-b border-slate-800 flex items-center gap-2">
                         <IconZap size={14} className="text-yellow-400" />
                         <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">{t('comboGuide', lang)}</span>
                    </div>
                    <div className="p-4 space-y-2">
                        {combos.map(c => (
                            <div key={c.tag} className={`p-2 rounded-lg border ${c.color} flex flex-col gap-1`}>
                                <div className="flex items-center gap-2">
                                    <span className="text-[9px] font-black uppercase px-1.5 py-0.5 rounded bg-black/20 tracking-wider">#{c.tag}</span>
                                    <IconArrowRight size={10} className="opacity-50" />
                                    <span className="text-xs font-bold opacity-90">{c.label}</span>
                                </div>
                                <p className="text-[10px] opacity-80 leading-relaxed pl-1">{c.desc}</p>
                            </div>
                        ))}
                         <div className="mt-2 pt-2 border-t border-slate-800/50 text-[10px] text-slate-500 text-center leading-tight">
                            <span className="text-amber-400 font-bold">{t('comboHint', lang)}</span><br/>
                            <span dangerouslySetInnerHTML={{ __html: t('comboHintDesc', lang) }}></span>
                        </div>
                    </div>
                </div>
            );
        };

        const IdeologyMissionPanel = ({ ideology, lang }) => {
            if (!ideology) return null;

            return (
                <div className="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-lg">
                    <div className="bg-slate-800/50 p-3 border-b border-slate-800 flex items-center gap-2">
                        <IconAward size={14} className="text-yellow-400" />
                        <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">{t('ideologyMission', lang)}</span>
                    </div>
                    <div className="p-4 space-y-2">
                        <p className="text-xs text-slate-400 pb-2 border-b border-slate-800">{getLoc(ideology, 'name', lang)}</p>
                        <p className="text-sm text-amber-300 bg-amber-900/20 p-2 rounded-md border border-amber-500/20 font-mono text-center tracking-tighter">
                            {getLoc(ideology, 'rankCriteria_text', lang)}
                        </p>
                    </div>
                </div>
            );
        };

        const MissionPanel = ({ activeMission, lang }) => {
            if (!activeMission) return null;

            const mission = MISSIONS.find(m => m.id === activeMission.missionId);
            if (!mission) return null;

            return (
                <div className="bg-purple-950/30 border-2 border-purple-700/50 rounded-2xl overflow-hidden shadow-lg animate-fade-in ring-4 ring-purple-500/30">
                    <div className="bg-purple-900/30 p-3 border-b border-purple-800/50 flex justify-between items-center">
                        <h3 className="text-xs font-bold text-purple-300 uppercase tracking-wider flex items-center gap-2">
                            <IconAlertCircle size={12} /> MISSION
                        </h3>
                        <span className="text-[10px] font-mono text-purple-400">ACTIVE</span>
                    </div>

                    <div className="p-4 space-y-3">
                        <h4 className="text-sm font-bold text-purple-200">{getLoc(mission, 'name', lang)}</h4>
                        <p className="text-xs text-purple-300/80 bg-black/20 p-2 rounded-md border border-purple-900">
                            {getLoc(mission, 'objective_text', lang)}
                        </p>
                        <div className="flex justify-end">
                             <div className="text-sm font-bold bg-slate-900/50 border border-slate-700 px-3 py-1 rounded-lg text-amber-400">
                                 {lang === 'en' ? 'Turns Left:' : 'æ®‹ã‚Š'}: <span className="text-xl">{activeMission.turnsLeft}</span>
                             </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CardEncyclopediaPanel = ({ onClose, lang, discoveredCards }) => {
            const [selectedCard, setSelectedCard] = useState(null);

            const totalCards = ALL_CARDS.length;
            const unlockedCount = Object.keys(discoveredCards).length;
            const progress = Math.round((unlockedCount / totalCards) * 100);

            return (
                <div className="fixed inset-0 z-[120] bg-slate-900/95 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-slate-800 border border-slate-700 w-full max-w-5xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden relative">
                         {/* Header */}
                         <div className="bg-slate-900/50 p-4 border-b border-slate-700 flex justify-between items-center">
                             <div className="flex items-center gap-3">
                                 <div className="p-2 bg-cyan-950 rounded-lg">
                                     <IconBookOpen size={24} className="text-cyan-400" />
                                 </div>
                                 <div>
                                     <h2 className="text-xl font-black text-white tracking-tighter">{t('encyclopedia', lang)}</h2>
                                     <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">
                                         {t('collectionProgress', lang)}: <span className="text-cyan-400">{unlockedCount}</span> / {totalCards} ({progress}%)
                                     </p>
                                 </div>
                             </div>
                             <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-full transition-colors text-slate-400 hover:text-white">
                                 <IconX size={24} />
                             </button>
                         </div>

                         <div className="flex flex-1 overflow-hidden">
                             {/* Grid */}
                             <div className="flex-1 overflow-y-auto p-6 scrollbar-thin scrollbar-thumb-slate-700">
                                 <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3">
                                     {ALL_CARDS.map(card => {
                                         const isUnlocked = discoveredCards[card.id];
                                         const typeInfo = CARD_TYPES[card.type];

                                         if (!isUnlocked) {
                                             return (
                                                 <div key={card.id} className="aspect-[3/4] bg-slate-900 border-2 border-slate-800 border-dashed rounded-xl flex flex-col items-center justify-center opacity-50 group relative cursor-help">
                                                     <span className="text-2xl font-black text-slate-700">?</span>
                                                     <span className="text-[10px] text-slate-600 mt-2 font-bold">{t('unknown', lang)}</span>
                                                     <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-xl">
                                                         <span className="text-[10px] text-white font-bold px-2 text-center">
                                                            {getLoc(card, 'unlockHint', lang) || t('playToUnlock', lang)}
                                                         </span>
                                                     </div>
                                                 </div>
                                             );
                                         }

                                         return (
                                             <button
                                                key={card.id}
                                                onClick={() => setSelectedCard(card)}
                                                className={`aspect-[3/4] relative rounded-xl border-2 transition-all hover:scale-105 active:scale-95 flex flex-col text-left overflow-hidden group ${selectedCard?.id === card.id ? 'ring-2 ring-cyan-400 border-cyan-500 shadow-lg shadow-cyan-900/50' : 'border-slate-700 bg-slate-800 hover:border-slate-500'}`}
                                             >
                                                 <div className={`px-2 py-1.5 flex items-center gap-1 ${typeInfo.headerStyle}`}>
                                                     {typeInfo.icon}
                                                     <span className="text-[8px] font-black uppercase truncate">{typeInfo.label}</span>
                                                 </div>
                                                 <div className="p-2 flex-1 flex flex-col bg-slate-900/40">
                                                     <div className="text-[10px] font-bold text-slate-200 leading-tight mb-1 line-clamp-2">{getLoc(card, 'name', lang)}</div>
                                                     <div className="mt-auto text-[10px] font-mono text-slate-500 flex justify-between items-end w-full">
                                                         <span>No.{card.id}</span>
                                                         {card.tip && <IconBookOpen size={10} className="text-slate-600" />}
                                                     </div>
                                                 </div>
                                             </button>
                                         );
                                     })}
                                 </div>
                             </div>

                             {/* Detail Pane (Right Side - Desktop) */}
                             {selectedCard && (
                                 <div className="w-80 bg-slate-900 border-l border-slate-700 p-6 overflow-y-auto hidden md:block animate-slide-in-right shrink-0">
                                     <h3 className="text-sm font-bold text-slate-500 uppercase mb-4 tracking-wider">{t('cardDetail', lang)}</h3>
                                     <div className="mb-6 transform scale-100 origin-top-left">
                                          <div className={`
                                                relative flex flex-col min-h-[16rem] rounded-xl border-2 overflow-hidden shadow-2xl
                                                ${CARD_TYPES[selectedCard.type].baseStyle}
                                            `}>
                                                <div className={`px-4 py-3 flex justify-between items-center ${CARD_TYPES[selectedCard.type].headerStyle}`}>
                                                    <span className="text-[10px] font-black uppercase tracking-wider flex items-center gap-1">
                                                        {CARD_TYPES[selectedCard.type].icon} {CARD_TYPES[selectedCard.type].label}
                                                    </span>
                                                    <span className="font-mono text-lg font-black tracking-tighter">Â¥{selectedCard.cost}</span>
                                                </div>
                                                <div className="p-4 flex flex-col flex-grow bg-slate-900/40 backdrop-blur-sm">
                                                    <h4 className="font-bold text-slate-200 text-sm mb-2 leading-snug">{getLoc(selectedCard, 'name', lang)}</h4>
                                                    <p className="text-xs text-slate-300 leading-relaxed opacity-90">{getLoc(selectedCard, 'description', lang)}</p>
                                                </div>
                                          </div>
                                     </div>

                                     <div className="space-y-4">
                                         {selectedCard.tip && (
                                            <div className="bg-slate-800 p-3 rounded-xl border border-slate-700">
                                                <div className="text-[10px] font-bold text-slate-500 uppercase mb-1 flex items-center gap-1">
                                                    <IconBookOpen size={10} /> {t('memo', lang)}
                                                </div>
                                                <p className="text-xs text-slate-300 leading-relaxed">{getLoc(selectedCard, 'tip', lang)}</p>
                                            </div>
                                         )}

                                         <div>
                                              <div className="text-[10px] font-bold text-slate-500 uppercase mb-2">{t('tags', lang)}</div>
                                              <div className="flex flex-wrap gap-2">
                                                 {(selectedCard.combosWith || []).map(tag => (
                                                     <span key={'c'+tag} className="text-[10px] px-2 py-1 rounded bg-amber-900/30 text-amber-400 border border-amber-900/50">â˜… {tag}</span>
                                                 ))}
                                                 {selectedCard.providesTag && (
                                                     <span className="text-[10px] px-2 py-1 rounded bg-cyan-900/30 text-cyan-400 border border-cyan-900/50">#{selectedCard.providesTag}</span>
                                                 )}
                                                 {(selectedCard.providesTags || []).map(tag => (
                                                     <span key={'p'+tag} className="text-[10px] px-2 py-1 rounded bg-cyan-900/30 text-cyan-400 border border-cyan-900/50">#{tag}</span>
                                                 ))}
                                                 {(!selectedCard.combosWith && !selectedCard.providesTag && (!selectedCard.providesTags || selectedCard.providesTags.length === 0)) && (
                                                     <span className="text-[10px] text-slate-600">-</span>
                                                 )}
                                              </div>
                                         </div>
                                     </div>
                                 </div>
                             )}
                         </div>

                         {/* Mobile Detail Modal (Overlay) */}
                         {selectedCard && (
                             <div className="absolute inset-0 z-10 bg-slate-900/90 backdrop-blur-sm p-4 md:hidden flex items-center justify-center" onClick={() => setSelectedCard(null)}>
                                  <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 max-w-sm w-full shadow-2xl overflow-y-auto max-h-[80vh]" onClick={e => e.stopPropagation()}>
                                       <CardInfoPanel card={selectedCard} lang={lang} />
                                       <button className="mt-4 w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl text-xs font-bold transition-colors" onClick={() => setSelectedCard(null)}>{t('close', lang)}</button>
                                  </div>
                             </div>
                         )}
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, settings, onChange, lang }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[130] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-slate-800 border border-slate-700 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative" onClick={e => e.stopPropagation()}>
                        <div className="bg-slate-900/50 p-4 border-b border-slate-700 flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <IconSettings size={20} className="text-slate-400" />
                                 <h2 className="text-lg font-bold text-white">{lang === 'en' ? 'Settings' : 'è¨­å®š'}</h2>
                             </div>
                             <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors">
                                 <IconX size={20} />
                             </button>
                        </div>

                        <div className="p-6 space-y-6">
                            {/* Volume */}
                            <div className="space-y-3">
                                <label className="text-sm font-bold text-slate-400 uppercase tracking-wider block">
                                    {lang === 'en' ? 'Sound Volume' : 'éŸ³é‡è¨­å®š'}
                                </label>
                                <div className="flex items-center gap-4">
                                    <button onClick={() => onChange('isMuted', !settings.isMuted)} className="text-slate-400 hover:text-white">
                                        {settings.isMuted ? <IconVolumeX /> : <IconVolume2 />}
                                    </button>
                                    <input
                                        type="range"
                                        min="0"
                                        max="100"
                                        value={settings.volume}
                                        onChange={(e) => onChange('volume', parseInt(e.target.value))}
                                        className="flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                                        disabled={settings.isMuted}
                                    />
                                    <span className="text-sm font-mono text-slate-300 w-8 text-right">{settings.volume}%</span>
                                </div>
                            </div>

                            <div className="h-px bg-slate-700/50"></div>

                            {/* Language */}
                            <div className="flex items-center justify-between">
                                 <label className="text-sm font-bold text-slate-400 uppercase tracking-wider">
                                    {lang === 'en' ? 'Language' : 'è¨€èª (Language)'}
                                </label>
                                <div className="flex bg-slate-900 rounded-lg p-1 border border-slate-700">
                                    <button
                                        onClick={() => onChange('lang', 'ja')}
                                        className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${settings.lang === 'ja' ? 'bg-cyan-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}
                                    >
                                        æ—¥æœ¬èª
                                    </button>
                                    <button
                                        onClick={() => onChange('lang', 'en')}
                                        className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${settings.lang === 'en' ? 'bg-cyan-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}
                                    >
                                        English
                                    </button>
                                </div>
                            </div>

                            {/* Text Size */}
                            <div className="flex items-center justify-between">
                                 <label className="text-sm font-bold text-slate-400 uppercase tracking-wider">
                                    {lang === 'en' ? 'Text Size' : 'æ–‡å­—ã‚µã‚¤ã‚º'}
                                </label>
                                <div className="flex bg-slate-900 rounded-lg p-1 border border-slate-700">
                                    {['small', 'medium', 'large'].map(size => (
                                        <button
                                            key={size}
                                            onClick={() => onChange('fontSizeLevel', size)}
                                            className={`px-3 py-1 rounded-md text-xs font-bold transition-all capitalize ${settings.fontSizeLevel === size ? 'bg-cyan-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}
                                        >
                                            {size === 'small' ? 'S' : size === 'large' ? 'L' : 'M'}
                                        </button>
                                    ))}
                                </div>
                            </div>

                             <div className="h-px bg-slate-700/50"></div>

                            {/* Gameplay */}
                            <div className="flex items-center justify-between">
                                <div>
                                     <label className="text-sm font-bold text-slate-400 uppercase tracking-wider block">
                                        {lang === 'en' ? 'Skip Summary' : 'ã‚µãƒãƒªãƒ¼ã‚¹ã‚­ãƒƒãƒ—'}
                                    </label>
                                    <p className="text-[10px] text-slate-500">
                                        {lang === 'en' ? 'Auto-proceed after turn ends' : 'ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã®æ¼”å‡ºã‚’çŸ­ç¸®'}
                                    </p>
                                </div>
                                <button
                                    onClick={() => onChange('skipTurnSummary', !settings.skipTurnSummary)}
                                    className={`w-12 h-6 rounded-full transition-colors relative ${settings.skipTurnSummary ? 'bg-cyan-600' : 'bg-slate-700'}`}
                                >
                                    <div className={`absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform ${settings.skipTurnSummary ? 'translate-x-6' : 'translate-x-0'}`}></div>
                                </button>
                            </div>

                        </div>
                         <div className="bg-slate-900/50 p-4 border-t border-slate-700">
                            <button onClick={onClose} className="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-bold transition-colors">
                                {lang === 'en' ? 'Close' : 'é–‰ã˜ã‚‹'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const StatusPanel = ({ data, isEnemy, interest, isShaking, lang }) => {
            if (!data) return <div className="p-4 border rounded text-red-500">Error: No Data</div>;

            const inflationAlert = (value) => {
                if (value >= 12) return { label: 'ãƒã‚¤ãƒ‘ãƒ¼ã‚¤ãƒ³ãƒ•ãƒ¬', color: 'text-red-400 bg-red-900/30 border-red-500' };
                if (value >= 8) return { label: 'é«˜ã‚¤ãƒ³ãƒ•ãƒ¬', color: 'text-orange-400 bg-orange-900/30 border-orange-500' };
                if (value >= 4) return { label: 'ã‚¤ãƒ³ãƒ•ãƒ¬é€²è¡Œ', color: 'text-amber-400 bg-amber-900/30 border-amber-500' };
                if (value <= -2) return { label: 'ãƒ‡ãƒ•ãƒ¬', color: 'text-cyan-400 bg-cyan-900/30 border-cyan-500' };
                return { label: 'å®‰å®š', color: 'text-emerald-400 bg-emerald-900/30 border-emerald-500' };
            };

            const alert = inflationAlert(data.inflation || 0);

            // Theme colors (Dark Mode)
            const theme = isEnemy ? {
                bg: 'bg-slate-800/40 backdrop-blur-md',
                border: 'border-slate-700/50',
                text: 'text-slate-300',
                accent: 'text-slate-400',
                highlight: 'bg-slate-700/30',
                bar: 'bg-slate-500'
            } : {
                bg: 'bg-slate-900/60 backdrop-blur-md',
                border: 'border-cyan-500/30',
                text: 'text-slate-100',
                accent: 'text-cyan-400',
                highlight: 'bg-cyan-950/40',
                bar: 'bg-cyan-500'
            };

            return (
                <div className={`relative overflow-hidden p-6 rounded-3xl border transition-all duration-300 ${theme.bg} ${theme.border} ${!isEnemy && 'shadow-2xl shadow-cyan-900/10 ring-1 ring-cyan-500/20'} ${isShaking ? 'animate-shake' : ''}`}>
                    {/* Header */}
                    <div className="flex justify-between items-start mb-6">
                        <div className="flex items-center gap-4">
                            <div className={`w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg ${isEnemy ? 'bg-slate-700/50 text-slate-400 border border-slate-600' : 'bg-gradient-to-br from-cyan-500 to-blue-600 text-white shadow-cyan-500/30'}`}>
                                {isEnemy ? <IconZap size={24} /> : <IconWallet size={24} />}
                            </div>
                            <div>
                                <div className="flex items-center gap-2 mb-1">
                                    <h3 className={`font-black text-xl leading-none tracking-tight ${theme.text}`}>
                                        {isEnemy ? t('rivalCountry', lang) : t('myCountry', lang)}
                                    </h3>
                                    <span className={`text-[9px] font-black px-1.5 py-0.5 rounded uppercase tracking-widest ${isEnemy ? 'bg-slate-700/50 text-slate-400' : 'bg-cyan-500/10 text-cyan-400 border border-cyan-500/20'}`}>
                                        {isEnemy ? 'AI' : 'YOU'}
                                    </span>
                                </div>
                                <div className="text-xs text-slate-400 font-medium flex items-center gap-1.5 bg-black/20 px-2 py-0.5 rounded w-max">
                                    <span className="opacity-70 text-[10px] uppercase tracking-wide">Rating</span>
                                    <span className={`font-black font-mono ${['AAA','BBB'].includes(data.rating) ? 'text-emerald-400' : 'text-amber-400'}`}>{data.rating}</span>
                                </div>
                            </div>
                        </div>

                        <div className="text-right">
                            <div className="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-1">{t('gdp', lang)}</div>
                            <div className={`text-4xl font-black tracking-tighter leading-none ${isEnemy ? 'text-slate-500' : 'text-transparent bg-clip-text bg-gradient-to-br from-cyan-300 to-blue-400 drop-shadow-sm'}`}>
                                <NumberCounter value={data.gdp} /><span className="text-sm font-bold ml-1 text-slate-600">{t('trillion', lang)}</span>
                            </div>
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-2 gap-3 mb-4">
                        {/* Money */}
                        <div className={`${theme.highlight} p-3 rounded-xl border border-slate-700/50`}>
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-xs font-bold text-slate-500 flex items-center gap-1">
                                    {t('money', lang)}
                                </span>
                                <span className="text-sm font-bold font-mono text-slate-300">Â¥<NumberCounter value={data.money} /></span>
                            </div>
                            <div className="w-full bg-slate-900 rounded-full h-1.5 overflow-hidden mb-2">
                                <div className={`h-full rounded-full transition-all duration-500 ${theme.bar}`} style={{ width: `${Math.min(100, data.money)}%` }}></div>
                            </div>
                            <div className="flex justify-between text-[10px] font-medium text-slate-400">
                                <span>{t('income', lang)}: <span className="text-emerald-400">+<NumberCounter value={data.income} /></span></span>
                                <span>{t('interest', lang)}: <span className="text-rose-400">-<NumberCounter value={interest} /></span></span>
                            </div>
                        </div>

                        {/* Support */}
                        <div className={`${theme.highlight} p-3 rounded-xl border border-slate-700/50`}>
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-xs font-bold text-slate-500">{t('support', lang)}</span>
                                <span className={`text-sm font-bold font-mono ${data.support < 30 ? 'text-rose-400' : 'text-slate-300'}`}><NumberCounter value={data.support} />%</span>
                            </div>
                            <div className="w-full bg-slate-900 rounded-full h-1.5 overflow-hidden">
                                <div className={`h-full rounded-full transition-all duration-500 ${data.support < 30 ? 'bg-rose-500' : 'bg-indigo-500'}`} style={{ width: `${data.support}%` }}></div>
                            </div>
                        </div>
                    </div>

                    {/* Footer Stats */}
                    <div className="flex gap-2">
                        <div className="flex-1 bg-slate-900/50 p-2 rounded-lg border border-slate-700/50 flex justify-between items-center">
                            <span className="text-[10px] font-bold text-slate-500">{t('debt', lang)}</span>
                            <span className="text-xs font-bold text-slate-400"><NumberCounter value={data.debt} />{t('trillion', lang)}</span>
                        </div>
                        <div className={`flex-1 p-2 rounded-lg border flex justify-between items-center ${alert.color}`}>
                            <span className="text-[10px] font-bold opacity-70">{t('inflation', lang)}</span>
                            <span className="text-xs font-bold">{data.inflation.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---

        function EconomicCardGame() {
            const [turn, setTurn] = useState(1);
            const [era, setEra] = useState(ERAS.GROWTH);
            const [gameState, setGameState] = useState('TITLE'); // TITLE, SETUP, PLAYING, WON, LOST
            const [skipTurnSummary, setSkipTurnSummary] = useState(false);
            const [autoProceed, setAutoProceed] = useState(false);
            const [logs, setLogs] = useState([]);
            const [activeEvent, setActiveEvent] = useState(null);
            const [lastTags, setLastTags] = useState([]);
            const [isMuted, setIsMuted] = useState(false);
            const [lastPlayedCard, setLastPlayedCard] = useState(null); // Purely for UI visualization
            const [floatingTexts, setFloatingTexts] = useState([]);
            const [showTurnOverlay, setShowTurnOverlay] = useState(false);
            const [shake, setShake] = useState({ player: false, enemy: false });
            const [hoveredCard, setHoveredCard] = useState(null);
            const [crisisAlert, setCrisisAlert] = useState(null); // { message: string, type: 'danger'|'warning' }
            const [evaluation, setEvaluation] = useState(null);
            const [lang, setLang] = useState('ja'); // 'ja' | 'en'
            const [comboMessage, setComboMessage] = useState(null);
            const [comboChain, setComboChain] = useState({ tag: null, count: 0 });
            const [activeMission, setActiveMission] = useState(null); // { missionId, turnsLeft }
            const [completedMissionCount, setCompletedMissionCount] = useState(0);
            const [turnSummaryData, setTurnSummaryData] = useState(null);
            const [showTurnSummary, setShowTurnSummary] = useState(false);
            const [turnHighlight, setTurnHighlight] = useState({ gdpGain: 0, text: '' });
            const [earnedTitles, setEarnedTitles] = useState({});
            const [unlockedAchievements, setUnlockedAchievements] = useState({});
            const [discoveredCards, setDiscoveredCards] = useState({});
            const [showEncyclopedia, setShowEncyclopedia] = useState(false);
            const [gameProgress, setGameProgress] = useState({
                monetarist_rank_a_count: 0,
                total_inflation_combos: 0,
            });
            const [fontSizeLevel, setFontSizeLevel] = useState('medium'); // small, medium, large
            const [masterVolume, setMasterVolume] = useState(50);
            const [showSettings, setShowSettings] = useState(false);

            // Settings Management
            useEffect(() => {
                try {
                    const savedSettings = localStorage.getItem('economics_master_settings');
                    if (savedSettings) {
                        const parsed = JSON.parse(savedSettings);
                        if (parsed.lang) setLang(parsed.lang);
                        if (parsed.fontSizeLevel) setFontSizeLevel(parsed.fontSizeLevel);
                        if (parsed.skipTurnSummary !== undefined) setSkipTurnSummary(parsed.skipTurnSummary);
                        if (parsed.isMuted !== undefined) setIsMuted(parsed.isMuted);
                        if (parsed.masterVolume !== undefined) setMasterVolume(parsed.masterVolume);
                    }
                } catch (e) { console.error(e); }
            }, []);

            useEffect(() => {
                const settings = { lang, fontSizeLevel, skipTurnSummary, isMuted, masterVolume };
                localStorage.setItem('economics_master_settings', JSON.stringify(settings));
            }, [lang, fontSizeLevel, skipTurnSummary, isMuted, masterVolume]);

            useEffect(() => {
                SoundManager.setVolume(masterVolume / 100);
            }, [masterVolume]);

            const handleSettingsChange = (key, value) => {
                if (key === 'lang') setLang(value);
                if (key === 'fontSizeLevel') setFontSizeLevel(value);
                if (key === 'skipTurnSummary') setSkipTurnSummary(value);
                if (key === 'isMuted') setIsMuted(value);
                if (key === 'volume') setMasterVolume(value);
            };

            useEffect(() => {
                const root = document.documentElement;
                if (fontSizeLevel === 'small') root.style.fontSize = '14px';
                else if (fontSizeLevel === 'large') root.style.fontSize = '18px';
                else root.style.fontSize = '16px';
            }, [fontSizeLevel]);

            useEffect(() => {
                if (autoProceed) {
                    setAutoProceed(false);
                    proceedToNextTurn();
                }
            }, [autoProceed]);

            useEffect(() => {
                try {
                    const savedProgress = localStorage.getItem('economics_master_progress');
                    if (savedProgress) {
                        setGameProgress(JSON.parse(savedProgress));
                    }
                    const savedTitles = localStorage.getItem('earnedTitles');
                    if (savedTitles) {
                        setEarnedTitles(JSON.parse(savedTitles));
                    }
                    const savedAchievements = localStorage.getItem('unlockedAchievements');
                    if (savedAchievements) {
                        setUnlockedAchievements(JSON.parse(savedAchievements));
                    }
                    const savedCards = localStorage.getItem('economics_master_discovered_cards');
                    if (savedCards) {
                         setDiscoveredCards(JSON.parse(savedCards));
                    }
                } catch (e) {
                    console.error("Failed to load data from localStorage", e);
                }
            }, []);

            useEffect(() => {
                // These helpers are exposed for testing/scripting from outside React.
                // In a real production build, these would be removed.
                const availableCards = ALL_CARDS.filter(card => !card.requiredAchievement || unlockedAchievements[card.requiredAchievement]);
                window.setPlayer = setPlayer;
                window.setHandByIds = (ids) => {
                    const newHand = ids.map(id => {
                        const card = availableCards.find(c => c.id === id);
                        return card ? { ...card, uniqueId: Math.random() } : null;
                    }).filter(Boolean);
                    setPlayerHand(newHand);
                };
            }, [unlockedAchievements]);

            // Difficulty State
            const [selectedDifficulty, setSelectedDifficulty] = useState(DIFFICULTY_SETTINGS.NORMAL.id);
            const [currentDifficulty, setCurrentDifficulty] = useState(DIFFICULTY_SETTINGS.NORMAL);
            const [selectedIdeology, setSelectedIdeology] = useState(IDEOLOGIES.KEYNESIAN.id);
            const [gameDeck, setGameDeck] = useState([]);
            const [discardPile, setDiscardPile] = useState([]);

            const shuffleArray = (arr) => {
                const copy = [...arr];
                for (let i = copy.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [copy[i], copy[j]] = [copy[j], copy[i]];
                }
                return copy;
            };

            useEffect(() => {
                SoundManager.isMuted = isMuted;
            }, [isMuted]);

            // Update Era based on progress
            useEffect(() => {
                if (gameState !== 'PLAYING') return;

                let nextEra = ERAS.GROWTH;
                // Phase 3: IT Revolution
                if (turn >= 15 || (player && player.gdp >= 200)) {
                    nextEra = ERAS.IT_REV;
                }
                // Phase 2: Stagnation
                else if (turn >= 8 || (player && player.gdp >= 100)) {
                    nextEra = ERAS.STAGNATION;
                }

                if (nextEra.id !== era.id) {
                    setEra(nextEra);
                    const eraName = getLoc(nextEra, 'name', lang);
                    const eraEffect = getLoc(nextEra, 'effectDesc', lang);
                    addLog(`ğŸ“¢ ${eraName} - ${eraEffect}`);
                    SoundManager.playTone(200, 'sawtooth', 0.5, 0.05); // Era change sound
                }
            }, [turn, player, gameState]); // Changed dependency from player.gdp to player to avoid undefined access

            useEffect(() => {
                // Show turn overlay on turn change
                if (gameState === 'PLAYING') {
                    setShowTurnOverlay(true);
                    const timer = setTimeout(() => setShowTurnOverlay(false), 2000);
                    return () => clearTimeout(timer);
                }
            }, [turn, gameState]);

            const triggerShake = (target) => { // 'player' or 'enemy'
                setShake(prev => ({ ...prev, [target]: true }));
                setTimeout(() => setShake(prev => ({ ...prev, [target]: false })), 500);
            };
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹
            const [player, setPlayer] = useState({
                name: 'ã‚ãªãŸ',
                money: 100,
                income: 10,
                gdp: 0,
                inflation: 0,
                support: 70,
                debt: 0,
                rating: 'AAA',
                interestDue: 0,
            });
            const [playerHand, setPlayerHand] = useState([]);

            // AIçŠ¶æ…‹
            const [enemy, setEnemy] = useState({
                name: 'ãƒ©ã‚¤ãƒãƒ«å›½',
                money: 100,
                income: 10,
                gdp: 0,
                inflation: 0,
                support: 70,
                debt: 0,
                rating: 'AAA',
                interestDue: 0,
            });

            // Crisis Check Effect (Inflation)
            useEffect(() => {
                if (gameState !== 'PLAYING') return;

                if (player.inflation >= 12) {
                     const msg = lang === 'en' ? "CRISIS: RIOTS!\n(Inflation > 12%)" : "æš´å‹•ã®å±æ©Ÿï¼\n(ã‚¤ãƒ³ãƒ•ãƒ¬12%çªç ´)";

                     // Only trigger if we aren't already showing one?
                     if (!crisisAlert) {
                         SoundManager.playCrisis();
                         setCrisisAlert({ message: msg, type: 'danger' });
                         setTimeout(() => setCrisisAlert(null), 3000);
                     } else if (crisisAlert.message !== msg) {
                         // Update message if language changed while alert is active
                         setCrisisAlert(prev => ({ ...prev, message: msg }));
                     }
                }
            }, [player.inflation, gameState, lang]);

            // UI Enhancement: Add Floating Text
            const addFloatingText = (x, y, text, type = 'default') => {
                const id = Math.random();
                // Determine color based on type
                let colorClass = 'text-white';
                let sizeClass = 'text-2xl';

                if (type === 'cost') colorClass = 'text-amber-400';
                if (type === 'income') colorClass = 'text-emerald-400';
                if (type === 'gdp') colorClass = 'text-cyan-300';
                if (type === 'support') colorClass = 'text-indigo-300';
                if (type === 'damage') colorClass = 'text-rose-500';
                if (type === 'combo') {
                    colorClass = 'text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-amber-600 drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]';
                    sizeClass = 'text-5xl';
                }

                setFloatingTexts(prev => [...prev, { id, x, y, text, colorClass, sizeClass, type }]);
                setTimeout(() => {
                    setFloatingTexts(prev => prev.filter(ft => ft.id !== id));
                }, 1000);
            };

            // ... (Logic functions remain unchanged)

            const getInflationAlert = (value) => {
                // Not used in UI but kept for logic consistency if needed
                if (value >= 12) return { label: 'âš ï¸ ãƒã‚¤ãƒ‘ãƒ¼ã‚¤ãƒ³ãƒ•ãƒ¬æ‡¸å¿µ', color: 'text-red-700 bg-red-100 border-red-200' };
                // ...
            };

            const applyUnrestPenalty = (state, actorLabel) => {
                if (state.inflation < 8) return state;

                const angerLevel = state.inflation >= 12 ? 'è‡¨ç•Œ' : state.inflation >= 10 ? 'é«˜ã¾ã‚Š' : 'ä¸Šæ˜‡';
                const incomePenalty = state.inflation >= 12 ? 4 : 2;
                const gdpPenalty = state.inflation >= 10 ? 5 : 0;
                const penalizedState = {
                    ...state,
                    income: Math.max(0, state.income - incomePenalty),
                    gdp: Math.max(0, state.gdp - gdpPenalty),
                };

                const msg = lang === 'en'
                    ? `${actorLabel}: High inflation causes unrest! Income -${incomePenalty}${gdpPenalty ? ` / GDP -${gdpPenalty}` : ''}`
                    : `${actorLabel}: ã‚¤ãƒ³ãƒ•ãƒ¬é«˜é¨°ã«ã‚ˆã‚Šã€Œå›½æ°‘ã®ä¸æº€ã€ãŒ${angerLevel}ã€æ‰€å¾—-${incomePenalty}${gdpPenalty ? ` / GDP-${gdpPenalty}` : ''}`;

                addLog(msg);
                return penalizedState;
            };

            const applySupportChange = (state, delta = 0, actorLabel, reason) => {
                if (!delta) return state;
                const prevSupport = state.support ?? 0;
                const nextSupport = Math.min(100, Math.max(0, prevSupport + delta));
                const msg = lang === 'en'
                    ? `${actorLabel}: Support ${prevSupport}% -> ${nextSupport}% (${reason})`
                    : `${actorLabel}: ${reason}ã§æ”¯æŒç‡ãŒ${prevSupport}% â†’ ${nextSupport}%ã«å¤‰åŒ–`;
                addLog(msg);
                return { ...state, support: nextSupport };
            };

            const applyRatingUpdate = (state, actorLabel) => {
                const nextRating = getRatingByDebt(state.debt ?? 0);
                if (state.rating === nextRating) return state;
                const msg = lang === 'en'
                    ? `${actorLabel}: Rating changed ${state.rating} -> ${nextRating} (Debt: ${state.debt})`
                    : `${actorLabel}: å‚µå‹™æ®‹é«˜${state.debt}å…†ã«ã‚ˆã‚Šæ ¼ä»˜ã‘ãŒ${state.rating} â†’ ${nextRating}ã«å¤‰åŒ–`;
                addLog(msg);
                return { ...state, rating: nextRating };
            };

            const getInterestForTurn = (state) => {
                const ratingInfo = getRatingInfo(state.rating);
                return Math.max(0, Math.round((state.interestDue ?? 0) * ratingInfo.interestMultiplier));
            };

            const applyInterestPayment = (state, actorLabel) => {
                const interest = getInterestForTurn(state);
                if (!interest) return state;
                const afterPayment = { ...state, money: Math.max(0, state.money - interest) };
                const msg = lang === 'en'
                    ? `${actorLabel}: Paid ${interest}T interest (Rating: ${state.rating})`
                    : `${actorLabel}: å‚µå‹™åˆ©æ‰•ã„ã¨ã—ã¦ ${interest}å…†å††ã‚’æ”¯æ‰•ã„ã¾ã—ãŸï¼ˆæ ¼ä»˜ã‘: ${state.rating}ï¼‰`;
                addLog(msg);
                return afterPayment;
            };

            // åˆæœŸåŒ–
            const startGame = () => {
                SoundManager.init();
                SoundManager.playSuccess();

                const difficulty = DIFFICULTY_SETTINGS[selectedDifficulty];
                setCurrentDifficulty(difficulty);

                const ideology = IDEOLOGIES[selectedIdeology];

                // Determine available cards based on achievements AND unlock conditions
                const availableCards = ALL_CARDS.filter(card => {
                    const achOk = !card.requiredAchievement || unlockedAchievements[card.requiredAchievement];
                    const unlockOk = !card.unlockCondition || card.unlockCondition(gameProgress);
                    return achOk && unlockOk;
                });

                // Build Deck based on Ideology
                const newDeck = [];
                availableCards.forEach(card => {
                    const weight = ideology.deckWeights[card.id] || 1;
                    for(let i=0; i<weight; i++) {
                        newDeck.push(card);
                    }
                });
                const shuffledDeck = shuffleArray(newDeck);
                setGameDeck(shuffledDeck);
                setDiscardPile([]);

                const event = chooseRandomEvent();
                setActiveEvent(event);

                // Initialize Player Stats: Ideology Base + Difficulty Modifiers
                const initialDebt = (ideology.initialStats.debt || 0) + (difficulty.initialDebt || 0);

                const initialPlayerState = {
                    money: (ideology.initialStats.money || 100) + (difficulty.initialMoney - DIFFICULTY_SETTINGS.NORMAL.initialMoney),
                    income: 20,
                    gdp: 0,
                    inflation: 0,
                    support: ideology.initialStats.support || 70,
                    debt: initialDebt,
                    rating: getRatingByDebt(initialDebt),
                    interestDue: Math.round(initialDebt * 0.1),
                    activeEffects: []
                };

                // AI uses standard/difficulty stats or could mirror player (let's use difficulty defaults for AI to keep it standard)
                const initialEnemyState = {
                    money: difficulty.initialMoney,
                    income: 20,
                    gdp: 0,
                    inflation: 0,
                    support: 70,
                    debt: difficulty.initialDebt,
                    rating: getRatingByDebt(difficulty.initialDebt),
                    interestDue: Math.round(difficulty.initialDebt * 0.1),
                    activeEffects: []
                };

                setPlayer(initialPlayerState);
                setEnemy({ ...initialEnemyState, name: 'ãƒ©ã‚¤ãƒãƒ«å›½', activeEffects: [] });

                setPlayerHand([]);
                setLastTags([]);
                setTurn(1);

                const eventName = getLoc(event, 'name', lang);
                const eventDesc = getLoc(event, 'description', lang);
                const diffLabel = getLoc(difficulty, 'label', lang);
                const ideologyName = getLoc(ideology, 'name', lang);

                setLogs([
                    lang === 'en' ? `ğŸ“¢ Event: ${eventName} - ${eventDesc}` : `ğŸ“¢ ä»Šã‚¿ãƒ¼ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ: ã€Œ${eventName}ã€ - ${eventDesc}`,
                    lang === 'en' ? `Game Start! Diff: ${diffLabel} / Style: ${ideologyName}` : `ã‚²ãƒ¼ãƒ é–‹å§‹ï¼é›£æ˜“åº¦: ${diffLabel} / æ€æƒ³: ${ideologyName}`
                ]);
                setGameState('PLAYING');
                setLastPlayedCard(null);
                setFloatingTexts([]);
                setActiveMission(null);
                setCompletedMissionCount(0);
                setTurnHighlight({ gdpGain: 0, text: '' });

                // Draw initial cards from the NEW deck.
                // Note: drawCards uses 'gameDeck' state, but state updates are async.
                // So we pass the deck explicitly to a modified draw helper or just set state and use effect?
                // Better: drawCards uses gameDeck from state, but it's empty right now!
                // Fix: Pass the deck to drawCards or handle initial draw separately.
                // Let's modify drawCards to accept an optional deck source.
                drawCards(3, shuffledDeck, []);
            };

            const addLog = (msg) => {
                setLogs(prev => [msg, ...prev].slice(0, 10)); // Increased log size slightly
            };

            const chooseRandomEvent = () => EVENTS[Math.floor(Math.random() * EVENTS.length)];

            const selectTurnEvent = () => {
                const event = chooseRandomEvent();
                setActiveEvent(event);
                const eventName = getLoc(event, 'name', lang);
                const eventDesc = getLoc(event, 'description', lang);
                addLog(lang === 'en' ? `ğŸ“¢ Event: ${eventName} - ${eventDesc}` : `ğŸ“¢ ä»Šã‚¿ãƒ¼ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ: ã€Œ${eventName}ã€ - ${eventDesc}`);
            };

            // ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒ¼æ©Ÿèƒ½
            const drawCards = (count, sourceDeck = null, sourceDiscard = null) => {
                let deck = sourceDeck ? [...sourceDeck] : [...gameDeck];
                let discarded = sourceDiscard ? [...sourceDiscard] : [...discardPile];
                const drawnCards = [];

                for (let i = 0; i < count; i++) {
                    if (deck.length === 0) {
                        if (discarded.length === 0) {
                            if (i === 0) {
                                addLog(lang === 'en' ? 'Deck is empty. No cards to draw.' : 'å±±æœ­ãŒç©ºã§ã™ã€‚ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã‘ã¾ã›ã‚“ã€‚');
                            }
                            break;
                        }
                        deck = shuffleArray(discarded);
                        discarded = [];
                        addLog(lang === 'en' ? 'Discard pile reshuffled into deck.' : 'æ¨ã¦æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å±±æœ­ã‚’å†æ§‹ç¯‰ã—ã¾ã—ãŸã€‚');
                    }

                    const [card] = deck.splice(-1, 1);
                    drawnCards.push({ ...card, uniqueId: Math.random() });
                }

                if (drawnCards.length > 0) {
                    setPlayerHand(prev => [...prev, ...drawnCards]);
                }

                setGameDeck(deck);
                setDiscardPile(discarded);
            };

            const issueBonds = (e) => {
                if (gameState !== 'PLAYING') return;
                SoundManager.playTone(1000, 'sine', 0.1, 0.1);

                // Show feedback
                if (e) {
                    addFloatingText(e.clientX, e.clientY, "+50", "income");
                }

                setPlayer(prev => {
                    const updated = {
                        ...prev,
                        money: prev.money + 50,
                        debt: (prev.debt ?? 0) + 50,
                        interestDue: (prev.interestDue ?? 0) + 5,
                    };
                    const rated = applyRatingUpdate(updated, 'ã‚ãªãŸ');
                    const msg = lang === 'en'
                        ? 'YOU: Bond Issued! +50 Money, +50 Debt, Interest +5/turn'
                        : 'ã‚ãªãŸ: å›½å‚µç™ºè¡Œï¼è³‡é‡‘+50å…† / å‚µå‹™+50å…†ã€åˆ©æ‰•ã„5å…†/ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ ';
                    addLog(msg);
                    return rated;
                });
            };

            const repayDebt = (e) => {
                if (gameState !== 'PLAYING') return;
                if (player.money < 50) {
                     SoundManager.playError();
                     addLog(lang === 'en' ? 'Not enough funds to repay debt (Need 50T)' : 'å›½å‚µå„Ÿé‚„ã®è³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ (å¿…è¦: 50å…†)');
                     return;
                }
                if ((player.debt || 0) <= 0) {
                    addLog(lang === 'en' ? 'No debt to repay.' : 'å„Ÿé‚„ã™ã¹ãå‚µå‹™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }

                SoundManager.playTone(1200, 'sine', 0.1, 0.1);

                if (e) {
                    addFloatingText(e.clientX, e.clientY, "-50", "cost");
                }

                setPlayer(prev => {
                    const updated = {
                        ...prev,
                        money: prev.money - 50,
                        debt: Math.max(0, (prev.debt ?? 0) - 50),
                        interestDue: Math.max(0, (prev.interestDue ?? 0) - 5),
                    };
                    const rated = applyRatingUpdate(updated, 'ã‚ãªãŸ');
                    const msg = lang === 'en'
                        ? 'YOU: Repaid Debt. -50 Money, -50 Debt.'
                        : 'ã‚ãªãŸ: å›½å‚µã‚’å„Ÿé‚„ã—ã¾ã—ãŸã€‚è³‡é‡‘-50å…† / å‚µå‹™-50å…†';
                    addLog(msg);
                    return rated;
                });
            };

            const applyEventMultiplier = (prevState, nextState) => {
                // 1. Event Multiplier (from card events like Technology Boom)
                const evtMultiplier = activeEvent?.effect?.effectMultiplier || 1;

                // 2. Difficulty Multiplier (affects negative outcomes mainly)
                // Logic: If the delta is negative (bad), amplify it by difficulty multiplier.
                // Beginner: 0.5x bad effect. Hard: 1.5x bad effect.
                const difficultyMult = currentDifficulty.eventDamageMultiplier || 1;

                const applyScale = (key) => {
                    const delta = nextState[key] - prevState[key];

                    // First apply the event multiplier (e.g., Tech Boom x1.3)
                    let scaledDelta = Math.round(delta * evtMultiplier);

                    // Then apply difficulty multiplier if the effect is negative
                    if (scaledDelta < 0) {
                        scaledDelta = Math.round(scaledDelta * difficultyMult);
                    }

                    return prevState[key] + scaledDelta;
                };

                if (evtMultiplier === 1 && difficultyMult === 1) return nextState;

                return {
                    ...nextState,
                    money: applyScale('money'),
                    income: applyScale('income'),
                    gdp: applyScale('gdp'),
                };
            };

            // Combo logic is now inside playCard and more complex.

            const getCardProvidedTags = (card) => {
                const tags = [];
                if (Array.isArray(card?.providesTags)) {
                    tags.push(...card.providesTags);
                }
                if (card?.providesTag) {
                    tags.push(card.providesTag);
                }
                return tags;
            };

            const withEventMultiplier = (setter) => (updater) => setter(prev => {
                const next = typeof updater === 'function' ? updater(prev) : updater;
                return applyEventMultiplier(prev, next);
            });

            const calculateInflatedCost = (baseCost, inflationRate = 0) => {
                const inflated = Math.max(0, Math.round(baseCost * (1 + inflationRate / 100)));
                let multiplier = activeEvent?.effect?.costMultiplier || 1;

                // Era Effect: Stagnation increases costs
                if (era.id === 'STAGNATION') {
                    multiplier *= 1.5;
                }

                return Math.max(0, Math.round(inflated * multiplier));
            };

            const applyComboBonus = (prevState, nextState, multiplier = 1) => {
                const normalizedMultiplier = Number.isFinite(multiplier) ? multiplier : Number(multiplier) || 1;

                if (normalizedMultiplier <= 1.0) return nextState;

                const applyScale = (key) => {
                    const delta = nextState[key] - prevState[key];
                    if (delta <= 0) return prevState[key]; // Only boost positive effects
                    return prevState[key] + Math.round(delta * normalizedMultiplier);
                };

                return {
                    ...nextState,
                    money: applyScale('money'),
                    income: applyScale('income'),
                    gdp: applyScale('gdp'),
                };
            };

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³å‡¦ç†
            const playCard = (card, e) => {
                if (gameState !== 'PLAYING') return;

                const adjustedCost = calculateInflatedCost(card.cost, player.inflation);
                const comboReadyTags = (card.combosWith ?? []).filter(tag => lastTags.includes(tag));
                const providedTags = getCardProvidedTags(card);
                const cardName = getLoc(card, 'name', lang);

                // Era Effect: IT Revolution (Tech x2)
                const isTech = providedTags.includes('tech');
                const eraMultiplier = (era.id === 'IT_REV' && isTech) ? 2 : 1;

                let updatedEnemyState = null;

                if (player.money < adjustedCost) {
                    SoundManager.playError();
                    addLog(lang === 'en' ? `Not enough funds (Need: ${adjustedCost}T)` : `è³‡é‡‘ä¸è¶³ã§ã™ï¼ˆå¿…è¦: ${adjustedCost}å…†å††ã€ã‚¤ãƒ³ãƒ•ãƒ¬å½±éŸ¿ã‚’åæ˜ ï¼‰`);
                    return;
                }

                // Show feedback
                if (e) {
                    if (adjustedCost > 0) addFloatingText(e.clientX, e.clientY, `-${adjustedCost}`, "cost");
                }

                // Success Rate Check
                const successRate = calculateSuccessRate(card, player.support);
                const roll = Math.random() * 100;
                const isSuccess = roll < successRate;

                // Pay cost regardless of success (RISK!)
                const afterCost = { ...player, money: player.money - adjustedCost };

                let nextPlayerState = null;

                if (!isSuccess) {
                    // FAILURE
                    SoundManager.playError();
                    triggerShake('player');
                    addFloatingText(e.clientX, e.clientY, "FAILED!", "damage");
                    const failMsg = lang === 'en'
                        ? `YOU: Failed to execute "${cardName}"... (Success Rate ${successRate}%)`
                        : `ã‚ãªãŸ: ã€Œ${cardName}ã€ã®å®Ÿè¡Œã«å¤±æ•—... (æˆåŠŸç‡ ${successRate}%)`;
                    addLog(failMsg);

                    let penaltyState = afterCost;
                    if (card.onFailure) {
                        penaltyState = card.onFailure(penaltyState);
                        addLog(lang === 'en' ? `Side Effect: Support plummeted due to policy failure.` : `å‰¯ä½œç”¨: æ”¿ç­–ã®å¤±æ•—ã«ã‚ˆã‚Šæ”¯æŒç‡ãŒæ€¥è½ã—ã¾ã—ãŸã€‚`);
                    }
                    nextPlayerState = penaltyState;
                    setPlayer(nextPlayerState);

                    // Discard card
                    setLastPlayedCard(card);
                    setPlayerHand(prev => prev.filter(c => c.uniqueId !== card.uniqueId));
                    const { uniqueId: _, ...baseCard } = card;
                    setDiscardPile(prev => [...prev, baseCard]);

                    // Bug Fix: Clear tags on failure so combo chain breaks
                    setLastTags([]);

                    return checkWinCondition(nextPlayerState, enemy);
                }

                // SUCCESS
                SoundManager.playCard(card.type);

                // Register to Encyclopedia
                if (!discoveredCards[card.id]) {
                     const newDiscovered = { ...discoveredCards, [card.id]: true };
                     setDiscoveredCards(newDiscovered);
                     localStorage.setItem('economics_master_discovered_cards', JSON.stringify(newDiscovered));
                     addLog(lang === 'en' ? `ğŸ“– New card registered in Encyclopedia!` : `ğŸ“– æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’å›³é‘‘ã«ç™»éŒ²ã—ã¾ã—ãŸï¼`);
                }

                let comboMultiplier = 1.0;

                if (comboReadyTags.length > 0) {
                    const comboTag = comboReadyTags[0];
                    let newComboChain;

                    if (comboChain.tag === comboTag) {
                        newComboChain = { tag: comboTag, count: comboChain.count + 1 };
                    } else {
                        newComboChain = { tag: comboTag, count: 1 };
                    }
                    setComboChain(newComboChain);

                    if (newComboChain.count === 1) comboMultiplier = 1.3;
                    else if (newComboChain.count === 2) comboMultiplier = 1.5;
                    else comboMultiplier = 1.8;

                    // Track Inflation Combos
                    const newProgress = {
                        ...gameProgress,
                        total_inflation_combos: (gameProgress.total_inflation_combos || 0) + 1
                    };
                    setGameProgress(newProgress);
                    localStorage.setItem('economics_master_progress', JSON.stringify(newProgress));

                    const comboName = newComboChain.count > 1
                        ? `âš¡ ${newComboChain.count} CHAIN COMBO!`
                        : `âš¡ ${getLoc(card, 'name', lang)} COMBO!`;

                    setComboMessage(comboName);
                    setTimeout(() => setComboMessage(null), 2500);

                    const msg = lang === 'en'
                        ? (newComboChain.count > 1
                            ? `â˜…â˜… ${newComboChain.count} CHAIN COMBO! Effect x${comboMultiplier}!`
                            : `â˜…COMBO! [${comboReadyTags.join(', ')}] matched! Effect x${comboMultiplier}!`)
                        : (newComboChain.count > 1
                            ? `â˜…â˜… ${newComboChain.count}é€£ç¶šã‚³ãƒ³ãƒœï¼ åŠ¹æœãŒ ${comboMultiplier}å€ã«ï¼`
                            : `â˜…ã‚³ãƒ³ãƒœç™ºå‹•ï¼ã‚¿ã‚°ã€${comboReadyTags.join('ãƒ»')}ã€ãŒå…±é³´ã—ã€åŠ¹æœãŒ ${comboMultiplier}å€ã«ï¼`);
                    addLog(msg);
                    SoundManager.playSuccess();

                    // Combo Risk/Reward
                    setPlayer(p => {
                        const newState = {
                            ...p,
                            inflation: clampInflation(p.inflation + 0.5),
                            support: Math.max(0, p.support - 2)
                        };
                        const riskMsg = lang === 'en' ? `ğŸ’¥Combo side effect: Inflation +0.5%, Support -2%...` : `ğŸ’¥ã‚³ãƒ³ãƒœã®å‰¯ä½œç”¨ã§ã‚¤ãƒ³ãƒ•ãƒ¬ãŒå°‘ã—ä¸Šæ˜‡(+0.5%)ã—ã€æ”¯æŒç‡ãŒä½ä¸‹(-2%)ã—ãŸ...`;
                        addLog(riskMsg);
                        return newState;
                    });

                } else {
                    setComboChain({ tag: null, count: 0 });
                }

                if (card.type === 'ATTACK') {
                    const afterSupport = applySupportChange(afterCost, card.supportChange, 'ã‚ãªãŸ', lang === 'en' ? `"${cardName}" political impact` : `ã€Œ${cardName}ã€ã®æ”¿æ²»çš„å½±éŸ¿`);
                    nextPlayerState = afterSupport;
                } else {
                    // 1. Base Effect
                    const baseState = card.effect(afterCost, enemy);

                    // 2. Apply Era Multiplier (IT_REV & GROWTH GDP Bonus)
                    let boostedState = baseState;

                    // IT Revolution: Tech cards effect doubled
                    if (eraMultiplier > 1) {
                         const keys = ['money', 'income', 'gdp'];
                         const boosted = { ...baseState };
                         keys.forEach(key => {
                             const delta = baseState[key] - afterCost[key];
                             if (delta !== 0) {
                                 boosted[key] = afterCost[key] + delta * eraMultiplier;
                             }
                         });
                         boostedState = boosted;
                    }

                    // GROWTH Era: GDP Boost
                    if (era.id === 'GROWTH') {
                        // Check if boostedState is valid, otherwise fallback
                        const currentGdp = boostedState ? boostedState.gdp : afterCost.gdp;
                        const deltaGdp = currentGdp - afterCost.gdp;
                        if (deltaGdp > 0 && boostedState) {
                            boostedState.gdp = afterCost.gdp + Math.round(deltaGdp * 1.5);
                        }
                    }

                    const comboBoosted = applyComboBonus(afterCost, boostedState, comboMultiplier);

                    // Show detailed combo feedback
                    if (comboMultiplier > 1.0) {
                        const gdpGain = comboBoosted.gdp - afterCost.gdp;
                        const incomeGain = comboBoosted.income - afterCost.income;
                        const moneyGain = comboBoosted.money - afterCost.money;

                        const textX = e ? e.clientX : window.innerWidth / 2;
                        const textY = e ? e.clientY : window.innerHeight / 2;
                        let yOffset = -60;

                        if (gdpGain > 0) {
                            addFloatingText(textX, textY + yOffset, `+${gdpGain}T GDP!`, 'gdp');
                            yOffset += 30;
                        }
                        if (incomeGain > 0) {
                             addFloatingText(textX, textY + yOffset, `+${incomeGain}T ${t('income', lang)}!`, 'income');
                             yOffset += 30;
                        }
                        if (moneyGain > 0) {
                             addFloatingText(textX, textY + yOffset, `+${moneyGain}T ${t('money', lang)}!`, 'income');
                        }
                    }

                    const afterEvent = applyEventMultiplier(afterCost, comboBoosted);

                    // Inflation
                    let inflationDelta = card.inflationChange || 0;
                    if (era.id === 'GROWTH' && inflationDelta > 0) {
                        inflationDelta += 1; // GROWTH inflates faster
                    }
                    const afterInflation = applyInflationChange(afterEvent, inflationDelta);

                    if (inflationDelta) {
                        const infMsg = lang === 'en'
                            ? `YOU: "${cardName}" inflation impact (${inflationDelta > 0 ? '+' : ''}${inflationDelta.toFixed(1)}%)`
                            : `ã‚ãªãŸ: ã€Œ${cardName}ã€ãŒç‰©ä¾¡ã«å½±éŸ¿ (${inflationDelta > 0 ? '+' : ''}${inflationDelta.toFixed(1)}%)`;
                        addLog(infMsg);
                    }
                    const afterUnrest = applyUnrestPenalty(afterInflation, 'ã‚ãªãŸ');
                    const afterSupport = applySupportChange(afterUnrest, card.supportChange, 'ã‚ãªãŸ', lang === 'en' ? `"${cardName}" effect` : `ã€Œ${cardName}ã€ã®åŠ¹æœ`);
                    nextPlayerState = afterSupport;
                }

                const gdpGain = nextPlayerState.gdp - player.gdp;
                if (gdpGain > turnHighlight.gdpGain) {
                    let highlightText = '';
                    const cardNameText = getLoc(card, 'name', lang);

                    if (comboMultiplier > 1.0 && lastPlayedCard) {
                        const prevCardName = getLoc(lastPlayedCard, 'name', lang);
                        highlightText = lang === 'en'
                            ? `GDP +${gdpGain}T (${prevCardName} Ã— ${cardNameText} Combo)`
                            : `GDP +${gdpGain}å…†ï¼ˆ${prevCardName} Ã— ${cardNameText} ã‚³ãƒ³ãƒœï¼‰`;
                    } else if (gdpGain > 0) {
                        highlightText = lang === 'en'
                            ? `GDP +${gdpGain}T (${cardNameText})`
                            : `GDP +${gdpGain}å…†ï¼ˆ${cardNameText}ï¼‰`;
                    }

                    if (highlightText) {
                        setTurnHighlight({ gdpGain, text: highlightText });
                    }
                }
                setPlayer(nextPlayerState);

                // åŠ¹æœç™ºå‹•
                if (card.type === 'ATTACK') {
                    const eventAwareSetEnemy = withEventMultiplier(setEnemy);
                    eventAwareSetEnemy(prev => {
                        const effected = card.targetEffect ? card.targetEffect(prev, nextPlayerState) : prev;
                        const comboBoosted = applyComboBonus(prev, effected, comboMultiplier);
                        const unrested = applyUnrestPenalty(comboBoosted, 'ãƒ©ã‚¤ãƒãƒ«');
                        const withSupport = applySupportChange(unrested, card.targetSupportChange, 'ãƒ©ã‚¤ãƒãƒ«', lang === 'en' ? `"${cardName}" impact` : `ã€Œ${cardName}ã€ã®å½±éŸ¿`);
                        updatedEnemyState = withSupport;
                        return withSupport;
                    });
                    triggerShake('enemy'); // Shake enemy panel
                    addLog(lang === 'en' ? `YOU: Used "${cardName}" to attack rival!` : `ã‚ãªãŸ: ã€Œ${cardName}ã€ã‚’ä½¿ç”¨ï¼ç›¸æ‰‹ã‚’å¦¨å®³ã—ãŸã€‚`);
                } else {
                    addLog(lang === 'en' ? `YOU: Used "${cardName}". Effect activated.` : `ã‚ãªãŸ: ã€Œ${cardName}ã€ã‚’ä½¿ç”¨ã€‚çµŒæ¸ˆåŠ¹æœç™ºå‹•ï¼`);
                }

                // Tip Log
                if (card.tip) {
                    const tipText = getLoc(card, 'tip', lang);
                    addLog(lang === 'en' ? `ğŸ’¡ [Memo] ${tipText}` : `ğŸ’¡ ã€çµŒæ¸ˆãƒ¡ãƒ¢ã€‘${tipText}`);
                }

                // UI update for discard
                setLastPlayedCard(card);

                // æ‰‹æœ­ã‹ã‚‰å‰Šé™¤
                setPlayerHand(prev => prev.filter(c => c.uniqueId !== card.uniqueId));
                const { uniqueId: _, ...baseCard } = card;
                setDiscardPile(prev => [...prev, baseCard]);

                if (providedTags.length > 0) {
                    setLastTags(providedTags);
                } else {
                    setLastTags([]);
                }

                // After an action, check if any mission should be triggered
                checkForNewMission(nextPlayerState);

                return checkWinCondition(nextPlayerState, updatedEnemyState ?? enemy);
            };

            const checkForNewMission = (playerState) => {
                if (activeMission) return; // Don't stack missions

                const triggeredMission = MISSIONS.find(m => m.trigger(playerState));
                if (triggeredMission) {
                    setActiveMission({ missionId: triggeredMission.id, turnsLeft: triggeredMission.turns });
                    const missionName = getLoc(triggeredMission, 'name', lang);
                    const missionObjective = getLoc(triggeredMission, 'objective_text', lang);
                    addLog(`ğŸš¨ MISSION: ${missionName} - ${missionObjective}`);
                    SoundManager.playTone(440, 'sine', 0.5, 0.1);
                }
            };

            // ã‚¿ãƒ¼ãƒ³çµ‚äº†å‡¦ç† & AIã‚¿ãƒ¼ãƒ³
            const endTurn = () => {
                if (gameState !== 'PLAYING' || showTurnSummary) return;

                SoundManager.playClick();

                // -1. Mission Check (at start of turn)
                let missionClearedPlayerState = { ...player };
                if (activeMission) {
                    const mission = MISSIONS.find(m => m.id === activeMission.missionId);
                    if (mission && mission.objective(player)) {
                        // SUCCESS
                        const rewardCard = ALL_CARDS.find(c => c.id === mission.rewardCardId);
                        if (rewardCard) {
                            setPlayerHand(prev => [...prev, { ...rewardCard, uniqueId: Math.random() }]);
                            const cardName = getLoc(rewardCard, 'name', lang);
                            const missionName = getLoc(mission, 'name', lang);
                            addLog(`ğŸ† MISSION CLEARED! Acquired [${cardName}] for clearing "${missionName}".`);
                            SoundManager.playSuccess();
                            setCompletedMissionCount(c => c + 1);
                        }
                        setActiveMission(null);
                    } else if (activeMission.turnsLeft <= 1) {
                        // FAILURE (time's up)
                        const missionName = getLoc(mission, 'name', lang);
                        addLog(`âŒ MISSION FAILED... Timed out on "${missionName}".`);
                        SoundManager.playError();
                        setActiveMission(null);
                    } else {
                        // CONTINUE
                        setActiveMission(am => ({ ...am, turnsLeft: am.turnsLeft - 1 }));
                    }
                }

                // 0. Process Delayed Effects (Player)
                let currentPlayerState = missionClearedPlayerState;
                let effectsTriggered = [];
                let nextActiveEffects = [];

                if (currentPlayerState.activeEffects) {
                    currentPlayerState.activeEffects.forEach(eff => {
                        if (eff.turnsLeft <= 1) {
                            currentPlayerState = eff.effect(currentPlayerState);
                            effectsTriggered.push(getLoc(eff, 'name', lang));
                        } else {
                            nextActiveEffects.push({ ...eff, turnsLeft: eff.turnsLeft - 1 });
                        }
                    });
                }
                currentPlayerState.activeEffects = nextActiveEffects;

                if (effectsTriggered.length > 0) {
                    const msg = lang === 'en'
                        ? `â° Delayed Effects: ${effectsTriggered.join(', ')}`
                        : `â° æ™‚é–“å·®åŠ¹æœç™ºå‹•: ${effectsTriggered.join(', ')}`;
                    addLog(msg);
                }

                // Era Effect: Stagnation Deflation Drift
                let driftTarget = 0;
                let eraIncomePenalty = 0;
                if (era.id === 'STAGNATION') {
                    driftTarget = -2; // Drift towards deflation
                    eraIncomePenalty = 5; // Reduce income
                }

                // Difficulty multiplier for income penalty
                const diffMult = currentDifficulty.eventDamageMultiplier || 1;

                // 1. åå…¥ã®å‡¦ç†ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰
                const driftedInflation = applyInflationDrift(currentPlayerState.inflation, driftTarget);
                const ratingInfo = getRatingInfo(currentPlayerState.rating);

                let basePenalty = (activeEvent?.effect?.incomePenalty ?? 0) * ratingInfo.eventDamageMultiplier + eraIncomePenalty;
                const incomePenalty = Math.round(basePenalty * diffMult);

                const playerIncomeGain = Math.max(0, currentPlayerState.income - incomePenalty);
                let playerAfterIncome = {
                    ...currentPlayerState,
                    money: currentPlayerState.money + playerIncomeGain,
                    inflation: driftedInflation,
                };

                const interestPaid = getInterestForTurn(playerAfterIncome);
                playerAfterIncome = applyInterestPayment(playerAfterIncome, 'ã‚ãªãŸ');
                const ratedPlayer = applyRatingUpdate(playerAfterIncome, 'ã‚ãªãŸ');
                const unrestApplied = applyUnrestPenalty(ratedPlayer, 'ã‚ãªãŸ');
                setPlayer(unrestApplied);

                // --- Ruin Logic: Debt Collapse ---
                if (unrestApplied.debt >= 400 && unrestApplied.rating === 'D') {
                    SoundManager.playDoom();
                    const msg = lang === 'en' ? 'ğŸ“‰ Market Collapse... Economy paralyzed by excess debt.' : 'ğŸ“‰ å¸‚å ´ã®ä¿¡èªå´©å£Šâ€¦ å‚µå‹™è¶…éã«ã‚ˆã‚ŠçµŒæ¸ˆãŒéº»ç—ºã—ã¦ã„ã¾ã™';
                    addLog(msg);
                    setCrisisAlert({ message: lang === 'en' ? "Market Collapse..." : "å¸‚å ´ã®ä¿¡èªå´©å£Šâ€¦", type: 'danger' });
                    setTimeout(() => setCrisisAlert(null), 3000);
                }

                // 2. Prepare Summary Data
                const warnings = [];
                if (interestPaid > 0) {
                    warnings.push((lang === 'en' ? 'Interest Payment: ' : 'åˆ©æ‰•ã„: ') + `-${interestPaid}${t('trillion', lang)}`);
                }

                const inflationChange = driftedInflation - player.inflation;
                 if (Math.abs(inflationChange) > 0.1) {
                    warnings.push((lang === 'en' ? 'Expected Inflation: ' : 'æƒ³å®šã‚¤ãƒ³ãƒ•ãƒ¬: ') + `${inflationChange > 0 ? '+' : ''}${inflationChange.toFixed(1)}%`);
                }

                const summary = {
                    turn,
                    highlight: turnHighlight.text || (lang === 'en' ? 'A steady turn.' : 'å …å®Ÿãªã‚¿ãƒ¼ãƒ³ã§ã—ãŸã€‚'),
                    warnings: warnings.length > 0 ? warnings : [lang === 'en' ? 'No immediate concerns.' : 'ç‰¹ã«æ‡¸å¿µäº‹é …ãªã—ã€‚']
                };

                setTurnSummaryData(summary);
                if (skipTurnSummary) {
                    setAutoProceed(true);
                } else {
                    setShowTurnSummary(true);
                }
            };

            const proceedToNextTurn = () => {
                setShowTurnSummary(false);

                // 2. å‹åˆ©åˆ¤å®š
                if (checkWinCondition()) return;

                // 3. AIã®ã‚¿ãƒ¼ãƒ³
                const aiEndedGame = aiTurn();

                // 4. æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã®æº–å‚™
                if (!aiEndedGame) {
                    setTurn(prev => prev + 1);
                    drawCards(1);
                    selectTurnEvent();
                }

                setLastTags([]);
                setComboChain({ tag: null, count: 0 }); // Reset combo chain at turn end
                setTurnHighlight({ gdpGain: 0, text: '' }); // Reset for new turn
            };

            const aiTurn = () => {
                // Era Effect for AI
                let driftTarget = 0;
                let eraIncomePenalty = 0;
                if (era.id === 'STAGNATION') {
                    driftTarget = -2;
                    eraIncomePenalty = 5;
                }

                // 0. Process Delayed Effects (AI)
                // Note: using 'enemy' from state, assuming it's stable during the turn transition
                let currentEnemyState = { ...enemy };
                let nextActiveEffects = [];
                let effectsTriggered = [];

                if (currentEnemyState.activeEffects) {
                    currentEnemyState.activeEffects.forEach(eff => {
                        if (eff.turnsLeft <= 1) {
                            currentEnemyState = eff.effect(currentEnemyState);
                            effectsTriggered.push(eff.name);
                        } else {
                            nextActiveEffects.push({ ...eff, turnsLeft: eff.turnsLeft - 1 });
                        }
                    });
                }
                currentEnemyState.activeEffects = nextActiveEffects;

                if (effectsTriggered.length > 0) {
                    addLog(lang === 'en' ? `RIVAL: Delayed effects: ${effectsTriggered.join(', ')}` : `ãƒ©ã‚¤ãƒãƒ«: æ™‚é–“å·®åŠ¹æœç™ºå‹•: ${effectsTriggered.join(', ')}`);
                }

                const drifted = applyInflationDrift(currentEnemyState.inflation, driftTarget);
                if (drifted !== currentEnemyState.inflation) {
                    addLog(lang === 'en' ? `RIVAL: Inflation drift ${currentEnemyState.inflation.toFixed(1)}% -> ${drifted.toFixed(1)}%` : `ãƒ©ã‚¤ãƒãƒ«: ã‚¤ãƒ³ãƒ•ãƒ¬ç‡ ${currentEnemyState.inflation.toFixed(1)}% â†’ ${drifted.toFixed(1)}% (è‡ªå‹•èª¿æ•´)`);
                }
                const afterDrift = { ...currentEnemyState, inflation: drifted };
                const ratingInfo = getRatingInfo(afterDrift.rating);
                const incomePenalty = Math.round((activeEvent?.effect?.incomePenalty ?? 0) * ratingInfo.eventDamageMultiplier + eraIncomePenalty);
                const aiIncomeGain = Math.max(0, afterDrift.income - incomePenalty);
                let afterIncome = { ...afterDrift, money: afterDrift.money + aiIncomeGain };
                afterIncome = applyInterestPayment(afterIncome, 'ãƒ©ã‚¤ãƒãƒ«');
                const ratedEnemy = applyRatingUpdate(afterIncome, 'ãƒ©ã‚¤ãƒãƒ«');
                const unrestAdjusted = applyUnrestPenalty(ratedEnemy, 'ãƒ©ã‚¤ãƒãƒ«');

                const potentialActions = ALL_CARDS.filter(c => c.id < MAX_STANDARD_CARD_ID && calculateInflatedCost(c.cost, unrestAdjusted.inflation) <= unrestAdjusted.money);

                if (potentialActions.length === 0) {
                    addLog(lang === 'en' ? `RIVAL: Saving funds.` : `ãƒ©ã‚¤ãƒãƒ«: è³‡é‡‘ä¸è¶³ã®ãŸã‚è³‡é‡‘ã‚’æ¸©å­˜ã€‚`);
                    setEnemy(unrestAdjusted);
                    return checkWinCondition(player, unrestAdjusted);
                }

                const aiCard = potentialActions[Math.floor(Math.random() * potentialActions.length)];
                const inflatedCost = calculateInflatedCost(aiCard.cost, unrestAdjusted.inflation);
                let afterPayment = { ...unrestAdjusted, money: unrestAdjusted.money - inflatedCost };
                const aiCardName = getLoc(aiCard, 'name', lang); // Use localized name for AI logs

                if (aiCard.type === 'ATTACK') {
                    const afterSupport = applySupportChange(afterPayment, aiCard.supportChange, 'ãƒ©ã‚¤ãƒãƒ«', lang === 'en' ? `"${aiCardName}" political impact` : `ã€Œ${aiCard.name}ã€ã®æ”¿æ²»çš„å½±éŸ¿`);

                    // Calc Player Impact
                    // Calculate impact on player immediately to check win condition and set state
                    const effected = aiCard.targetEffect ? aiCard.targetEffect(player, afterSupport) : player;
                    const unrested = applyUnrestPenalty(effected, 'ã‚ãªãŸ');
                    const finalPreEvent = applySupportChange(unrested, aiCard.targetSupportChange, 'ã‚ãªãŸ', lang === 'en' ? `"${aiCardName}" impact` : `ã€Œ${aiCard.name}ã€ã®å½±éŸ¿`);
                    const finalPlayer = applyEventMultiplier(player, finalPreEvent);

                    triggerShake('player'); // Shake player panel
                    addLog(lang === 'en' ? `RIVAL: Used "${aiCardName}"!` : `ãƒ©ã‚¤ãƒãƒ«: ã€Œ${aiCard.name}ã€ã‚’ä½¿ç”¨ï¼`);

                    setEnemy(afterSupport);
                    setPlayer(finalPlayer);

                    return checkWinCondition(finalPlayer, afterSupport);
                }

                const afterEffect = applyEventMultiplier(afterPayment, aiCard.effect(afterPayment, player));
                const afterInflation = applyInflationChange(afterEffect, aiCard.inflationChange);
                if (aiCard.inflationChange) {
                    addLog(lang === 'en' ? `RIVAL: "${aiCardName}" inflation impact` : `ãƒ©ã‚¤ãƒãƒ«: ã€Œ${aiCard.name}ã€ã§ç‰©ä¾¡ãŒå¤‰å‹• (${aiCard.inflationChange > 0 ? '+' : ''}${aiCard.inflationChange}%)`);
                }
                addLog(lang === 'en' ? `RIVAL: Used "${aiCardName}".` : `ãƒ©ã‚¤ãƒãƒ«: ã€Œ${aiCard.name}ã€ã‚’ä½¿ç”¨ã—æˆé•·ä¸­...`);
                const unrested = applyUnrestPenalty(afterInflation, 'ãƒ©ã‚¤ãƒãƒ«');
                const afterSupport = applySupportChange(unrested, aiCard.supportChange, 'ãƒ©ã‚¤ãƒãƒ«', lang === 'en' ? `"${aiCardName}" effect` : `ã€Œ${aiCard.name}ã€ã®åŠ¹æœ`);

                setEnemy(afterSupport);
                return checkWinCondition(player, afterSupport);
            };

            const checkWinCondition = (nextPlayer = player, nextEnemy = enemy) => {
                if (gameState !== 'PLAYING') return false;

                const target = currentDifficulty.targetGdp || 300;
                let won = false;
                let lost = false;
                let reason = '';

                if (nextPlayer.gdp >= target) {
                    won = true;
                    reason = lang === 'en' ? 'Economic Goal Achieved!' : 'çµŒæ¸ˆç›®æ¨™é”æˆï¼';
                } else if (nextEnemy.gdp >= target) {
                    lost = true;
                    reason = lang === 'en' ? 'Defeated by Rival...' : 'ãƒ©ã‚¤ãƒãƒ«å›½ã«æ•—åŒ—...';
                } else if (nextPlayer.support <= 0) {
                    lost = true;
                    reason = lang === 'en' ? 'Administration collapsed due to low support' : 'æ”¯æŒç‡ä½ä¸‹ã«ã‚ˆã‚Šæ”¿æ¨©å´©å£Š';
                } else if (nextEnemy.support <= 0) {
                    won = true;
                    reason = lang === 'en' ? 'Rival administration collapsed!' : 'ãƒ©ã‚¤ãƒãƒ«å›½ãŒè‡ªæ»…ï¼';
                }

                if (won || lost) {
                    const isWin = won;
                    setGameState(isWin ? 'WON' : 'LOST');
                    SoundManager.playGameEnd(isWin);
                    addLog(isWin ? `ğŸ‰ ${reason}` : `ğŸ’€ ${reason}`);

                    // Calculate Evaluation
                    const result = evaluateGame(nextPlayer, currentDifficulty, isWin, IDEOLOGIES[selectedIdeology], lang, completedMissionCount);
                    setEvaluation(result);

                    if (isWin) {
                        // Title check
                        if (result.rank === 'S') {
                            try {
                                const newTitles = { ...earnedTitles, [selectedIdeology]: true };
                                setEarnedTitles(newTitles);
                                localStorage.setItem('earnedTitles', JSON.stringify(newTitles));
                                const ideologyName = getLoc(IDEOLOGIES[selectedIdeology], 'name', lang);
                                const titleName = getLoc(IDEOLOGIES[selectedIdeology], 'title', lang);
                                addLog(`ğŸ† Title Unlocked: [${titleName}] (${ideologyName} S Rank)`);
                            } catch (e) {
                                console.error("Failed to save titles to localStorage", e);
                            }
                        }

                        // Progress Tracking (Ideology Unlocks)
                        if ((result.rank === 'S' || result.rank === 'A') && selectedIdeology === 'MONETARIST') {
                            const currentCount = gameProgress.monetarist_rank_a_count || 0;
                            const newCount = currentCount + 1;
                            const newProgress = { ...gameProgress, monetarist_rank_a_count: newCount };
                            setGameProgress(newProgress);
                            localStorage.setItem('economics_master_progress', JSON.stringify(newProgress));

                            // Notify if this action unlocked MMT
                             if (currentCount < 3 && newCount >= 3) {
                                addLog(`ğŸ”“ UNLOCKED: New Ideology [${getLoc(IDEOLOGIES.MMT, 'name', lang)}]!`);
                            }
                        }

                        // Achievement check
                        let newAchievementsFound = false;
                        const newAchievements = { ...unlockedAchievements };
                        for (const key in ACHIEVEMENTS) {
                            const achievement = ACHIEVEMENTS[key];
                            if (!newAchievements[achievement.id] && achievement.check(nextPlayer, isWin)) {
                                newAchievements[achievement.id] = true;
                                newAchievementsFound = true;
                                const achievementName = getLoc(achievement, 'name', lang);
                                addLog(`â­ Achievement Unlocked: [${achievementName}]`);
                            }
                        }
                        if (newAchievementsFound) {
                            try {
                                setUnlockedAchievements(newAchievements);
                                localStorage.setItem('unlockedAchievements', JSON.stringify(newAchievements));
                            } catch (e) {
                                console.error("Failed to save achievements to localStorage", e);
                            }
                        }
                    }

                    return true;
                }

                return false;
            };

            return (
                <div className={`min-h-screen text-slate-200 relative transition-colors duration-1000 ${era.bgClass}`}>
                    <BackgroundEffects />
                    {gameState === 'WON' && <Confetti />}
                    {showTurnSummary && <TurnSummaryPanel data={turnSummaryData} onContinue={proceedToNextTurn} lang={lang} />}
                    {showEncyclopedia && <CardEncyclopediaPanel onClose={() => setShowEncyclopedia(false)} lang={lang} discoveredCards={discoveredCards} />}
                    <SettingsModal
                        isOpen={showSettings}
                        onClose={() => setShowSettings(false)}
                        settings={{ lang, fontSizeLevel, skipTurnSummary, isMuted, volume: masterVolume }}
                        onChange={handleSettingsChange}
                        lang={lang}
                    />
                    <ComboOverlay message={comboMessage} show={!!comboMessage} />
                    <TurnOverlay turn={turn} show={showTurnOverlay} />
                    <CrisisOverlay message={crisisAlert?.message} show={!!crisisAlert} type={crisisAlert?.type} />

                    {/* Floating Text Overlay */}
                    {floatingTexts.map(ft => (
                        <div
                            key={ft.id}
                            className={`fixed pointer-events-none z-50 font-black ${ft.sizeClass || 'text-2xl'} animate-float-up ${ft.colorClass}`}
                            style={{
                                left: ft.x,
                                top: ft.y,
                                textShadow: ft.type === 'combo' ? 'none' : '0 2px 4px rgba(0,0,0,0.5)'
                            }}
                        >
                            {ft.text}
                        </div>
                    ))}

                    {/* TOP HEADER */}
                    <header className="bg-slate-900/80 backdrop-blur border-b border-slate-800 sticky top-0 z-[110]">
                        {/* Era Indicator Progress Bar */}
                        <div className="absolute top-0 left-0 h-1 bg-gradient-to-r from-cyan-500 via-purple-500 to-rose-500 transition-all duration-1000" style={{ width: `${(turn / 30) * 100}%`, opacity: 0.5 }}></div>

                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-cyan-600 to-blue-600 text-white p-2 rounded-lg shadow-lg shadow-cyan-500/20">
                                    <IconTrendingUp size={20} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-black text-white tracking-tighter leading-none">Economics Master</h1>
                                    <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Strategic Card Game</p>
                                </div>
                            </div>

                            <div className="flex items-center gap-4">
                                <div className="hidden md:flex items-center gap-3">
                                    <div className="flex items-center gap-2 bg-slate-800/50 px-3 py-1.5 rounded-full border border-slate-700/50">
                                        <span className="text-xs font-bold text-amber-400">{getLoc(era, 'name', lang)}</span>
                                    </div>
                                    <div className="flex items-center gap-2 bg-slate-800/50 px-3 py-1.5 rounded-full border border-slate-700/50">
                                        <span className="w-2 h-2 rounded-full bg-cyan-500 animate-pulse"></span>
                                        <span className="text-xs font-bold text-slate-300">{t('turn', lang)} {turn}</span>
                                    </div>
                                    <div className="text-xs font-bold text-slate-500">{t('goal', lang)}: GDP {currentDifficulty.targetGdp}T</div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={() => setShowSettings(true)}
                                        className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors active:scale-95"
                                        title={lang === 'en' ? "Settings" : "è¨­å®š"}
                                    >
                                        <IconSettings size={18} />
                                    </button>
                                    <button
                                        onClick={() => setIsMuted(!isMuted)}
                                        className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors active:scale-95"
                                    >
                                        {isMuted ? <IconVolumeX size={18} /> : <IconVolume2 size={18} />}
                                    </button>
                                    <button
                                        onClick={startGame}
                                        className="text-xs font-bold bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded-lg border border-slate-700 transition-all flex items-center gap-2 active:scale-95"
                                    >
                                        <IconRefreshCw size={14} />
                                        {gameState === 'START' ? t('start', lang) : t('reset', lang)}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">

                        {/* LEFT/CENTER COLUMN (Game Board) */}
                        <div className="lg:col-span-9 space-y-6">
                            
                            {/* 1. OPPONENT FIELD */}
                            <section>
                                <StatusPanel data={enemy} isEnemy={true} interest={getInterestForTurn(enemy)} isShaking={shake.enemy} lang={lang} />
                            </section>

                            {/* 2. MIDDLE ZONE (Deck, Event, Discard) */}
                            <section className="grid grid-cols-1 md:grid-cols-3 gap-4 min-h-[140px]">
                                {/* Discard Pile (Visual) */}
                                <div className="hidden md:flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-slate-800 bg-slate-900/30 p-4 relative group">
                                    <span className="text-xs font-bold text-slate-700 uppercase mb-2">{t('discard', lang)}</span>
                                    {lastPlayedCard ? (
                                         <div className="w-20 h-28 bg-slate-800 border border-slate-600 rounded-lg flex items-center justify-center shadow-lg relative transform group-hover:scale-110 transition-transform">
                                            <div className="text-[10px] text-center p-1">
                                                <div className="font-bold text-slate-300 mb-1 truncate">{getLoc(lastPlayedCard, 'name', lang)}</div>
                                                <div className="text-slate-500 text-[9px]">{t('label', lang)}</div>
                                            </div>
                                         </div>
                                    ) : (
                                        <div className="w-20 h-28 bg-transparent border border-slate-800 rounded-lg flex items-center justify-center opacity-30">
                                            <IconBookOpen size={20} />
                                        </div>
                                    )}
                                </div>

                                {/* Active Event (Center) */}
                                <div className="md:col-span-1">
                                    {activeEvent && gameState === 'PLAYING' ? (
                                        <div className="h-full bg-gradient-to-br from-amber-950/40 to-slate-900 border border-amber-900/50 p-4 rounded-xl flex flex-col justify-center relative overflow-hidden group">
                                            <div className="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity">
                                                <IconAlertCircle size={60} />
                                            </div>
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className="bg-amber-900/50 text-amber-500 text-[10px] font-black px-2 py-0.5 rounded uppercase tracking-wider border border-amber-900">Event</span>
                                            </div>
                                            <h3 className="font-bold text-amber-500 text-lg leading-tight mb-1">{getLoc(activeEvent, 'name', lang)}</h3>
                                            <p className="text-xs text-amber-200/70 leading-relaxed">{getLoc(activeEvent, 'description', lang)}</p>
                                        </div>
                                    ) : (
                                        <div className="h-full flex items-center justify-center text-slate-700 text-xs font-bold uppercase tracking-widest border border-slate-800 rounded-xl bg-slate-900/50">
                                            No Active Event
                                        </div>
                                    )}
                                </div>

                                {/* Deck (Visual) */}
                                <div className="hidden md:flex flex-col items-center justify-center rounded-xl border border-slate-800 bg-slate-900/50 p-4">
                                     <div className={`relative w-24 h-32 transition-transform ${gameDeck.length === 0 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer hover:-translate-y-1'}`}>
                                        {/* Card Stack Effect */}
                                        <div className="absolute inset-0 bg-slate-800 rounded-lg border border-slate-700 translate-x-2 translate-y-2"></div>
                                        <div className="absolute inset-0 bg-slate-800 rounded-lg border border-slate-700 translate-x-1 translate-y-1"></div>
                                        <div className="absolute inset-0 bg-gradient-to-br from-slate-700 to-slate-800 rounded-lg border border-slate-600 flex items-center justify-center shadow-2xl">
                                            <div className="text-center">
                                                <IconTrendingUp className="text-cyan-900 mb-1 mx-auto" size={24} />
                                                <span className="text-[10px] font-bold text-cyan-900 uppercase tracking-widest">{t('deck', lang)}</span>
                                            </div>
                                        </div>
                                     </div>
                                     <div className="mt-3 text-center space-y-1">
                                        <div className="text-xs font-bold text-slate-400 uppercase tracking-wider">{t('deck', lang)}</div>
                                        <div className={`text-sm font-black ${gameDeck.length === 0 ? 'text-rose-400' : 'text-cyan-400'}`}>
                                            {gameDeck.length}{lang === 'en' ? ' cards' : 'æš'}
                                        </div>
                                        {gameDeck.length === 0 && (
                                            <div className="text-[10px] text-rose-300">{lang === 'en' ? 'No cards to draw' : 'ãƒ‰ãƒ­ãƒ¼ä¸å¯'}</div>
                                        )}
                                     </div>
                                </div>
                            </section>

                            {/* 3. PLAYER FIELD */}
                            <section>
                                <StatusPanel data={player} isEnemy={false} interest={getInterestForTurn(player)} isShaking={shake.player} lang={lang} />
                            </section>

                            {/* 4. HAND AREA */}
                            <section className="bg-slate-900/50 rounded-2xl border border-slate-800 p-4 md:p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                        <IconWallet size={16} /> {t('yourHand', lang)}
                                    </h3>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={(e) => issueBonds(e)}
                                            disabled={gameState !== 'PLAYING'}
                                            className="bg-amber-700/20 text-amber-500 border border-amber-900/50 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-amber-700/40 transition-all disabled:opacity-50 flex items-center gap-1.5 active:scale-95"
                                        >
                                            <span className="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
                                            {t('bond', lang)}
                                        </button>
                                        <button
                                            onClick={(e) => repayDebt(e)}
                                            disabled={gameState !== 'PLAYING' || player.money < 50 || (player.debt || 0) <= 0}
                                            className="bg-emerald-700/20 text-emerald-500 border border-emerald-900/50 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-emerald-700/40 transition-all disabled:opacity-50 flex items-center gap-1.5 active:scale-95"
                                        >
                                            <span className="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                            {lang === 'en' ? 'Repay' : 'å„Ÿé‚„'}
                                        </button>
                                        <button
                                            onClick={endTurn}
                                            disabled={gameState !== 'PLAYING'}
                                            className="bg-cyan-600 text-white px-5 py-1.5 rounded-lg text-xs font-bold hover:bg-cyan-500 hover:shadow-lg hover:shadow-cyan-500/20 transition-all disabled:opacity-50 flex items-center gap-2 active:scale-95"
                                        >
                                            {t('endTurn', lang)} <IconArrowRight size={14} />
                                        </button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                    {playerHand.map((card) => {
                                        const typeInfo = CARD_TYPES[card.type];
                                        const inflatedCost = calculateInflatedCost(card.cost, player.inflation);
                                        const canAfford = player.money >= inflatedCost;
                                        const comboReadyTags = (card.combosWith ?? []).filter(tag => lastTags.includes(tag));
                                        const providesTags = getCardProvidedTags(card);
                                        const successRate = calculateSuccessRate(card, player.support);
                                        const isRisky = successRate < 100;

                                        return (
                                            <button
                                                key={card.uniqueId}
                                                onClick={(e) => playCard(card, e)}
                                                 onMouseEnter={() => setHoveredCard(card)}
                                                 onMouseLeave={() => setHoveredCard(null)}
                                                disabled={!canAfford || gameState !== 'PLAYING'}
                                                className={`
                                                    relative text-left group
                                                    flex flex-col h-full rounded-xl border-2 transition-all duration-500 ease-out overflow-hidden
                                                    ${typeInfo.baseStyle}
                                                    ${canAfford
                                                        ? 'cursor-pointer hover:-translate-y-2 hover:shadow-2xl hover:scale-[1.02]'
                                                        : 'opacity-40 cursor-not-allowed grayscale border-slate-700 bg-slate-900'}
                                                    ${comboReadyTags.length > 0 && canAfford ? 'ring-2 ring-amber-400 shadow-[0_0_30px_rgba(251,191,36,0.4)] border-amber-400 z-10 animate-pulse-glow' : ''}
                                                `}
                                                style={{
                                                    transformStyle: 'preserve-3d',
                                                    perspective: '1000px'
                                                }}
                                            >
                                                {comboReadyTags.length > 0 && canAfford && (
                                                    <div className="absolute -top-3 -right-2 bg-gradient-to-r from-yellow-400 to-orange-500 text-white text-[10px] font-black px-2 py-0.5 rounded-full shadow-lg z-20 animate-bounce">
                                                        âš¡ COMBO READY
                                                    </div>
                                                )}

                                                {/* Header */}
                                                <div className={`px-3 py-2 flex justify-between items-center ${typeInfo.headerStyle}`}>
                                                    <span className="text-[10px] font-black uppercase tracking-wider flex items-center gap-1">
                                                        {typeInfo.icon} {typeInfo.label}
                                                    </span>
                                                    <span className="font-mono text-lg font-black tracking-tighter">Â¥{inflatedCost}</span>
                                                </div>

                                                {/* Body */}
                                                <div className="p-3 flex flex-col flex-grow bg-slate-900/40 backdrop-blur-sm">
                                                    <h4 className="font-bold text-slate-200 text-sm mb-1.5 min-h-[2.5em] flex items-center leading-snug">
                                                        {getLoc(card, 'name', lang)}
                                                    </h4>

                                                    <p className="text-xs text-slate-400 mb-3 flex-grow leading-relaxed line-clamp-3">
                                                        {getLoc(card, 'description', lang)}
                                                    </p>

                                                    <div className="space-y-1">
                                                         {/* Cost Info */}
                                                        {inflatedCost !== card.cost && (
                                                            <div className="text-[10px] text-amber-500 bg-amber-950/30 px-1.5 py-0.5 rounded border border-amber-900/50 flex items-center gap-1 w-max">
                                                                <IconAlertCircle size={8} />
                                                                {t('cost', lang)}: {card.cost}â†’{inflatedCost}
                                                            </div>
                                                        )}

                                                        {/* Success Rate Info (Only if risky or varied) */}
                                                        <div className={`text-[10px] px-1.5 py-0.5 rounded border flex items-center gap-1 w-max ${
                                                            isRisky
                                                                ? successRate < 70 ? 'text-red-400 bg-red-950/30 border-red-900/50' : 'text-orange-400 bg-orange-950/30 border-orange-900/50'
                                                                : 'text-emerald-400 bg-emerald-950/30 border-emerald-900/50'
                                                        }`}>
                                                            {isRisky && <IconAlertCircle size={8} />}
                                                            {t('successRate', lang)}: {successRate}%
                                                        </div>

                                                        {/* Tags */}
                                                        {(comboReadyTags.length > 0 || providesTags.length > 0) && (
                                                            <div className="flex flex-wrap gap-1 mt-auto pt-2">
                                                                {comboReadyTags.map(tag => (
                                                                     <span key={tag} className="bg-gradient-to-r from-amber-500/20 to-rose-500/20 text-amber-200 border border-amber-500/50 px-2 py-0.5 rounded-full text-[10px] font-black tracking-wide shadow-[0_0_10px_rgba(245,158,11,0.2)] animate-pulse">
                                                                        â˜… COMBO: {tag}
                                                                     </span>
                                                                ))}
                                                                {providesTags.map(tag => (
                                                                     <span key={tag} className="bg-slate-800/80 text-cyan-200/80 border border-cyan-800/50 px-2 py-0.5 rounded-full text-[10px] font-bold tracking-wide">
                                                                        #{tag}
                                                                     </span>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </button>
                                        );
                                    })}
                                    {playerHand.length === 0 && (
                                        <div className="col-span-full py-8 flex flex-col items-center justify-center text-slate-600 border-2 border-dashed border-slate-800 rounded-xl">
                                            <IconBookOpen className="mb-2 opacity-50" size={24} />
                                            <p className="text-xs font-medium">{t('noCards', lang)}</p>
                                        </div>
                                    )}
                                </div>
                            </section>
                        </div>

                        {/* RIGHT COLUMN: LOGS & INFO */}
                        <div className="lg:col-span-3 space-y-6">

                            {/* Ideology Mission Panel */}
                            {gameState === 'PLAYING' && <IdeologyMissionPanel ideology={IDEOLOGIES[selectedIdeology]} lang={lang} />}

                            {/* Mission Panel */}
                            <MissionPanel activeMission={activeMission} lang={lang} />

                            {/* Card Info Panel */}
                            <CardInfoPanel card={hoveredCard || lastPlayedCard} lang={lang} />

                            {/* Game Log Component */}
                            <div className="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden flex flex-col h-[250px] shadow-lg shadow-black/20">
                                <div className="bg-slate-800/50 p-3 border-b border-slate-800 flex justify-between items-center">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                        <IconRefreshCw size={12} /> {t('log', lang)}
                                    </h3>
                                    <span className="text-[10px] text-slate-600 font-mono">{t('live', lang)}</span>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-slate-900">
                                    {logs.map((log, i) => (
                                        <div key={i} className="text-xs leading-relaxed animate-fade-in">
                                            <div className="flex gap-2 text-slate-400">
                                                <span className="text-cyan-700 mt-0.5 select-none text-[8px]">â—</span>
                                                <span className={`${i===0 ? 'text-slate-200 font-medium' : ''}`}>{log}</span>
                                            </div>
                                            {i === 0 && <div className="mt-2 h-px bg-gradient-to-r from-cyan-900/50 to-transparent"></div>}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Combo Guide */}
                            <ComboGuidePanel lang={lang} />

                            {/* TITLE SCREEN */}
                            {gameState === 'TITLE' && (
                                <div className="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center p-4">
                                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                                    <div className="z-10 text-center space-y-8 animate-fade-in">
                                        <div className="mb-4">
                                            <div className="inline-block p-6 rounded-3xl bg-gradient-to-br from-cyan-500 to-blue-600 shadow-[0_0_50px_rgba(6,182,212,0.4)] mb-6">
                                                <IconTrendingUp size={64} className="text-white" />
                                            </div>
                                            <h1 className="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-cyan-200 to-blue-200 tracking-tighter drop-shadow-lg mb-4">
                                                {t('title', lang)}
                                            </h1>
                                            <p className="text-xl md:text-2xl text-slate-400 font-bold tracking-widest uppercase">
                                                {t('subtitle', lang)}
                                            </p>
                                        </div>

                                        <button
                                            onClick={() => setGameState('SETUP')}
                                            className="group relative px-12 py-6 bg-slate-800 hover:bg-cyan-950 border-2 border-slate-700 hover:border-cyan-500 rounded-2xl transition-all duration-300 hover:scale-105 active:scale-95 shadow-2xl"
                                        >
                                            <div className="absolute inset-0 bg-cyan-500/10 opacity-0 group-hover:opacity-100 transition-opacity rounded-xl"></div>
                                            <span className="text-2xl font-black text-white tracking-widest group-hover:text-cyan-400 flex items-center gap-3">
                                                <IconZap className="animate-pulse" /> {t('start', lang).toUpperCase()}
                                            </span>
                                        </button>

                                        <div className="text-slate-600 text-sm font-mono">Ver 1.0.0</div>

                                        <button
                                            onClick={() => setShowSettings(true)}
                                            className="absolute top-4 right-4 p-3 text-slate-500 hover:text-white hover:bg-slate-800 rounded-full transition-colors"
                                        >
                                            <IconSettings size={24} />
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* SETUP SCREEN (Old Start Screen) */}
                            {gameState === 'SETUP' && (
                                <div className="fixed inset-0 z-[100] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4">
                                    <div className="bg-slate-800/80 border border-slate-700/50 p-8 rounded-3xl shadow-2xl max-w-lg w-full text-center relative overflow-y-auto max-h-[90vh] backdrop-blur-md">
                                        <div className="sticky top-0 left-0 w-full h-1.5 bg-gradient-to-r from-cyan-500 via-purple-500 to-rose-500 z-10 -mt-8 -mx-8 mb-6 w-[calc(100%+4rem)]"></div>
                                        <div className="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent pointer-events-none"></div>

                                        <div className="bg-slate-900 p-5 rounded-3xl mb-6 border border-slate-700 shadow-[0_0_30px_rgba(6,182,212,0.3)] inline-flex ring-1 ring-cyan-500/20">
                                            <IconTrendingUp size={48} className="text-cyan-400" />
                                        </div>

                                        <h2 className="text-4xl font-black text-white mb-2 tracking-tighter drop-shadow-lg">{t('title', lang)}</h2>
                                        <p className="text-slate-400 mb-8 font-medium text-lg tracking-wide">{t('subtitle', lang)}</p>

                                        {/* Achievements Display */}
                                        <div className="mb-8 text-center">
                                            <div className="text-xs font-bold text-slate-500 uppercase mb-3 tracking-wider">Achievements</div>
                                            <div className="flex justify-center items-center gap-3 p-2 bg-slate-900/50 rounded-xl border border-slate-700/50 min-h-[50px]">
                                                {Object.values(ACHIEVEMENTS).map(ach => {
                                                    const isUnlocked = unlockedAchievements[ach.id];
                                                    const Icon = ach.icon;
                                                    return (
                                                        <div key={ach.id} data-testid={isUnlocked ? `achievement-${ach.id}-unlocked` : `achievement-${ach.id}-locked`} className={`relative group p-2 rounded-full transition-all duration-300 ${isUnlocked ? 'bg-yellow-400/10 border-yellow-400/30' : 'bg-slate-800 border-slate-700'}`}>
                                                            <Icon size={20} className={isUnlocked ? 'text-yellow-400' : 'text-slate-600'} />
                                                            <div className="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-48 bg-slate-900 border border-slate-700 p-2 rounded-lg text-xs text-left opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                                                <div className="font-bold text-yellow-300">{getLoc(ach, 'name', lang)}</div>
                                                                <div className="text-slate-400">{getLoc(ach, 'description', lang)}</div>
                                                                {!isUnlocked && <div className="text-center mt-1 text-[10px] text-rose-400">[LOCKED]</div>}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        {/* Progress Bar */}
                                        <div className="mb-8">
                                            <div className="flex justify-between items-center mb-1 text-xs">
                                                <span className="font-bold text-slate-400">çµŒæ¸ˆãƒã‚¹ã‚¿ãƒ¼åº¦</span>
                                                <span className="font-mono text-cyan-400">{`${Math.round((Object.keys(unlockedAchievements).length / Object.keys(ACHIEVEMENTS).length) * 100)}%`}</span>
                                            </div>
                                            <div className="w-full bg-slate-900 rounded-full h-2 border border-slate-700">
                                                <div className="bg-cyan-500 h-full rounded-full" style={{ width: `${(Object.keys(unlockedAchievements).length / Object.keys(ACHIEVEMENTS).length) * 100}%` }}></div>
                                            </div>
                                        </div>

                                        {/* Ideology Selector */}
                                        <div className="mb-8 text-left">
                                            <div className="text-xs font-bold text-slate-500 uppercase mb-3 tracking-wider">{t('selectPlaystyle', lang)}</div>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                                                {Object.values(IDEOLOGIES).map(ideology => {
                                                    const isLocked = ideology.unlockCondition && !ideology.unlockCondition(gameProgress);

                                                    if (isLocked) {
                                                        return (
                                                             <div key={ideology.id} className="p-3 rounded-xl border-2 border-slate-800 bg-slate-900/50 text-slate-600 relative overflow-hidden h-full flex flex-col justify-center items-center text-center opacity-70 hover:opacity-100 transition-opacity">
                                                                <IconLock size={24} className="mb-2 opacity-50" />
                                                                <div className="font-bold text-sm mb-1">{t('unknown', lang)}</div>
                                                                <div className="text-[10px] bg-slate-800 px-2 py-1 rounded border border-slate-700">
                                                                    {getLoc(ideology, 'unlockHint', lang)}
                                                                </div>
                                                             </div>
                                                        );
                                                    }

                                                    const isSelected = selectedIdeology === ideology.id;
                                                    const feats = getLoc(ideology, 'features', lang);
                                                    const isEarned = earnedTitles[ideology.id];
                                                    return (
                                                        <button
                                                            key={ideology.id}
                                                            onClick={() => setSelectedIdeology(ideology.id)}
                                                            className={`
                                                                p-3 rounded-xl border-2 transition-all duration-200 text-left relative overflow-hidden group h-full
                                                                ${isSelected
                                                                    ? 'border-indigo-500 bg-indigo-950/50 text-white shadow-lg shadow-indigo-900/20 scale-[1.02] z-10'
                                                                    : 'border-slate-700 bg-slate-800/50 text-slate-400 hover:border-slate-600 hover:bg-slate-800'}
                                                            `}
                                                        >
                                                            {isSelected && <div className="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>}

                                                            {isEarned && (
                                                                <div className="absolute top-2 right-2 flex items-center gap-1 bg-yellow-400/10 text-yellow-400 px-1.5 py-0.5 rounded-full text-[8px] font-bold border border-yellow-400/20">
                                                                    <IconAward size={10} /> S-RANK
                                                                </div>
                                                            )}

                                                            <div className="font-bold text-sm mb-0.5">{getLoc(ideology, 'name', lang)}</div>
                                                            <div className="text-[10px] font-bold opacity-70 mb-2 text-indigo-300">{getLoc(ideology, 'label', lang)}</div>
                                                            <div className="text-[10px] opacity-60 leading-tight mb-2">{getLoc(ideology, 'description', lang)}</div>
                                                            <div className="flex flex-wrap gap-1">
                                                                {feats.map((f, i) => (
                                                                    <span key={i} className="text-[9px] px-1.5 py-0.5 rounded bg-black/20 text-slate-300">{f}</span>
                                                                ))}
                                                            </div>
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        {/* Difficulty Selector */}
                                        {/* Encyclopedia Button (Integrated) */}
                                        <div className="mb-8">
                                            <button
                                                onClick={() => setShowEncyclopedia(true)}
                                                className="w-full bg-slate-800 hover:bg-slate-700 border border-slate-600 hover:border-cyan-500 text-slate-300 hover:text-cyan-400 p-3 rounded-xl transition-all flex items-center justify-center gap-3 group active:scale-95 shadow-lg shadow-black/20"
                                            >
                                                <div className="p-1.5 bg-slate-900 rounded-lg group-hover:bg-cyan-950/50 transition-colors">
                                                    <IconBookOpen size={20} className="text-slate-500 group-hover:text-cyan-400 transition-colors" />
                                                </div>
                                                <div className="text-left">
                                                    <div className="text-sm font-bold">{t('encyclopedia', lang)}</div>
                                                    <div className="text-[10px] text-slate-500 group-hover:text-slate-400">
                                                        {t('collectionProgress', lang)}: {Object.keys(discoveredCards).length} / {ALL_CARDS.length}
                                                    </div>
                                                </div>
                                            </button>
                                        </div>

                                        <div className="mb-8 text-left">
                                            <div className="text-xs font-bold text-slate-500 uppercase mb-3 tracking-wider">{t('selectDifficulty', lang)}</div>
                                            <div className="grid grid-cols-3 gap-3 mb-4">
                                                {Object.values(DIFFICULTY_SETTINGS).map(diff => {
                                                    const isSelected = selectedDifficulty === diff.id;
                                                    return (
                                                        <button
                                                            key={diff.id}
                                                            onClick={() => setSelectedDifficulty(diff.id)}
                                                            className={`
                                                                p-3 rounded-xl border-2 transition-all duration-200 text-center relative overflow-hidden
                                                                ${isSelected
                                                                    ? 'border-cyan-500 bg-cyan-950/50 text-white shadow-lg shadow-cyan-900/20 scale-105 z-10'
                                                                    : 'border-slate-700 bg-slate-800/50 text-slate-400 hover:border-slate-600 hover:bg-slate-800'}
                                                            `}
                                                        >
                                                            {isSelected && <div className="absolute top-0 left-0 w-full h-1 bg-cyan-500"></div>}
                                                            <div className="font-bold text-sm mb-0.5">{getLoc(diff, 'label', lang)}</div>
                                                            <div className="text-[10px] opacity-70">GDP {diff.targetGdp}T</div>
                                                        </button>
                                                    );
                                                })}
                                            </div>

                                            <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700/50 min-h-[80px] flex items-center">
                                                <div>
                                                    <span className="text-xs font-bold text-cyan-400 block mb-1">
                                                        {getLoc(DIFFICULTY_SETTINGS[selectedDifficulty], 'label', lang)} Mode
                                                    </span>
                                                    <p className="text-xs text-slate-300 leading-relaxed">
                                                        {getLoc(DIFFICULTY_SETTINGS[selectedDifficulty], 'description', lang)}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="mb-4 flex items-center justify-center gap-3">
                                            <button
                                                onClick={() => setSkipTurnSummary(!skipTurnSummary)}
                                                className={`flex items-center gap-2 px-4 py-2 rounded-lg border transition-all ${skipTurnSummary ? 'bg-cyan-900/30 border-cyan-500 text-cyan-400' : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-600'}`}
                                            >
                                                <div className={`w-5 h-5 rounded border flex items-center justify-center ${skipTurnSummary ? 'bg-cyan-500 border-cyan-500' : 'border-slate-600'}`}>
                                                    {skipTurnSummary && <IconZap size={12} className="text-white" />}
                                                </div>
                                                <span className="text-xs font-bold">
                                                    {lang === 'en' ? 'Skip Turn Summary' : 'ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã®ã¾ã¨ã‚ã‚’ã‚¹ã‚­ãƒƒãƒ—'}
                                                </span>
                                            </button>
                                        </div>

                                        <button
                                            onClick={startGame}
                                             className="w-full py-4 bg-gradient-to-r from-cyan-500 via-blue-500 to-indigo-600 text-white rounded-xl font-black text-xl shadow-lg shadow-cyan-500/30 hover:shadow-cyan-500/50 hover:scale-[1.02] transition-all active:scale-95 relative overflow-hidden group"
                                        >
                                             <div className="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                                             <span className="relative z-10 flex items-center justify-center gap-2">
                                                 <IconZap size={24} className="animate-pulse" /> {t('startGame', lang)}
                                             </span>
                                        </button>

                                        <div className="mt-4">
                                            <button
                                                onClick={() => setGameState('TITLE')}
                                                className="text-slate-500 hover:text-white text-xs font-bold underline decoration-slate-600 hover:decoration-white transition-all"
                                            >
                                                {lang === 'en' ? 'Back to Title' : 'ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* WIN/LOSS OVERLAY (REPORT CARD) */}
                            {(gameState === 'WON' || gameState === 'LOST') && evaluation && (
                                <div className="fixed inset-0 z-[100] bg-slate-900/95 backdrop-blur-md flex items-center justify-center p-4">
                                     <div className={`relative p-8 rounded-3xl shadow-2xl max-w-lg w-full border-4 overflow-hidden ${gameState === 'WON' ? 'bg-slate-800 border-cyan-500 shadow-cyan-900/50' : 'bg-slate-800 border-rose-900 shadow-rose-900/50'}`}>

                                        {/* Background Effect */}
                                        <div className="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-black/20 to-transparent pointer-events-none"></div>

                                        {/* Header */}
                                        <div className="text-center mb-6 relative z-10">
                                            <div className="text-xs font-bold uppercase tracking-[0.2em] text-slate-500 mb-2">{t('resultReport', lang)}</div>
                                            <h2 className={`text-5xl font-black tracking-tighter mb-2 ${gameState === 'WON' ? 'text-white' : 'text-rose-500'}`}>
                                                {gameState === 'WON' ? t('victory', lang) : t('defeat', lang)}
                                            </h2>
                                            <div className={`text-sm font-bold px-4 py-1 rounded-full inline-block ${gameState === 'WON' ? 'bg-cyan-950 text-cyan-400' : 'bg-rose-950 text-rose-400'}`}>
                                                {gameState === 'WON' ? t('victoryDesc', lang) : t('defeatDesc', lang)}
                                            </div>
                                        </div>

                                        {/* Rank Circle */}
                                        <div className="flex justify-center mb-8 relative z-10">
                                            <div className="relative w-32 h-32 flex items-center justify-center">
                                                <div className={`absolute inset-0 rounded-full border-4 border-dashed animate-spin-slow opacity-30 ${evaluation.rank === 'S' ? 'border-yellow-500' : 'border-slate-600'}`} style={{ animationDuration: '10s' }}></div>
                                                <div className={`text-8xl font-black ${evaluation.rankColor} drop-shadow-2xl transform scale-110`}>
                                                    {evaluation.rank}
                                                </div>
                                                <div className={`absolute -bottom-4 bg-slate-900 border border-slate-700 px-3 py-1 rounded-lg text-xs font-bold tracking-widest ${evaluation.rankColor}`}>
                                                    {evaluation.rankLabel}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Stats Grid */}
                                        <div className="bg-slate-900/50 rounded-xl border border-slate-700/50 p-4 mb-6 grid grid-cols-2 gap-4 relative z-10">
                                            {evaluation.stats.map((stat, i) => (
                                                <div key={i} className="flex flex-col">
                                                    <span className="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">{stat.label}</span>
                                                    <div className="flex items-baseline gap-2">
                                                        <span className="text-lg font-bold text-slate-200">{stat.value}</span>
                                                        {stat.note && <span className={`text-[10px] font-bold ${stat.note.includes('SåŸºæº–') || stat.note === 'ç†æƒ³çš„' || stat.note === 'é«˜æ”¯æŒ' ? 'text-emerald-400' : 'text-amber-400'}`}>{stat.note}</span>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        {/* Advice Box */}
                                        <div className="bg-indigo-900/20 border border-indigo-500/30 rounded-xl p-4 mb-8 text-left relative z-10">
                                            <div className="flex items-center gap-2 mb-2">
                                                <IconZap size={14} className="text-indigo-400" />
                                                <span className="text-xs font-bold text-indigo-300 uppercase tracking-wider">{t('nextGoal', lang)}</span>
                                            </div>
                                            <p className="text-sm text-indigo-100 leading-relaxed font-medium">
                                                {evaluation.nextGoal}
                                            </p>
                                        </div>

                                        <button
                                            onClick={startGame}
                                            className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg transition-all hover:scale-[1.02] active:scale-95 ${gameState === 'WON' ? 'bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-cyan-900/20' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                                        >
                                            {t('playAgain', lang)}
                                        </button>
                                    </div>
                                </div>
                            )}

                        </div>
                    </main>
                </div>
            );
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EconomicCardGame />);
    </script>
</body>
</html>
