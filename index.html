<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>エコノミクス・マスター - 経済学カードゲーム</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS (デザイン用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans JP"', 'sans-serif'],
                        mono: ['"Noto Sans JP"', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#06b6d4', // Cyan 500
                            600: '#0891b2', // Cyan 600
                            700: '#0e7490', // Cyan 700
                            900: '#164e63', // Cyan 900
                        },
                        dark: {
                            900: '#0f172a', // Slate 900
                            800: '#1e293b', // Slate 800
                            700: '#334155', // Slate 700
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM (フレームワーク) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (JSXをブラウザで実行するためのコンパイラ) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* アニメーション定義 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes floatUp {
            0% { transform: translate(-50%, 0) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -40px) scale(1.2); opacity: 0; }
        }
        .animate-float-up {
            animation: floatUp 1.2s ease-out forwards;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        .animate-shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in-right {
            animation: slideInRight 0.5s ease-out forwards;
        }

        @keyframes flashRed {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(220, 38, 38, 0.3); }
        }
        .animate-flash-red {
            animation: flashRed 0.5s ease-in-out 3;
        }

        body {
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
            min-height: 100vh;
        }

        /* Scrollbar customization */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="antialiased selection:bg-brand-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Sound Manager (Web Audio API) ---
        const SoundManager = {
            ctx: null,
            isMuted: false,

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },

            playTone(freq, type, duration, vol = 0.1) {
                if (this.isMuted) return;
                try {
                    this.init();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                    gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + duration);
                } catch (e) {
                    console.error("Audio error:", e);
                }
            },

            playClick() {
                this.playTone(800, 'sine', 0.1, 0.05);
            },

            playError() {
                if (this.isMuted) return;
                try {
                    this.init();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, this.ctx.currentTime);
                    osc.frequency.linearRampToValueAtTime(100, this.ctx.currentTime + 0.3);
                    gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + 0.3);
                } catch (e) {
                    console.error(e);
                }
            },

            playSuccess() {
                this.playTone(1200, 'sine', 0.2, 0.1);
                setTimeout(() => this.playTone(1800, 'sine', 0.4, 0.1), 100);
            },

            playCard(type) {
                if (this.isMuted) return;
                if (type === 'ATTACK') {
                    this.playTone(300, 'square', 0.3, 0.05);
                } else if (type === 'POLICY') {
                    this.playTone(600, 'sine', 0.3, 0.05);
                } else {
                    // PRODUCTION
                    this.playTone(400, 'triangle', 0.1, 0.05);
                    setTimeout(() => this.playTone(600, 'triangle', 0.2, 0.05), 100);
                }
            },

            playGameEnd(win) {
                if (this.isMuted) return;
                if (win) {
                    this.playTone(523.25, 'triangle', 0.2, 0.1); // C5
                    setTimeout(() => this.playTone(659.25, 'triangle', 0.2, 0.1), 200); // E5
                    setTimeout(() => this.playTone(783.99, 'triangle', 0.4, 0.1), 400); // G5
                    setTimeout(() => this.playTone(1046.50, 'triangle', 0.8, 0.1), 600); // C6
                } else {
                    this.playTone(300, 'sawtooth', 0.4, 0.1);
                    setTimeout(() => this.playTone(250, 'sawtooth', 0.4, 0.1), 300);
                    setTimeout(() => this.playTone(200, 'sawtooth', 0.8, 0.1), 600);
                }
            },

            playCrisis() {
                if (this.isMuted) return;
                try {
                    this.init();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'sawtooth';
                    // Siren effect
                    osc.frequency.setValueAtTime(400, this.ctx.currentTime);
                    osc.frequency.linearRampToValueAtTime(600, this.ctx.currentTime + 0.5);
                    osc.frequency.linearRampToValueAtTime(400, this.ctx.currentTime + 1.0);

                    gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 1.0);

                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + 1.0);
                } catch (e) { console.error(e); }
            },

            playDoom() {
                 if (this.isMuted) return;
                try {
                    this.init();
                    // Low rumble
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    const filter = this.ctx.createBiquadFilter();

                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(50, this.ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(30, this.ctx.currentTime + 2.0);

                    filter.type = 'lowpass';
                    filter.frequency.value = 200;

                    gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 2.0);

                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + 2.0);
                } catch (e) { console.error(e); }
            }
        };

        // --- アイコンコンポーネント (SVG埋め込み) ---
        // GitHub Pages等で外部ライブラリ依存によるエラーを防ぐためSVGを直接定義
        const IconWallet = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>
        );
        const IconTrendingUp = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
        );
        const IconZap = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        );
        const IconShield = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        );
        const IconAlertCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        );
        const IconArrowRight = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        );
        const IconRefreshCw = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
        );
        const IconBookOpen = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        );
        const IconVolume2 = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
        );
        const IconVolumeX = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
        );

        const IconGlobe = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
        );

        // --- Localization Helpers ---
        const UI_TEXT = {
            ja: {
                title: "エコノミクス・マスター",
                subtitle: "経済学カードゲーム",
                turn: "TURN",
                goal: "目標",
                start: "Start",
                reset: "Reset",
                startGame: "ゲーム開始",
                playAgain: "もう一度プレイ",
                victory: "VICTORY",
                defeat: "GAME OVER",
                victoryDesc: "経済目標達成",
                defeatDesc: "政権崩壊 / 経済敗北",
                resultReport: "Result Report",
                nextGoal: "Next Goal",
                comboGuide: "Combo Guide (コンボ図鑑)",
                comboHint: "★ ヒント",
                comboHintDesc: "直前にプレイしたカードのタグと噛み合うと<br/>効果が1.3倍になります！",
                cardInfo: "カード解説",
                cardInfoDesc: "カードにカーソルを合わせると<br/>詳しい解説が表示されます",
                memo: "経済メモ",
                detail: "効果詳細",
                myCountry: "自国 (あなた)",
                rivalCountry: "ライバル国",
                gdp: "GDP",
                money: "資金残高",
                income: "収支",
                interest: "利払",
                support: "国民支持率",
                debt: "債務残高",
                inflation: "インフレ",
                trillion: "兆",
                selectPlaystyle: "Select Playstyle (思想・派閥)",
                selectDifficulty: "Select Difficulty",
                yourHand: "Your Hand",
                bond: "国債発行",
                endTurn: "ターン終了",
                discard: "Discard / Last Played",
                deck: "DECK",
                noCards: "No cards available",
                log: "Game Log",
                live: "LIVE",
                cost: "Cost",
                successRate: "成功率",
                cardTypeProd: "生産",
                cardTypePolicy: "政策",
                cardTypeAttack: "外交",
                tagInfra: "インフラ",
                tagInfraDesc: "「設備投資」や「公共事業」で付与。生産系カードの効果を高めます。",
                tagEdu: "教育・人材",
                tagEduDesc: "「人材育成」で付与。技術系カードの土台となります。",
                tagInno: "イノベーション",
                tagInnoDesc: "「技術革新」で付与。次の技術投資を大きくブーストします。",
                tagTech: "先端技術",
                tagTechDesc: "スタートアップ等。IT革命期に効果が倍増する強力なタグ。",
            },
            en: {
                title: "Economics Master",
                subtitle: "Strategic Card Game",
                turn: "TURN",
                goal: "GOAL",
                start: "Start",
                reset: "Reset",
                startGame: "START GAME",
                playAgain: "Play Again",
                victory: "VICTORY",
                defeat: "GAME OVER",
                victoryDesc: "Economic Goal Achieved",
                defeatDesc: "Administration Collapse / Defeat",
                resultReport: "Result Report",
                nextGoal: "Next Goal",
                comboGuide: "Combo Guide",
                comboHint: "★ Hint",
                comboHintDesc: "Match tags with the last played card<br/>for a 1.3x Effect Bonus!",
                cardInfo: "Card Info",
                cardInfoDesc: "Hover over a card to see<br/>detailed information.",
                memo: "Econ Memo",
                detail: "Effect Details",
                myCountry: "My Country (YOU)",
                rivalCountry: "Rival Country",
                gdp: "GDP",
                money: "Funds",
                income: "Income",
                interest: "Interest",
                support: "Support",
                debt: "Debt",
                inflation: "Inflation",
                trillion: "T",
                selectPlaystyle: "Select Playstyle",
                selectDifficulty: "Select Difficulty",
                yourHand: "Your Hand",
                bond: "Issue Bonds",
                endTurn: "End Turn",
                discard: "Discard / Last Played",
                deck: "DECK",
                noCards: "No cards available",
                log: "Game Log",
                live: "LIVE",
                cost: "Cost",
                successRate: "Success",
                cardTypeProd: "PROD",
                cardTypePolicy: "POLICY",
                cardTypeAttack: "DIPLO",
                tagInfra: "Infrastructure",
                tagInfraDesc: "Granted by 'Investment' or 'Public Works'. Boosts production cards.",
                tagEdu: "Education",
                tagEduDesc: "Granted by 'Human Capital'. Foundation for technology cards.",
                tagInno: "Innovation",
                tagInnoDesc: "Granted by 'Tech Innovation'. Boosts next tech investment.",
                tagTech: "High-Tech",
                tagTechDesc: "Startups etc. Doubles effect during IT Revolution.",
            }
        };

        const getLoc = (obj, key, lang) => {
             if (lang === 'en' && obj[key + '_en']) return obj[key + '_en'];
             return obj[key];
        };

        const t = (key, lang) => {
            return UI_TEXT[lang][key] || UI_TEXT['ja'][key] || key;
        };

        // --- ゲームデータ定義 ---

        const CARD_TYPES = {
            PRODUCTION: {
                label: '生産',
                label_en: 'PROD',
                baseStyle: 'bg-slate-800 border-cyan-800 hover:border-cyan-400 hover:shadow-cyan-500/20 text-cyan-100',
                headerStyle: 'bg-cyan-950/50 text-cyan-400 border-b border-cyan-900',
                icon: <IconZap size={14} className="text-cyan-400" />
            },
            POLICY: {
                label: '政策',
                label_en: 'POLICY',
                baseStyle: 'bg-slate-800 border-emerald-800 hover:border-emerald-400 hover:shadow-emerald-500/20 text-emerald-100',
                headerStyle: 'bg-emerald-950/50 text-emerald-400 border-b border-emerald-900',
                icon: <IconBookOpen size={14} className="text-emerald-400" />
            },
            ATTACK: {
                label: '外交',
                label_en: 'DIPLO',
                baseStyle: 'bg-slate-800 border-rose-800 hover:border-rose-400 hover:shadow-rose-500/20 text-rose-100',
                headerStyle: 'bg-rose-950/50 text-rose-400 border-b border-rose-900',
                icon: <IconShield size={14} className="text-rose-400" />
            },
        };

        const EVENTS = [
            {
                id: 1,
                name: '原油ショック',
                name_en: 'Oil Shock',
                description: '資源価格高騰であらゆる政策コストが20%上昇します。',
                description_en: 'Resource prices soar, increasing all policy costs by 20%.',
                effect: { costMultiplier: 1.2 },
            },
            {
                id: 2,
                name: '緊縮財政',
                name_en: 'Fiscal Austerity',
                description: '財政再建のため収入が毎ターン3兆円減少します。',
                description_en: 'Income decreases by 3 trillion/turn for fiscal reconstruction.',
                effect: { incomePenalty: 3 },
            },
            {
                id: 3,
                name: '技術革新ブーム',
                name_en: 'Tech Innovation Boom',
                description: 'カードの経済効果が1.3倍に増幅します。',
                description_en: 'Economic effects of cards amplified by 1.3x.',
                effect: { effectMultiplier: 1.3 },
            },
            {
                id: 4,
                name: '景気後退',
                name_en: 'Recession',
                description: 'カードの経済効果が0.7倍に縮小し、資金繰りが厳しくなります。',
                description_en: 'Economic effects reduced by 0.7x, and funding becomes difficult.',
                effect: { effectMultiplier: 0.7, costMultiplier: 1.1 },
            },
        ];

        const ERAS = {
            GROWTH: {
                id: 'GROWTH',
                name: '高度経済成長期',
                name_en: 'High Growth Era',
                description: 'GDP↑ インフレ↑',
                description_en: 'Increased GDP growth, inflation accelerates',
                bgClass: 'bg-orange-900/10',
                effectDesc: 'GDP上昇効果増・インフレ加速',
                effectDesc_en: 'GDP growth bonus, Inflation accelerates'
            },
            STAGNATION: {
                id: 'STAGNATION',
                name: 'バブル崩壊・停滞期',
                name_en: 'Bubble Burst / Stagnation',
                description: 'コスト増・デフレ・収益減',
                description_en: 'Card costs up, income down, deflation',
                bgClass: 'bg-slate-950',
                effectDesc: 'カードコスト増・収益減・デフレ進行',
                effectDesc_en: 'Costs increase, Income decreases, Deflation'
            },
            IT_REV: {
                id: 'IT_REV',
                name: 'IT革命・新時代',
                name_en: 'IT Revolution',
                description: '技術カード効果2倍',
                description_en: 'Technology cards effect doubled',
                bgClass: 'bg-cyan-950/20',
                effectDesc: '技術系カードの効果が2倍',
                effectDesc_en: 'Technology cards effect doubled'
            }
        };

        const IDEOLOGIES = {
            KEYNESIAN: {
                id: 'KEYNESIAN',
                name: 'ケインズ派',
                name_en: 'Keynesian',
                label: '積極財政',
                label_en: 'Active Fiscal',
                description: '不況時は政府支出で需要を創出します。',
                description_en: 'Create demand via government spending during recession.',
                features: ['公共事業・金融緩和 多め', '初期支持率 高', '初期債務 あり'],
                features_en: ['Public Works/Easing', 'High Initial Support', 'Initial Debt'],
                initialStats: { support: 80, debt: 50, money: 120 },
                deckWeights: { 3: 3, 4: 2, 6: 2 },
                rankCriteria: { minGdp: 400, maxInflation: 4, minInflation: 2, maxDebt: 100 }
            },
            MONETARIST: {
                id: 'MONETARIST',
                name: 'マネタリスト',
                name_en: 'Monetarist',
                label: '規律重視',
                label_en: 'Discipline',
                description: '通貨供給を管理し、インフレ抑制を最優先します。',
                description_en: 'Control money supply, prioritize inflation control.',
                features: ['増税・金融引き締め', 'インフレ抑制で高評価', '堅実な運営'],
                features_en: ['Tax Hikes/Tightening', 'High Rating for Low Inf', 'Steady Management'],
                initialStats: { support: 60, debt: 0, money: 70 },
                deckWeights: { 5: 3, 4: 2, 11: 2 },
                rankCriteria: { minGdp: 350, maxInflation: 2, minInflation: -1, maxDebt: 80 },
                bonusCondition: (stats) => stats.inflation >= -1 && stats.inflation <= 2
            },
            SUPPLY_SIDE: {
                id: 'SUPPLY_SIDE',
                name: 'サプライサイド',
                name_en: 'Supply-Side',
                label: '成長戦略',
                label_en: 'Growth Strategy',
                description: '規制緩和と投資で供給力を高め、GDP成長を促します。',
                description_en: 'Deregulation and investment to boost supply and GDP.',
                features: ['設備投資・技術革新', 'GDP重視', '大器晩成'],
                features_en: ['Investment/Innovation', 'GDP Focus', 'Late Bloomer'],
                initialStats: { support: 70, debt: 20, money: 100 },
                deckWeights: { 1: 3, 2: 3, 8: 3 },
                rankCriteria: { minGdp: 450, maxInflation: 6, minInflation: 0, maxDebt: 150 }
            }
        };

        const ALL_CARDS = [
            {
                id: 1,
                name: '設備投資',
                name_en: 'Capital Investment',
                cost: 30,
                type: 'PRODUCTION',
                effect: (me, opp) => ({ ...me, income: me.income + 5, gdp: me.gdp + 10 }),
                description: '工場の機械などを購入し、生産能力を高めます。',
                description_en: 'Purchase factory machinery to increase production capacity.',
                tip: '【投資の乗数効果】投資は将来の生産力と所得を増やします。',
                tip_en: '[Multiplier Effect] Investment increases future production capacity and income.',
                providesTag: 'infrastructure',
                combosWith: ['infrastructure']
            },
            {
                id: 2,
                name: '技術革新',
                name_en: 'Tech Innovation',
                cost: 60,
                type: 'PRODUCTION',
                effect: (me, opp) => ({ ...me, income: me.income + 10, gdp: me.gdp + 30 }),
                description: 'AIやロボットなどの新技術を導入し、効率を劇的に上げます。',
                description_en: 'Adopt AI/robots to dramatically increase efficiency.',
                tip: '【イノベーション】技術進歩は経済成長の最大の要因の一つです。',
                tip_en: '[Innovation] Tech progress is a major growth factor.',
                providesTags: ['innovation', 'tech'],
                combosWith: ['education', 'infrastructure']
            },
            {
                id: 3,
                name: '公共事業',
                name_en: 'Public Works',
                cost: 40,
                type: 'POLICY',
                inflationChange: 2,
                supportChange: 8,
                effect: (me, opp) => ({
                    ...me,
                    gdp: me.gdp + 40,
                    activeEffects: [...(me.activeEffects || []), {
                        name: '公共事業の維持費',
                        name_en: 'Maintenance Cost',
                        turnsLeft: 3,
                        effect: (s) => ({ ...s, income: Math.max(0, s.income - 5) })
                    }]
                }),
                description: '大規模なインフラ整備を行います。GDPは大きく伸びますが、将来の維持費がかさみます。',
                description_en: 'Large-scale infrastructure. Boosts GDP but increases maintenance costs.',
                tip: '【財政政策】政府支出は即効性がありますが、将来の財政硬直化（維持費増大）を招くリスクもあります。',
                tip_en: '[Fiscal Policy] Quick impact, but risks future fiscal rigidity.',
                providesTag: 'infrastructure'
            },
            {
                id: 10,
                name: 'ポピュリズム政策',
                name_en: 'Populist Policy',
                cost: 10,
                type: 'POLICY',
                supportChange: 20,
                inflationChange: 1,
                effect: (me, opp) => ({
                    ...me,
                    gdp: Math.max(0, me.gdp - 15),
                    activeEffects: [...(me.activeEffects || []), {
                        name: 'バラマキのツケ',
                        name_en: 'Cost of Populism',
                        turnsLeft: 2,
                        effect: (s) => ({ ...s, inflation: s.inflation + 3 })
                    }]
                }),
                description: '現金給付などで支持率を爆上げしますが、成長を阻害し、近い将来インフレを招きます。',
                description_en: 'Cash handouts boost support, but hinder growth and cause inflation.',
                tip: '【ポピュリズム】短期的な人気取り政策は、長期的には経済の基礎的条件（ファンダメンタルズ）を悪化させることがあります。',
                tip_en: '[Populism] Short-term popularity often harms long-term fundamentals.'
            },
            {
                id: 11,
                name: '大規模構造改革',
                name_en: 'Structural Reform',
                cost: 30,
                type: 'POLICY',
                supportChange: -15,
                effect: (me, opp) => ({
                    ...me,
                    activeEffects: [...(me.activeEffects || []), {
                        name: '改革の成果',
                        name_en: 'Reform Success',
                        turnsLeft: 3,
                        effect: (s) => ({ ...s, gdp: s.gdp + 50 })
                    }]
                }),
                description: '既得権益を打破します。国民の反発を招きますが、数ターン後に大きな成長をもたらします。',
                description_en: 'Break vested interests. Unpopular now, but brings huge growth later.',
                tip: '【構造改革】規制緩和や市場開放は、短期的には痛み（失業や反発）を伴いますが、長期的には生産性を向上させます。',
                tip_en: '[Structural Reform] Deregulation causes short-term pain but long-term gain.'
            },
            {
                id: 4,
                name: '金融緩和',
                name_en: 'Monetary Easing',
                cost: 0,
                type: 'POLICY',
                inflationChange: 1.5,
                supportChange: 2,
                effect: (me, opp) => ({ ...me, money: me.money + 40 }),
                description: '市場にお金を流し込み、一時的に資金を潤沢にします。',
                description_en: 'Supply money to the market for liquidity.',
                tip: '【マネタリーベース】金利を下げたりお金の供給量を増やし、投資を促します。',
                tip_en: '[Monetary Base] Lowering rates promotes investment.'
            },
            {
                id: 5,
                name: '増税',
                name_en: 'Tax Hike',
                cost: 0,
                type: 'POLICY',
                inflationChange: -1,
                supportChange: -12,
                baseSuccessRate: 90,
                effect: (me, opp) => ({ ...me, money: me.money + 60, gdp: me.gdp - 10 }),
                description: '税率を上げ資金を確保しますが、景気は少し冷え込みます。',
                description_en: 'Raise taxes to secure funds, cooling the economy.',
                tip: '【緊縮財政】財源確保には有効ですが、消費や投資を抑制する副作用があります。',
                tip_en: '[Fiscal Austerity] Secures revenue but suppresses consumption.',
                onFailure: (me) => ({ ...me, support: Math.max(0, me.support - 10) })
            },
            {
                id: 6,
                name: 'スタートアップ支援',
                name_en: 'Startup Support',
                cost: 20,
                type: 'PRODUCTION',
                supportChange: 4,
                effect: (me, opp) => ({ ...me, income: me.income + 8 }),
                description: '起業家を支援し、新たなビジネスを育てます。',
                description_en: 'Support entrepreneurs to nurture new business.',
                tip: '【新産業創出】新しい企業は将来の大きな税収源となります。',
                tip_en: '[New Industry] New firms become future tax sources.',
                providesTags: ['tech'],
                combosWith: ['innovation', 'education']
            },
            {
                id: 7,
                name: '関税引き上げ',
                name_en: 'Tariff Hike',
                cost: 15,
                type: 'ATTACK',
                targetSupportChange: -5,
                targetEffect: (opp) => ({ ...opp, income: Math.max(0, opp.income - 5), money: Math.max(0, opp.money - 10) }),
                description: '輸入品に税金をかけ、相手国の輸出産業にダメージを与えます。',
                description_en: 'Tax imports to damage rival export industries.',
                tip: '【保護貿易】自国産業を守る一方で、貿易戦争のリスクがあります。',
                tip_en: '[Protectionism] Protects domestic industry but risks trade war.'
            },
            {
                id: 8,
                name: '人材育成',
                name_en: 'Human Capital',
                cost: 25,
                type: 'PRODUCTION',
                supportChange: 5,
                effect: (me, opp) => ({ ...me, income: me.income + 3, gdp: me.gdp + 15 }),
                description: '教育に投資し、労働者のスキルを向上させます。',
                description_en: 'Invest in education to improve skills.',
                tip: '【人的資本】教育レベルの向上は、長期的な経済成長に不可欠です。',
                tip_en: '[Human Capital] Education is essential for long-term growth.',
                providesTag: 'education'
            },
            {
                id: 9,
                name: '大規模金融緩和',
                name_en: 'Massive Easing',
                cost: 0,
                type: 'POLICY',
                inflationChange: 3,
                supportChange: 5,
                baseSuccessRate: 80,
                effect: (me, opp) => ({ ...me, money: me.money + 100 }),
                description: '異次元の金融緩和を行い、市場に大量の資金を供給します。',
                description_en: 'Unprecedented easing. High risk of losing market confidence.',
                tip: '【リスク】失敗すると市場の信認を失い、支持率が急落します。',
                tip_en: '[Risk] Failure crashes support rate.',
                onFailure: (me) => ({ ...me, support: Math.max(0, me.support - 20) })
            },
        ];

        const DIFFICULTY_SETTINGS = {
            BEGINNER: {
                id: 'BEGINNER',
                label: 'ビギナー',
                label_en: 'Beginner',
                targetGdp: 200,
                initialMoney: 120,
                initialDebt: 0,
                eventDamageMultiplier: 0.5,
                description: '勝利条件GDPが低く、初期資金が多い。イベントの悪影響も半減します。',
                description_en: 'Low target GDP, high initial funds. Event damage halved.'
            },
            NORMAL: {
                id: 'NORMAL',
                label: 'ノーマル',
                label_en: 'Normal',
                targetGdp: 300,
                initialMoney: 80,
                initialDebt: 0,
                eventDamageMultiplier: 1.0,
                description: '標準的なバランスです。',
                description_en: 'Standard balance.'
            },
            HARD: {
                id: 'HARD',
                label: 'ハード',
                label_en: 'Hard',
                targetGdp: 400,
                initialMoney: 60,
                initialDebt: 30,
                eventDamageMultiplier: 1.5,
                description: '目標GDPが高く、初期債務を抱えた状態からスタート。イベントの悪影響も強まります。',
                description_en: 'High target GDP, start with debt. Stronger event damage.'
            }
        };

        const INFLATION_MIN = -5;
        const INFLATION_MAX = 15;

        const RATING_TIERS = [
            { label: 'AAA', threshold: 0, interestMultiplier: 1, eventDamageMultiplier: 1 },
            { label: 'BBB', threshold: 150, interestMultiplier: 1.25, eventDamageMultiplier: 1.1 },
            { label: 'CCC', threshold: 250, interestMultiplier: 1.6, eventDamageMultiplier: 1.25 },
            { label: 'D', threshold: 400, interestMultiplier: 2, eventDamageMultiplier: 1.5 },
        ];

        const getRatingByDebt = (debt = 0) => {
            const sorted = [...RATING_TIERS].sort((a, b) => b.threshold - a.threshold);
            const found = sorted.find(tier => debt >= tier.threshold);
            return found?.label ?? 'AAA';
        };

        const getRatingInfo = (rating = 'AAA') => RATING_TIERS.find(tier => tier.label === rating) ?? RATING_TIERS[0];

        const clampInflation = (value) => Math.min(INFLATION_MAX, Math.max(INFLATION_MIN, Number(value.toFixed(1))));

        const applyInflationDrift = (value, target = 0) => {
            const diff = target - value;
            const step = 0.3;
            if (Math.abs(diff) < step) return target;
            return clampInflation(value + (diff > 0 ? step : -step));
        };

        const applyInflationChange = (state, delta = 0) => {
            if (!delta) return state;
            return { ...state, inflation: clampInflation((state.inflation ?? 0) + delta) };
        };

        const calculateInflatedCost = (baseCost, inflationRate = 0) => {
            return Math.max(0, Math.round(baseCost * (1 + inflationRate / 100)));
        };

        const calculateSuccessRate = (card, support) => {
            const base = card.baseSuccessRate ?? 100;
            if (base >= 100) return 100;
            // Bonus: (Support - 50) * 0.5. Support 70 -> +10%. Support 30 -> -10%.
            const bonus = (support - 50) * 0.5;
            return Math.min(100, Math.max(0, Math.round(base + bonus)));
        };

        const evaluateGame = (player, difficulty, isWin, ideology = null, lang = 'ja') => {
            // 1. Basic Stats
            const gdp = player.gdp;
            const inflation = player.inflation;
            const debt = player.debt;
            const support = player.support;
            const rating = player.rating;

            // 2. Comments
            let comments = [];
            let nextGoals = [];

            // Ideology Rank Criteria (Defaults to Standard/Keynesian if null)
            const criteria = ideology?.rankCriteria || { minGdp: 400, maxInflation: 4, minInflation: 2, maxDebt: 100 };

            // Inflation Eval
            let inflationEval = lang === 'en' ? "Optimal" : "適正";
            if (inflation < 0) {
                inflationEval = lang === 'en' ? "Deflationary" : "デフレ気味";
                comments.push(lang === 'en' ? "Need to escape deflation" : "デフレ脱却が必要です");
            }
            else if (inflation < criteria.minInflation) { inflationEval = lang === 'en' ? "Low" : "やや低い"; }
            else if (inflation <= criteria.maxInflation) { inflationEval = lang === 'en' ? "Ideal" : "理想的"; }
            else if (inflation <= 8) { inflationEval = lang === 'en' ? "High" : "やや高い"; }
            else {
                inflationEval = lang === 'en' ? "Dangerous" : "危険水域";
                comments.push(lang === 'en' ? "Control inflation immediately" : "インフレ抑制を最優先に");
            }

            // Rank Logic
            let rank = 'C';
            let rankColor = 'text-slate-400';
            let rankLabel = 'NORMAL';

            if (!isWin) {
                rank = 'E';
                rankLabel = 'FAILED';
                rankColor = 'text-gray-500';
                nextGoals.push(lang === 'en' ? "Try to clear the game first!" : "まずはクリアを目指しましょう！");
            } else {
                // Check S (Ideology Specific)
                // Default S: GDP 400, Inf 2-4, Debt 100, AAA, Support 60
                const isS = gdp >= criteria.minGdp
                            && (inflation >= criteria.minInflation && inflation <= criteria.maxInflation)
                            && debt <= criteria.maxDebt
                            && rating === 'AAA'
                            && support >= 60;

                // Check A (Relaxed S)
                const isA = gdp >= (criteria.minGdp * 0.75)
                            && (inflation >= (criteria.minInflation - 2) && inflation <= (criteria.maxInflation + 2))
                            && debt <= (criteria.maxDebt + 100)
                            && (rating === 'AAA' || rating === 'BBB')
                            && support >= 50;

                // Monetarist Bonus: If inflation is perfectly managed, boost rank?
                const bonusAchieved = ideology?.bonusCondition && ideology.bonusCondition(player);
                const effectiveRank = isS ? 'S' : (isA ? 'A' : 'B');

                // Apply Bonus to promote A to S if close? (For now just use S/A logic directly)

                if (isS || (isA && bonusAchieved && effectiveRank !== 'S')) {
                    rank = 'S';
                    rankLabel = 'LEGENDARY';
                    rankColor = 'text-yellow-400 drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]';
                    nextGoals.push(lang === 'en' ? "Perfect Management! No higher title exists." : "完璧な手腕です！これ以上の称号はありません。");
                    if(bonusAchieved) nextGoals.push(lang === 'en' ? "Bonus Goal (Inflation Control) Achieved!" : "ボーナス目標（インフレ抑制）も達成！");
                } else if (isA) {
                    rank = 'A';
                    rankLabel = 'EXCELLENT';
                    rankColor = 'text-emerald-400';
                    // Advice for S
                    if (gdp < criteria.minGdp) nextGoals.push(lang === 'en' ? `Aim for GDP ${criteria.minGdp}T next` : `次はGDP ${criteria.minGdp}兆円を目指そう`);
                    if (inflation < criteria.minInflation || inflation > criteria.maxInflation) nextGoals.push(lang === 'en' ? `Keep Inflation ${criteria.minInflation}-${criteria.maxInflation}%` : `インフレ率 ${criteria.minInflation}-${criteria.maxInflation}% を目指そう`);
                    if (debt > criteria.maxDebt) nextGoals.push(lang === 'en' ? `Keep Debt under ${criteria.maxDebt}T` : `債務 ${criteria.maxDebt}兆円以下の健全財政を目指そう`);
                } else {
                    rank = 'B';
                    rankLabel = 'GOOD';
                    rankColor = 'text-cyan-400';
                     // Advice for A
                    if (inflation > 6) nextGoals.push(lang === 'en' ? "Keep Inflation under 5% for Rank A" : "インフレを 5%以下 に抑えてAランクを目指そう");
                    if (debt > 200) nextGoals.push(lang === 'en' ? "Reduce Debt to maintain Rating" : "債務を減らして格付けを維持しよう");
                    if (support < 50) nextGoals.push(lang === 'en' ? "Keep Support above 50%" : "支持率 50%以上 をキープしよう");
                }
            }

            // Default advice if empty
            if (nextGoals.length === 0) nextGoals.push(lang === 'en' ? "Aim for even greater heights..." : "さらなる高みを目指して...");

            return {
                rank,
                rankLabel,
                rankColor,
                stats: [
                    { label: lang === 'en' ? 'Final GDP' : '最終GDP', value: `${gdp}${t('trillion', lang)}`, note: gdp >= 400 ? (lang === 'en' ? 'S Rank' : 'S基準達成') : '' },
                    { label: lang === 'en' ? 'Inflation' : 'インフレ率', value: `${inflation.toFixed(1)}%`, note: inflationEval },
                    { label: lang === 'en' ? 'Debt' : '債務残高', value: `${debt}${t('trillion', lang)}`, note: `${lang === 'en' ? 'Rating' : '格付'}:${rating}` },
                    { label: lang === 'en' ? 'Support' : '支持率', value: `${support}%`, note: support >= 60 ? (lang === 'en' ? 'High' : '高支持') : '' },
                ],
                nextGoal: nextGoals[0]
            };
        };

        // --- Visual Components ---

        const NumberCounter = ({ value, duration = 1000 }) => {
            const [displayValue, setDisplayValue] = useState(value);

            useEffect(() => {
                let startTime;
                let animationFrameId;
                const startValue = displayValue;
                const endValue = value;

                if (startValue === endValue) return;

                const animate = (currentTime) => {
                    if (!startTime) startTime = currentTime;
                    const progress = Math.min((currentTime - startTime) / duration, 1);
                    // Ease out quart
                    const ease = 1 - Math.pow(1 - progress, 4);

                    const current = Math.floor(startValue + (endValue - startValue) * ease);
                    setDisplayValue(current);

                    if (progress < 1) {
                        animationFrameId = requestAnimationFrame(animate);
                    }
                };
                animationFrameId = requestAnimationFrame(animate);

                return () => cancelAnimationFrame(animationFrameId);
            }, [value]);

            return <span>{displayValue}</span>;
        };

        const TurnOverlay = ({ turn, show }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center pointer-events-none">
                    <div className="bg-slate-900/90 text-cyan-400 text-6xl font-black px-12 py-6 rounded-2xl border-4 border-cyan-500 shadow-[0_0_50px_rgba(6,182,212,0.5)] animate-pop-in">
                        TURN {turn}
                    </div>
                </div>
            );
        };

        const CrisisOverlay = ({ message, show, type = 'danger' }) => {
             if (!show) return null;
             const color = type === 'danger' ? 'text-red-500 border-red-600 bg-red-950/90' : 'text-amber-500 border-amber-600 bg-amber-950/90';

             return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center pointer-events-none">
                    <div className="absolute inset-0 animate-flash-red"></div>
                    <div className={`px-12 py-8 rounded-xl border-4 shadow-2xl animate-pop-in flex flex-col items-center ${color}`}>
                         <IconAlertCircle size={64} className="mb-4 animate-bounce" />
                         <h2 className="text-5xl font-black tracking-tighter uppercase mb-2 text-center whitespace-pre-wrap">{message}</h2>
                         <p className="text-xl font-bold opacity-80 uppercase tracking-widest">EMERGENCY ALERT</p>
                    </div>
                </div>
             );
        };

        const Confetti = () => {
            const particles = Array.from({ length: 50 }).map((_, i) => ({
                id: i,
                left: Math.random() * 100 + '%',
                animationDelay: Math.random() * 2 + 's',
                bg: ['#06b6d4', '#ec4899', '#eab308'][Math.floor(Math.random() * 3)]
            }));

            return (
                <div className="fixed inset-0 pointer-events-none z-[60] overflow-hidden">
                    {particles.map(p => (
                        <div
                            key={p.id}
                            style={{
                                position: 'absolute',
                                top: '-10px',
                                left: p.left,
                                width: '10px',
                                height: '10px',
                                backgroundColor: p.bg,
                                animation: `fall ${2 + Math.random() * 3}s linear infinite`,
                                animationDelay: p.animationDelay
                            }}
                        />
                    ))}
                    <style>{`
                        @keyframes fall {
                            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
                            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
                        }
                    `}</style>
                </div>
            );
        };

        const CardInfoPanel = ({ card, lang }) => {
            if (!card) {
                return (
                     <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 flex flex-col items-center justify-center text-center h-48 animate-fade-in hidden lg:flex">
                        <div className="p-3 rounded-full bg-slate-800 mb-3 opacity-50">
                            <IconBookOpen size={24} className="text-slate-400" />
                        </div>
                        <h3 className="text-sm font-bold text-slate-500 mb-1">{t('cardInfo', lang)}</h3>
                        <p className="text-xs text-slate-600" dangerouslySetInnerHTML={{ __html: t('cardInfoDesc', lang)}}></p>
                     </div>
                );
            }

            const typeInfo = CARD_TYPES[card.type];

            return (
                <div className="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden animate-fade-in shadow-lg">
                    {/* Header */}
                    <div className={`px-4 py-3 border-b border-slate-800 flex items-center gap-2 ${typeInfo?.headerStyle?.replace('bg-', 'bg-opacity-20 bg-')}`}>
                         {typeInfo?.icon}
                         <span className="font-bold text-sm tracking-wider">{getLoc(card, 'name', lang)}</span>
                    </div>

                    <div className="p-4 space-y-4">
                        {/* Tip Section */}
                        <div className="bg-indigo-950/30 border border-indigo-900/50 rounded-xl p-3 relative overflow-hidden">
                             <div className="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                             <div className="flex items-start gap-2 mb-1">
                                 <IconBookOpen size={14} className="text-indigo-400 mt-0.5" />
                                 <span className="text-xs font-bold text-indigo-300">{t('memo', lang)}</span>
                             </div>
                             <p className="text-xs text-slate-300 leading-relaxed pl-1">
                                {getLoc(card, 'tip', lang)}
                             </p>
                        </div>

                        {/* Description */}
                        <div>
                            <div className="text-[10px] font-bold text-slate-500 uppercase mb-1">{t('detail', lang)}</div>
                            <p className="text-xs text-slate-400 leading-relaxed">
                                {getLoc(card, 'description', lang)}
                            </p>
                        </div>

                        {/* Tags */}
                        {(card.providesTags || card.providesTag) && (
                            <div className="flex flex-wrap gap-1 pt-2 border-t border-slate-800/50">
                                {[].concat(card.providesTags || [], card.providesTag || []).filter(Boolean).map(tag => (
                                    <span key={tag} className="text-[10px] px-2 py-1 rounded bg-slate-800 text-slate-500 font-mono">
                                        #{tag}
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ComboGuidePanel = ({ lang }) => {
            const combos = [
                {
                    tag: 'infrastructure',
                    label: t('tagInfra', lang),
                    desc: t('tagInfraDesc', lang),
                    color: 'text-amber-400 bg-amber-900/20 border-amber-500/30'
                },
                {
                    tag: 'education',
                    label: t('tagEdu', lang),
                    desc: t('tagEduDesc', lang),
                    color: 'text-emerald-400 bg-emerald-900/20 border-emerald-500/30'
                },
                {
                    tag: 'innovation',
                    label: t('tagInno', lang),
                    desc: t('tagInnoDesc', lang),
                    color: 'text-cyan-400 bg-cyan-900/20 border-cyan-500/30'
                },
                {
                    tag: 'tech',
                    label: t('tagTech', lang),
                    desc: t('tagTechDesc', lang),
                    color: 'text-purple-400 bg-purple-900/20 border-purple-500/30'
                }
            ];

            return (
                <div className="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-lg mt-6">
                    <div className="bg-slate-800/50 p-3 border-b border-slate-800 flex items-center gap-2">
                         <IconZap size={14} className="text-yellow-400" />
                         <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">{t('comboGuide', lang)}</span>
                    </div>
                    <div className="p-4 space-y-2">
                        {combos.map(c => (
                            <div key={c.tag} className={`p-2 rounded-lg border ${c.color} flex flex-col gap-1`}>
                                <div className="flex items-center gap-2">
                                    <span className="text-[9px] font-black uppercase px-1.5 py-0.5 rounded bg-black/20 tracking-wider">#{c.tag}</span>
                                    <IconArrowRight size={10} className="opacity-50" />
                                    <span className="text-xs font-bold opacity-90">{c.label}</span>
                                </div>
                                <p className="text-[10px] opacity-80 leading-relaxed pl-1">{c.desc}</p>
                            </div>
                        ))}
                         <div className="mt-2 pt-2 border-t border-slate-800/50 text-[10px] text-slate-500 text-center leading-tight">
                            <span className="text-amber-400 font-bold">{t('comboHint', lang)}</span><br/>
                            <span dangerouslySetInnerHTML={{ __html: t('comboHintDesc', lang) }}></span>
                        </div>
                    </div>
                </div>
            );
        };

        const StatusPanel = ({ data, isEnemy, interest, isShaking, lang }) => {
            if (!data) return <div className="p-4 border rounded text-red-500">Error: No Data</div>;

            const inflationAlert = (value) => {
                if (value >= 12) return { label: 'ハイパーインフレ', color: 'text-red-400 bg-red-900/30 border-red-500' };
                if (value >= 8) return { label: '高インフレ', color: 'text-orange-400 bg-orange-900/30 border-orange-500' };
                if (value >= 4) return { label: 'インフレ進行', color: 'text-amber-400 bg-amber-900/30 border-amber-500' };
                if (value <= -2) return { label: 'デフレ', color: 'text-cyan-400 bg-cyan-900/30 border-cyan-500' };
                return { label: '安定', color: 'text-emerald-400 bg-emerald-900/30 border-emerald-500' };
            };

            const alert = inflationAlert(data.inflation || 0);

            // Theme colors (Dark Mode)
            const theme = isEnemy ? {
                bg: 'bg-slate-800/80',
                border: 'border-slate-700',
                text: 'text-slate-300',
                accent: 'text-slate-400',
                highlight: 'bg-slate-700',
                bar: 'bg-slate-500'
            } : {
                bg: 'bg-slate-800/90',
                border: 'border-cyan-900',
                text: 'text-slate-200',
                accent: 'text-cyan-400',
                highlight: 'bg-cyan-950',
                bar: 'bg-cyan-500'
            };

            return (
                <div className={`relative overflow-hidden p-5 rounded-2xl border-2 transition-all duration-300 backdrop-blur-sm ${theme.bg} ${theme.border} ${!isEnemy && 'shadow-xl shadow-cyan-900/10 ring-1 ring-cyan-500/20'} ${isShaking ? 'animate-shake' : ''}`}>
                    {/* Header */}
                    <div className="flex justify-between items-start mb-6">
                        <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center shadow-sm ${isEnemy ? 'bg-slate-700 text-slate-400 border border-slate-600' : 'bg-gradient-to-br from-cyan-600 to-cyan-500 text-white shadow-cyan-900/50'}`}>
                                {isEnemy ? <IconZap size={20} /> : <IconWallet size={20} />}
                            </div>
                            <div>
                                <div className="flex items-center gap-2">
                                    <h3 className={`font-bold text-lg leading-none ${theme.text}`}>
                                        {isEnemy ? t('rivalCountry', lang) : t('myCountry', lang)}
                                    </h3>
                                    <span className={`text-[10px] font-extrabold px-1.5 py-0.5 rounded uppercase tracking-wider ${isEnemy ? 'bg-slate-700 text-slate-400' : 'bg-cyan-950 text-cyan-400 border border-cyan-900'}`}>
                                        {isEnemy ? 'AI' : 'YOU'}
                                    </span>
                                </div>
                                <div className="text-xs text-slate-400 mt-1 font-medium flex items-center gap-1">
                                    RATING:
                                    <span className={`font-bold ${['AAA','BBB'].includes(data.rating) ? 'text-emerald-400' : 'text-amber-400'}`}>{data.rating}</span>
                                </div>
                            </div>
                        </div>

                        <div className="text-right">
                            <div className="text-[10px] uppercase tracking-wider text-slate-500 font-bold mb-0.5">{t('gdp', lang)}</div>
                            <div className={`text-3xl font-black tracking-tighter ${isEnemy ? 'text-slate-500' : 'text-cyan-400'}`}>
                                <NumberCounter value={data.gdp} /><span className="text-sm font-bold ml-1 text-slate-600">{t('trillion', lang)}</span>
                            </div>
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-2 gap-3 mb-4">
                        {/* Money */}
                        <div className={`${theme.highlight} p-3 rounded-xl border border-slate-700/50`}>
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-xs font-bold text-slate-500 flex items-center gap-1">
                                    {t('money', lang)}
                                </span>
                                <span className="text-sm font-bold font-mono text-slate-300">¥<NumberCounter value={data.money} /></span>
                            </div>
                            <div className="w-full bg-slate-900 rounded-full h-1.5 overflow-hidden mb-2">
                                <div className={`h-full rounded-full transition-all duration-500 ${theme.bar}`} style={{ width: `${Math.min(100, data.money)}%` }}></div>
                            </div>
                            <div className="flex justify-between text-[10px] font-medium text-slate-400">
                                <span>{t('income', lang)}: <span className="text-emerald-400">+<NumberCounter value={data.income} /></span></span>
                                <span>{t('interest', lang)}: <span className="text-rose-400">-<NumberCounter value={interest} /></span></span>
                            </div>
                        </div>

                        {/* Support */}
                        <div className={`${theme.highlight} p-3 rounded-xl border border-slate-700/50`}>
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-xs font-bold text-slate-500">{t('support', lang)}</span>
                                <span className={`text-sm font-bold font-mono ${data.support < 30 ? 'text-rose-400' : 'text-slate-300'}`}><NumberCounter value={data.support} />%</span>
                            </div>
                            <div className="w-full bg-slate-900 rounded-full h-1.5 overflow-hidden">
                                <div className={`h-full rounded-full transition-all duration-500 ${data.support < 30 ? 'bg-rose-500' : 'bg-indigo-500'}`} style={{ width: `${data.support}%` }}></div>
                            </div>
                        </div>
                    </div>

                    {/* Footer Stats */}
                    <div className="flex gap-2">
                        <div className="flex-1 bg-slate-900/50 p-2 rounded-lg border border-slate-700/50 flex justify-between items-center">
                            <span className="text-[10px] font-bold text-slate-500">{t('debt', lang)}</span>
                            <span className="text-xs font-bold text-slate-400"><NumberCounter value={data.debt} />{t('trillion', lang)}</span>
                        </div>
                        <div className={`flex-1 p-2 rounded-lg border flex justify-between items-center ${alert.color}`}>
                            <span className="text-[10px] font-bold opacity-70">{t('inflation', lang)}</span>
                            <span className="text-xs font-bold">{data.inflation.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
            );
        };

        // --- メインコンポーネント ---

        function EconomicCardGame() {
            const [turn, setTurn] = useState(1);
            const [era, setEra] = useState(ERAS.GROWTH);
            const [gameState, setGameState] = useState('START'); // START, PLAYING, WON, LOST
            const [logs, setLogs] = useState([]);
            const [activeEvent, setActiveEvent] = useState(null);
            const [lastTags, setLastTags] = useState([]);
            const [isMuted, setIsMuted] = useState(false);
            const [lastPlayedCard, setLastPlayedCard] = useState(null); // Purely for UI visualization
            const [floatingTexts, setFloatingTexts] = useState([]);
            const [showTurnOverlay, setShowTurnOverlay] = useState(false);
            const [shake, setShake] = useState({ player: false, enemy: false });
            const [hoveredCard, setHoveredCard] = useState(null);
            const [crisisAlert, setCrisisAlert] = useState(null); // { message: string, type: 'danger'|'warning' }
            const [evaluation, setEvaluation] = useState(null);
            const [lang, setLang] = useState('ja'); // 'ja' | 'en'

            // Difficulty State
            const [selectedDifficulty, setSelectedDifficulty] = useState(DIFFICULTY_SETTINGS.NORMAL.id);
            const [currentDifficulty, setCurrentDifficulty] = useState(DIFFICULTY_SETTINGS.NORMAL);
            const [selectedIdeology, setSelectedIdeology] = useState(IDEOLOGIES.KEYNESIAN.id);
            const [gameDeck, setGameDeck] = useState([]);
            const [discardPile, setDiscardPile] = useState([]);

            const shuffleArray = (arr) => {
                const copy = [...arr];
                for (let i = copy.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [copy[i], copy[j]] = [copy[j], copy[i]];
                }
                return copy;
            };

            useEffect(() => {
                SoundManager.isMuted = isMuted;
            }, [isMuted]);

            // Update Era based on progress
            useEffect(() => {
                if (gameState !== 'PLAYING') return;

                let nextEra = ERAS.GROWTH;
                // Phase 3: IT Revolution
                if (turn >= 15 || (player && player.gdp >= 200)) {
                    nextEra = ERAS.IT_REV;
                }
                // Phase 2: Stagnation
                else if (turn >= 8 || (player && player.gdp >= 100)) {
                    nextEra = ERAS.STAGNATION;
                }

                if (nextEra.id !== era.id) {
                    setEra(nextEra);
                    const eraName = getLoc(nextEra, 'name', lang);
                    const eraEffect = getLoc(nextEra, 'effectDesc', lang);
                    addLog(`📢 ${eraName} - ${eraEffect}`);
                    SoundManager.playTone(200, 'sawtooth', 0.5, 0.05); // Era change sound
                }
            }, [turn, player, gameState]); // Changed dependency from player.gdp to player to avoid undefined access

            useEffect(() => {
                // Show turn overlay on turn change
                if (gameState === 'PLAYING') {
                    setShowTurnOverlay(true);
                    const timer = setTimeout(() => setShowTurnOverlay(false), 2000);
                    return () => clearTimeout(timer);
                }
            }, [turn, gameState]);

            const triggerShake = (target) => { // 'player' or 'enemy'
                setShake(prev => ({ ...prev, [target]: true }));
                setTimeout(() => setShake(prev => ({ ...prev, [target]: false })), 500);
            };
            
            // プレイヤー状態
            const [player, setPlayer] = useState({
                name: 'あなた',
                money: 100,
                income: 10,
                gdp: 0,
                inflation: 0,
                support: 70,
                debt: 0,
                rating: 'AAA',
                interestDue: 0,
            });
            const [playerHand, setPlayerHand] = useState([]);

            // AI状態
            const [enemy, setEnemy] = useState({
                name: 'ライバル国',
                money: 100,
                income: 10,
                gdp: 0,
                inflation: 0,
                support: 70,
                debt: 0,
                rating: 'AAA',
                interestDue: 0,
            });

            // Crisis Check Effect (Inflation)
            useEffect(() => {
                if (gameState !== 'PLAYING') return;

                if (player.inflation >= 12) {
                     // Only trigger if we aren't already showing one?
                     if (!crisisAlert) {
                         SoundManager.playCrisis();
                         const msg = lang === 'en' ? "CRISIS: RIOTS!\n(Inflation > 12%)" : "暴動の危機！\n(インフレ12%突破)";
                         setCrisisAlert({ message: msg, type: 'danger' });
                         setTimeout(() => setCrisisAlert(null), 3000);
                     }
                }
            }, [player.inflation, gameState, lang]);

            // UI Enhancement: Add Floating Text
            const addFloatingText = (x, y, text, type = 'default') => {
                const id = Math.random();
                // Determine color based on type
                let colorClass = 'text-white';
                let sizeClass = 'text-2xl';

                if (type === 'cost') colorClass = 'text-amber-400';
                if (type === 'income') colorClass = 'text-emerald-400';
                if (type === 'damage') colorClass = 'text-rose-500';
                if (type === 'combo') {
                    colorClass = 'text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-amber-600 drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]';
                    sizeClass = 'text-5xl';
                }

                setFloatingTexts(prev => [...prev, { id, x, y, text, colorClass, sizeClass, type }]);
                setTimeout(() => {
                    setFloatingTexts(prev => prev.filter(ft => ft.id !== id));
                }, 1000);
            };

            // ... (Logic functions remain unchanged)

            const getInflationAlert = (value) => {
                // Not used in UI but kept for logic consistency if needed
                if (value >= 12) return { label: '⚠️ ハイパーインフレ懸念', color: 'text-red-700 bg-red-100 border-red-200' };
                // ...
            };

            const applyUnrestPenalty = (state, actorLabel) => {
                if (state.inflation < 8) return state;

                const angerLevel = state.inflation >= 12 ? '臨界' : state.inflation >= 10 ? '高まり' : '上昇';
                const incomePenalty = state.inflation >= 12 ? 4 : 2;
                const gdpPenalty = state.inflation >= 10 ? 5 : 0;
                const penalizedState = {
                    ...state,
                    income: Math.max(0, state.income - incomePenalty),
                    gdp: Math.max(0, state.gdp - gdpPenalty),
                };

                const msg = lang === 'en'
                    ? `${actorLabel}: High inflation causes unrest! Income -${incomePenalty}${gdpPenalty ? ` / GDP -${gdpPenalty}` : ''}`
                    : `${actorLabel}: インフレ高騰により「国民の不満」が${angerLevel}、所得-${incomePenalty}${gdpPenalty ? ` / GDP-${gdpPenalty}` : ''}`;

                addLog(msg);
                return penalizedState;
            };

            const applySupportChange = (state, delta = 0, actorLabel, reason) => {
                if (!delta) return state;
                const prevSupport = state.support ?? 0;
                const nextSupport = Math.min(100, Math.max(0, prevSupport + delta));
                const msg = lang === 'en'
                    ? `${actorLabel}: Support ${prevSupport}% -> ${nextSupport}% (${reason})`
                    : `${actorLabel}: ${reason}で支持率が${prevSupport}% → ${nextSupport}%に変化`;
                addLog(msg);
                return { ...state, support: nextSupport };
            };

            const applyRatingUpdate = (state, actorLabel) => {
                const nextRating = getRatingByDebt(state.debt ?? 0);
                if (state.rating === nextRating) return state;
                const msg = lang === 'en'
                    ? `${actorLabel}: Rating changed ${state.rating} -> ${nextRating} (Debt: ${state.debt})`
                    : `${actorLabel}: 債務残高${state.debt}兆により格付けが${state.rating} → ${nextRating}に変化`;
                addLog(msg);
                return { ...state, rating: nextRating };
            };

            const getInterestForTurn = (state) => {
                const ratingInfo = getRatingInfo(state.rating);
                return Math.max(0, Math.round((state.interestDue ?? 0) * ratingInfo.interestMultiplier));
            };

            const applyInterestPayment = (state, actorLabel) => {
                const interest = getInterestForTurn(state);
                if (!interest) return state;
                const afterPayment = { ...state, money: Math.max(0, state.money - interest) };
                const msg = lang === 'en'
                    ? `${actorLabel}: Paid ${interest}T interest (Rating: ${state.rating})`
                    : `${actorLabel}: 債務利払いとして ${interest}兆円を支払いました（格付け: ${state.rating}）`;
                addLog(msg);
                return afterPayment;
            };

            // 初期化
            const startGame = () => {
                SoundManager.init();
                SoundManager.playSuccess();

                const difficulty = DIFFICULTY_SETTINGS[selectedDifficulty];
                setCurrentDifficulty(difficulty);

                const ideology = IDEOLOGIES[selectedIdeology];

                // Build Deck based on Ideology
                const newDeck = [];
                ALL_CARDS.forEach(card => {
                    const weight = ideology.deckWeights[card.id] || 1;
                    for(let i=0; i<weight; i++) {
                        newDeck.push(card);
                    }
                });
                const shuffledDeck = shuffleArray(newDeck);
                setGameDeck(shuffledDeck);
                setDiscardPile([]);

                const event = chooseRandomEvent();
                setActiveEvent(event);

                // Initialize Player Stats: Ideology Base + Difficulty Modifiers
                const initialDebt = (ideology.initialStats.debt || 0) + (difficulty.initialDebt || 0);

                const initialPlayerState = {
                    money: (ideology.initialStats.money || 100) + (difficulty.initialMoney - DIFFICULTY_SETTINGS.NORMAL.initialMoney),
                    income: 20,
                    gdp: 0,
                    inflation: 0,
                    support: ideology.initialStats.support || 70,
                    debt: initialDebt,
                    rating: getRatingByDebt(initialDebt),
                    interestDue: Math.round(initialDebt * 0.1),
                    activeEffects: []
                };

                // AI uses standard/difficulty stats or could mirror player (let's use difficulty defaults for AI to keep it standard)
                const initialEnemyState = {
                    money: difficulty.initialMoney,
                    income: 20,
                    gdp: 0,
                    inflation: 0,
                    support: 70,
                    debt: difficulty.initialDebt,
                    rating: getRatingByDebt(difficulty.initialDebt),
                    interestDue: Math.round(difficulty.initialDebt * 0.1),
                    activeEffects: []
                };

                setPlayer(initialPlayerState);
                setEnemy({ ...initialEnemyState, name: 'ライバル国', activeEffects: [] });

                setPlayerHand([]);
                setLastTags([]);
                setTurn(1);

                const eventName = getLoc(event, 'name', lang);
                const eventDesc = getLoc(event, 'description', lang);
                const diffLabel = getLoc(difficulty, 'label', lang);
                const ideologyName = getLoc(ideology, 'name', lang);

                setLogs([
                    lang === 'en' ? `📢 Event: ${eventName} - ${eventDesc}` : `📢 今ターンのイベント: 「${eventName}」 - ${eventDesc}`,
                    lang === 'en' ? `Game Start! Diff: ${diffLabel} / Style: ${ideologyName}` : `ゲーム開始！難易度: ${diffLabel} / 思想: ${ideologyName}`
                ]);
                setGameState('PLAYING');
                setLastPlayedCard(null);
                setFloatingTexts([]);

                // Draw initial cards from the NEW deck.
                // Note: drawCards uses 'gameDeck' state, but state updates are async.
                // So we pass the deck explicitly to a modified draw helper or just set state and use effect?
                // Better: drawCards uses gameDeck from state, but it's empty right now!
                // Fix: Pass the deck to drawCards or handle initial draw separately.
                // Let's modify drawCards to accept an optional deck source.
                drawCards(3, shuffledDeck, []);
            };

            const addLog = (msg) => {
                setLogs(prev => [msg, ...prev].slice(0, 10)); // Increased log size slightly
            };

            const chooseRandomEvent = () => EVENTS[Math.floor(Math.random() * EVENTS.length)];

            const selectTurnEvent = () => {
                const event = chooseRandomEvent();
                setActiveEvent(event);
                const eventName = getLoc(event, 'name', lang);
                const eventDesc = getLoc(event, 'description', lang);
                addLog(lang === 'en' ? `📢 Event: ${eventName} - ${eventDesc}` : `📢 今ターンのイベント: 「${eventName}」 - ${eventDesc}`);
            };

            // カードドロー機能
            const drawCards = (count, sourceDeck = null, sourceDiscard = null) => {
                let deck = sourceDeck ? [...sourceDeck] : [...gameDeck];
                let discarded = sourceDiscard ? [...sourceDiscard] : [...discardPile];
                const drawnCards = [];

                for (let i = 0; i < count; i++) {
                    if (deck.length === 0) {
                        if (discarded.length === 0) {
                            if (i === 0) {
                                addLog(lang === 'en' ? 'Deck is empty. No cards to draw.' : '山札が空です。カードを引けません。');
                            }
                            break;
                        }
                        deck = shuffleArray(discarded);
                        discarded = [];
                        addLog(lang === 'en' ? 'Discard pile reshuffled into deck.' : '捨て札をシャッフルして山札を再構築しました。');
                    }

                    const [card] = deck.splice(-1, 1);
                    drawnCards.push({ ...card, uniqueId: Math.random() });
                }

                if (drawnCards.length > 0) {
                    setPlayerHand(prev => [...prev, ...drawnCards]);
                }

                setGameDeck(deck);
                setDiscardPile(discarded);
            };

            const issueBonds = (e) => {
                if (gameState !== 'PLAYING') return;
                SoundManager.playTone(1000, 'sine', 0.1, 0.1);

                // Show feedback
                if (e) {
                    addFloatingText(e.clientX, e.clientY, "+50", "income");
                }

                setPlayer(prev => {
                    const updated = {
                        ...prev,
                        money: prev.money + 50,
                        debt: (prev.debt ?? 0) + 50,
                        interestDue: (prev.interestDue ?? 0) + 5,
                    };
                    const rated = applyRatingUpdate(updated, 'あなた');
                    const msg = lang === 'en'
                        ? 'YOU: Bond Issued! +50 Money, +50 Debt, Interest +5/turn'
                        : 'あなた: 国債発行！資金+50兆 / 債務+50兆、利払い5兆/ターンを追加';
                    addLog(msg);
                    return rated;
                });
            };

            const applyEventMultiplier = (prevState, nextState) => {
                // 1. Event Multiplier (from card events like Technology Boom)
                const evtMultiplier = activeEvent?.effect?.effectMultiplier || 1;

                // 2. Difficulty Multiplier (affects negative outcomes mainly)
                // Logic: If the delta is negative (bad), amplify it by difficulty multiplier.
                // Beginner: 0.5x bad effect. Hard: 1.5x bad effect.
                const difficultyMult = currentDifficulty.eventDamageMultiplier || 1;

                const applyScale = (key) => {
                    const delta = nextState[key] - prevState[key];

                    // First apply the event multiplier (e.g., Tech Boom x1.3)
                    let scaledDelta = Math.round(delta * evtMultiplier);

                    // Then apply difficulty multiplier if the effect is negative
                    if (scaledDelta < 0) {
                        scaledDelta = Math.round(scaledDelta * difficultyMult);
                    }

                    return prevState[key] + scaledDelta;
                };

                if (evtMultiplier === 1 && difficultyMult === 1) return nextState;

                return {
                    ...nextState,
                    money: applyScale('money'),
                    income: applyScale('income'),
                    gdp: applyScale('gdp'),
                };
            };

            const COMBO_MULTIPLIER = 1.3;

            const applyComboBonus = (prevState, nextState, matchedTags = []) => {
                if (!matchedTags.length) return nextState;
                const applyScale = (key) => {
                    const delta = nextState[key] - prevState[key];
                    return prevState[key] + Math.round(delta * COMBO_MULTIPLIER);
                };
                return {
                    ...nextState,
                    money: applyScale('money'),
                    income: applyScale('income'),
                    gdp: applyScale('gdp'),
                };
            };

            const getCardProvidedTags = (card) => {
                const tags = [];
                if (Array.isArray(card?.providesTags)) {
                    tags.push(...card.providesTags);
                }
                if (card?.providesTag) {
                    tags.push(card.providesTag);
                }
                return tags;
            };

            const withEventMultiplier = (setter) => (updater) => setter(prev => {
                const next = typeof updater === 'function' ? updater(prev) : updater;
                return applyEventMultiplier(prev, next);
            });

            const calculateAdjustedCost = (baseCost, inflationRate = 0) => {
                const inflated = calculateInflatedCost(baseCost, inflationRate);
                let multiplier = activeEvent?.effect?.costMultiplier || 1;

                // Era Effect: Stagnation increases costs
                if (era.id === 'STAGNATION') {
                    multiplier *= 1.5;
                }

                return Math.max(0, Math.round(inflated * multiplier));
            };

            // プレイヤーのターン処理
            const playCard = (card, e) => {
                if (gameState !== 'PLAYING') return;

                const adjustedCost = calculateAdjustedCost(card.cost, player.inflation);
                const comboReadyTags = (card.combosWith ?? []).filter(tag => lastTags.includes(tag));
                const providedTags = getCardProvidedTags(card);
                const cardName = getLoc(card, 'name', lang);

                // Era Effect: IT Revolution (Tech x2)
                const isTech = providedTags.includes('tech');
                const eraMultiplier = (era.id === 'IT_REV' && isTech) ? 2 : 1;

                let updatedEnemyState = null;

                if (player.money < adjustedCost) {
                    SoundManager.playError();
                    addLog(lang === 'en' ? `Not enough funds (Need: ${adjustedCost}T)` : `資金不足です（必要: ${adjustedCost}兆円、インフレ影響を反映）`);
                    return;
                }

                // Show feedback
                if (e) {
                    if (adjustedCost > 0) addFloatingText(e.clientX, e.clientY, `-${adjustedCost}`, "cost");
                }

                // Success Rate Check
                const successRate = calculateSuccessRate(card, player.support);
                const roll = Math.random() * 100;
                const isSuccess = roll < successRate;

                // Pay cost regardless of success (RISK!)
                const afterCost = { ...player, money: player.money - adjustedCost };

                let nextPlayerState = null;

                if (!isSuccess) {
                    // FAILURE
                    SoundManager.playError();
                    triggerShake('player');
                    addFloatingText(e.clientX, e.clientY, "FAILED!", "damage");
                    const failMsg = lang === 'en'
                        ? `YOU: Failed to execute "${cardName}"... (Success Rate ${successRate}%)`
                        : `あなた: 「${cardName}」の実行に失敗... (成功率 ${successRate}%)`;
                    addLog(failMsg);

                    let penaltyState = afterCost;
                    if (card.onFailure) {
                        penaltyState = card.onFailure(penaltyState);
                        addLog(lang === 'en' ? `Side Effect: Support plummeted due to policy failure.` : `副作用: 政策の失敗により支持率が急落しました。`);
                    }
                    nextPlayerState = penaltyState;
                    setPlayer(nextPlayerState);

                    // Discard card
                    setLastPlayedCard(card);
                    setPlayerHand(prev => prev.filter(c => c.uniqueId !== card.uniqueId));

                    return checkWinCondition(nextPlayerState, enemy);
                }

                // SUCCESS
                SoundManager.playCard(card.type);

                if (comboReadyTags.length > 0) {
                    const msg = lang === 'en'
                        ? `★COMBO! Tags [${comboReadyTags.join(', ')}] matched! Efficiency x${COMBO_MULTIPLIER}!`
                        : `★コンボ発動！タグ『${comboReadyTags.join('・')}』が共鳴し、生産性が爆発的に向上！ (x${COMBO_MULTIPLIER})`;
                    addLog(msg);
                    // Visual Feedback for Combo
                    addFloatingText(e ? e.clientX : window.innerWidth/2, e ? e.clientY - 50 : window.innerHeight/2, `⚡ COMBO x${COMBO_MULTIPLIER}!!`, 'combo');
                }

                if (card.type === 'ATTACK') {
                    const afterSupport = applySupportChange(afterCost, card.supportChange, 'あなた', lang === 'en' ? `"${cardName}" political impact` : `「${cardName}」の政治的影響`);
                    nextPlayerState = afterSupport;
                } else {
                    // 1. Base Effect
                    const baseState = card.effect(afterCost, enemy);

                    // 2. Apply Era Multiplier (IT_REV & GROWTH GDP Bonus)
                    let boostedState = baseState;

                    // IT Revolution: Tech cards effect doubled
                    if (eraMultiplier > 1) {
                         const keys = ['money', 'income', 'gdp'];
                         const boosted = { ...baseState };
                         keys.forEach(key => {
                             const delta = baseState[key] - afterCost[key];
                             if (delta !== 0) {
                                 boosted[key] = afterCost[key] + delta * eraMultiplier;
                             }
                         });
                         boostedState = boosted;
                    }

                    // GROWTH Era: GDP Boost
                    if (era.id === 'GROWTH') {
                        // Check if boostedState is valid, otherwise fallback
                        const currentGdp = boostedState ? boostedState.gdp : afterCost.gdp;
                        const deltaGdp = currentGdp - afterCost.gdp;
                        if (deltaGdp > 0 && boostedState) {
                            boostedState.gdp = afterCost.gdp + Math.round(deltaGdp * 1.5);
                        }
                    }

                    const comboBoosted = applyComboBonus(afterCost, boostedState, comboReadyTags);
                    const afterEvent = applyEventMultiplier(afterCost, comboBoosted);

                    // Inflation
                    let inflationDelta = card.inflationChange || 0;
                    if (era.id === 'GROWTH' && inflationDelta > 0) {
                        inflationDelta += 1; // GROWTH inflates faster
                    }
                    const afterInflation = applyInflationChange(afterEvent, inflationDelta);

                    if (inflationDelta) {
                        const infMsg = lang === 'en'
                            ? `YOU: "${cardName}" inflation impact (${inflationDelta > 0 ? '+' : ''}${inflationDelta.toFixed(1)}%)`
                            : `あなた: 「${cardName}」が物価に影響 (${inflationDelta > 0 ? '+' : ''}${inflationDelta.toFixed(1)}%)`;
                        addLog(infMsg);
                    }
                    const afterUnrest = applyUnrestPenalty(afterInflation, 'あなた');
                    const afterSupport = applySupportChange(afterUnrest, card.supportChange, 'あなた', lang === 'en' ? `"${cardName}" effect` : `「${cardName}」の効果`);
                    nextPlayerState = afterSupport;
                }

                setPlayer(nextPlayerState);

                // 効果発動
                if (card.type === 'ATTACK') {
                    const eventAwareSetEnemy = withEventMultiplier(setEnemy);
                    eventAwareSetEnemy(prev => {
                        const effected = card.targetEffect ? card.targetEffect(prev, nextPlayerState) : prev;
                        const comboBoosted = applyComboBonus(prev, effected, comboReadyTags);
                        const unrested = applyUnrestPenalty(comboBoosted, 'ライバル');
                        const withSupport = applySupportChange(unrested, card.targetSupportChange, 'ライバル', lang === 'en' ? `"${cardName}" impact` : `「${cardName}」の影響`);
                        updatedEnemyState = withSupport;
                        return withSupport;
                    });
                    triggerShake('enemy'); // Shake enemy panel
                    addLog(lang === 'en' ? `YOU: Used "${cardName}" to attack rival!` : `あなた: 「${cardName}」を使用！相手を妨害した。`);
                } else {
                    addLog(lang === 'en' ? `YOU: Used "${cardName}". Effect activated.` : `あなた: 「${cardName}」を使用。経済効果発動！`);
                }

                // Tip Log
                if (card.tip) {
                    const tipText = getLoc(card, 'tip', lang);
                    addLog(lang === 'en' ? `💡 [Memo] ${tipText}` : `💡 【経済メモ】${tipText}`);
                }

                // UI update for discard
                setLastPlayedCard(card);

                // 手札から削除
                setPlayerHand(prev => prev.filter(c => c.uniqueId !== card.uniqueId));
                const { uniqueId: _, ...baseCard } = card;
                setDiscardPile(prev => [...prev, baseCard]);

                if (providedTags.length > 0) {
                    setLastTags(providedTags);
                } else {
                    setLastTags([]);
                }

                return checkWinCondition(nextPlayerState, updatedEnemyState ?? enemy);
            };

            // ターン終了処理 & AIターン
            const endTurn = () => {
                if (gameState !== 'PLAYING') return;

                SoundManager.playClick();

                // 0. Process Delayed Effects (Player)
                let currentPlayerState = { ...player };
                let effectsTriggered = [];
                let nextActiveEffects = [];

                if (currentPlayerState.activeEffects) {
                    currentPlayerState.activeEffects.forEach(eff => {
                        if (eff.turnsLeft <= 1) {
                            currentPlayerState = eff.effect(currentPlayerState);
                            effectsTriggered.push(eff.name);
                        } else {
                            nextActiveEffects.push({ ...eff, turnsLeft: eff.turnsLeft - 1 });
                        }
                    });
                }
                currentPlayerState.activeEffects = nextActiveEffects;

                if (effectsTriggered.length > 0) {
                    const msg = lang === 'en'
                        ? `⏰ Delayed Effects: ${effectsTriggered.join(', ')}`
                        : `⏰ 時間差効果発動: ${effectsTriggered.join(', ')}`;
                    addLog(msg);
                    addFloatingText(window.innerWidth / 2, window.innerHeight / 2 - 50, "Delayed Effect!", "income");
                }

                // Era Effect: Stagnation Deflation Drift
                let driftTarget = 0;
                let eraIncomePenalty = 0;
                if (era.id === 'STAGNATION') {
                    driftTarget = -2; // Drift towards deflation
                    eraIncomePenalty = 5; // Reduce income
                }

                // Difficulty multiplier for income penalty
                const diffMult = currentDifficulty.eventDamageMultiplier || 1;

                // 1. 収入の処理（プレイヤー）
                const driftedInflation = applyInflationDrift(currentPlayerState.inflation, driftTarget);
                const ratingInfo = getRatingInfo(currentPlayerState.rating);

                // Calculate base penalty
                let basePenalty = (activeEvent?.effect?.incomePenalty ?? 0) * ratingInfo.eventDamageMultiplier + eraIncomePenalty;

                // Apply difficulty multiplier to the penalty
                const incomePenalty = Math.round(basePenalty * diffMult);

                const playerIncomeGain = Math.max(0, currentPlayerState.income - incomePenalty);
                let playerAfterIncome = {
                    ...currentPlayerState,
                    money: currentPlayerState.money + playerIncomeGain,
                    inflation: driftedInflation,
                };

                // Show Summary Feedback (Center screen)
                addFloatingText(window.innerWidth / 2, window.innerHeight / 2, `Income +${playerIncomeGain}`, "income");

                const interestPaid = getInterestForTurn(playerAfterIncome);
                playerAfterIncome = applyInterestPayment(playerAfterIncome, 'あなた');
                const ratedPlayer = applyRatingUpdate(playerAfterIncome, 'あなた');
                const unrestApplied = applyUnrestPenalty(ratedPlayer, 'あなた');
                setPlayer(unrestApplied);

                // --- Ruin Logic: Debt Collapse ---
                if (unrestApplied.debt >= 400 && unrestApplied.rating === 'D') {
                    SoundManager.playDoom();
                    const msg = lang === 'en' ? '📉 Market Collapse... Economy paralyzed by excess debt.' : '📉 市場の信認崩壊… 債務超過により経済が麻痺しています';
                    addLog(msg);
                    // Add a visual flash too?
                    setCrisisAlert({ message: lang === 'en' ? "Market Collapse..." : "市場の信認崩壊…", type: 'danger' });
                    setTimeout(() => setCrisisAlert(null), 3000);
                }
                // --------------------------------

                const turnEndMsg = lang === 'en'
                    ? `Turn End: Income +${playerIncomeGain}T, Interest -${interestPaid}T, Inflation ${player.inflation.toFixed(1)} -> ${driftedInflation.toFixed(1)}%`
                    : `ターン終了: 収入 +${playerIncomeGain}兆円${incomePenalty ? ` (イベントで-${incomePenalty})` : ''}、利払い -${interestPaid}兆円、インフレ率 ${player.inflation.toFixed(1)} → ${driftedInflation.toFixed(1)}%、格付け ${ratedPlayer.rating}`;
                addLog(turnEndMsg);

                // 2. 勝利判定
                if (checkWinCondition()) return;

                // 3. AIのターン
                const aiEndedGame = aiTurn();

                // 4. 次のターンの準備
                if (!aiEndedGame) {
                    setTurn(prev => prev + 1);
                    drawCards(1);
                    selectTurnEvent();
                }

                setLastTags([]);
            };

            const aiTurn = () => {
                let latestEnemyState = null;

                // Era Effect for AI
                let driftTarget = 0;
                let eraIncomePenalty = 0;
                if (era.id === 'STAGNATION') {
                    driftTarget = -2;
                    eraIncomePenalty = 5;
                }

                setEnemy(prev => {
                    // 0. Process Delayed Effects (AI)
                    let currentEnemyState = { ...prev };
                    let nextActiveEffects = [];
                    let effectsTriggered = [];

                    if (currentEnemyState.activeEffects) {
                        currentEnemyState.activeEffects.forEach(eff => {
                            if (eff.turnsLeft <= 1) {
                                currentEnemyState = eff.effect(currentEnemyState);
                                effectsTriggered.push(eff.name);
                            } else {
                                nextActiveEffects.push({ ...eff, turnsLeft: eff.turnsLeft - 1 });
                            }
                        });
                    }
                    currentEnemyState.activeEffects = nextActiveEffects;

                    if (effectsTriggered.length > 0) {
                        addLog(lang === 'en' ? `RIVAL: Delayed effects: ${effectsTriggered.join(', ')}` : `ライバル: 時間差効果発動: ${effectsTriggered.join(', ')}`);
                    }

                    const drifted = applyInflationDrift(currentEnemyState.inflation, driftTarget);
                    if (drifted !== currentEnemyState.inflation) {
                        addLog(lang === 'en' ? `RIVAL: Inflation drift ${currentEnemyState.inflation.toFixed(1)}% -> ${drifted.toFixed(1)}%` : `ライバル: インフレ率 ${currentEnemyState.inflation.toFixed(1)}% → ${drifted.toFixed(1)}% (自動調整)`);
                    }
                    const afterDrift = { ...currentEnemyState, inflation: drifted };
                    const ratingInfo = getRatingInfo(afterDrift.rating);
                    const incomePenalty = Math.round((activeEvent?.effect?.incomePenalty ?? 0) * ratingInfo.eventDamageMultiplier + eraIncomePenalty);
                    const aiIncomeGain = Math.max(0, afterDrift.income - incomePenalty);
                    let afterIncome = { ...afterDrift, money: afterDrift.money + aiIncomeGain };
                    afterIncome = applyInterestPayment(afterIncome, 'ライバル');
                    const ratedEnemy = applyRatingUpdate(afterIncome, 'ライバル');
                    const unrestAdjusted = applyUnrestPenalty(ratedEnemy, 'ライバル');

                    const potentialActions = ALL_CARDS.filter(c => calculateAdjustedCost(c.cost, unrestAdjusted.inflation) <= unrestAdjusted.money);

                    if (potentialActions.length === 0) {
                        addLog(lang === 'en' ? `RIVAL: Saving funds.` : `ライバル: 資金不足のため資金を温存。`);
                        latestEnemyState = unrestAdjusted;
                        return unrestAdjusted;
                    }

                    const aiCard = potentialActions[Math.floor(Math.random() * potentialActions.length)];
                    const inflatedCost = calculateAdjustedCost(aiCard.cost, unrestAdjusted.inflation);
                    let afterPayment = { ...unrestAdjusted, money: unrestAdjusted.money - inflatedCost };
                    const aiCardName = getLoc(aiCard, 'name', lang); // Use localized name for AI logs

                    if (aiCard.type === 'ATTACK') {
                        const afterSupport = applySupportChange(afterPayment, aiCard.supportChange, 'ライバル', lang === 'en' ? `"${aiCardName}" political impact` : `「${aiCard.name}」の政治的影響`);
                        const eventAwareSetPlayer = withEventMultiplier(setPlayer);
                        eventAwareSetPlayer(prev => {
                            const effected = aiCard.targetEffect ? aiCard.targetEffect(prev, afterSupport) : prev;
                            const unrested = applyUnrestPenalty(effected, 'あなた');
                            return applySupportChange(unrested, aiCard.targetSupportChange, 'あなた', lang === 'en' ? `"${aiCardName}" impact` : `「${aiCard.name}」の影響`);
                        });
                        triggerShake('player'); // Shake player panel
                        addLog(lang === 'en' ? `RIVAL: Used "${aiCardName}"!` : `ライバル: 「${aiCard.name}」を使用！`);
                        latestEnemyState = afterSupport;
                        return afterSupport;
                    }

                    const afterEffect = applyEventMultiplier(afterPayment, aiCard.effect(afterPayment, player));
                    const afterInflation = applyInflationChange(afterEffect, aiCard.inflationChange);
                    if (aiCard.inflationChange) {
                        addLog(lang === 'en' ? `RIVAL: "${aiCardName}" inflation impact` : `ライバル: 「${aiCard.name}」で物価が変動 (${aiCard.inflationChange > 0 ? '+' : ''}${aiCard.inflationChange}%)`);
                    }
                    addLog(lang === 'en' ? `RIVAL: Used "${aiCardName}".` : `ライバル: 「${aiCard.name}」を使用し成長中...`);
                    const unrested = applyUnrestPenalty(afterInflation, 'ライバル');
                    const afterSupport = applySupportChange(unrested, aiCard.supportChange, 'ライバル', lang === 'en' ? `"${aiCardName}" effect` : `「${aiCard.name}」の効果`);
                    latestEnemyState = afterSupport;
                    return afterSupport;
                });

                return checkWinCondition(player, latestEnemyState ?? enemy);
            };

            const checkWinCondition = (nextPlayer = player, nextEnemy = enemy) => {
                if (gameState !== 'PLAYING') return false;

                const target = currentDifficulty.targetGdp || 300;
                let won = false;
                let lost = false;
                let reason = '';

                if (nextPlayer.gdp >= target) {
                    won = true;
                    reason = lang === 'en' ? 'Economic Goal Achieved!' : '経済目標達成！';
                } else if (nextEnemy.gdp >= target) {
                    lost = true;
                    reason = lang === 'en' ? 'Defeated by Rival...' : 'ライバル国に敗北...';
                } else if (nextPlayer.support <= 0) {
                    lost = true;
                    reason = lang === 'en' ? 'Administration collapsed due to low support' : '支持率低下により政権崩壊';
                } else if (nextEnemy.support <= 0) {
                    won = true;
                    reason = lang === 'en' ? 'Rival administration collapsed!' : 'ライバル国が自滅！';
                }

                if (won || lost) {
                    const isWin = won;
                    setGameState(isWin ? 'WON' : 'LOST');
                    SoundManager.playGameEnd(isWin);
                    addLog(isWin ? `🎉 ${reason}` : `💀 ${reason}`);

                    // Calculate Evaluation
                    const result = evaluateGame(nextPlayer, currentDifficulty, isWin, IDEOLOGIES[selectedIdeology], lang);
                    setEvaluation(result);
                    return true;
                }

                return false;
            };

            return (
                <div className={`min-h-screen text-slate-200 relative transition-colors duration-1000 ${era.bgClass}`}>
                    {gameState === 'WON' && <Confetti />}
                    <TurnOverlay turn={turn} show={showTurnOverlay} />
                    <CrisisOverlay message={crisisAlert?.message} show={!!crisisAlert} type={crisisAlert?.type} />

                    {/* Floating Text Overlay */}
                    {floatingTexts.map(ft => (
                        <div
                            key={ft.id}
                            className={`fixed pointer-events-none z-50 font-black ${ft.sizeClass || 'text-2xl'} animate-float-up ${ft.colorClass}`}
                            style={{
                                left: ft.x,
                                top: ft.y,
                                textShadow: ft.type === 'combo' ? 'none' : '0 2px 4px rgba(0,0,0,0.5)'
                            }}
                        >
                            {ft.text}
                        </div>
                    ))}

                    {/* TOP HEADER */}
                    <header className="bg-slate-900/80 backdrop-blur border-b border-slate-800 sticky top-0 z-[110]">
                        {/* Era Indicator Progress Bar */}
                        <div className="absolute top-0 left-0 h-1 bg-gradient-to-r from-cyan-500 via-purple-500 to-rose-500 transition-all duration-1000" style={{ width: `${(turn / 30) * 100}%`, opacity: 0.5 }}></div>

                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-cyan-600 to-blue-600 text-white p-2 rounded-lg shadow-lg shadow-cyan-500/20">
                                    <IconTrendingUp size={20} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-black text-white tracking-tighter leading-none">Economics Master</h1>
                                    <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Strategic Card Game</p>
                                </div>
                            </div>

                            <div className="flex items-center gap-4">
                                <div className="hidden md:flex items-center gap-3">
                                    <div className="flex items-center gap-2 bg-slate-800/50 px-3 py-1.5 rounded-full border border-slate-700/50">
                                        <span className="text-xs font-bold text-amber-400">{getLoc(era, 'name', lang)}</span>
                                    </div>
                                    <div className="flex items-center gap-2 bg-slate-800/50 px-3 py-1.5 rounded-full border border-slate-700/50">
                                        <span className="w-2 h-2 rounded-full bg-cyan-500 animate-pulse"></span>
                                        <span className="text-xs font-bold text-slate-300">{t('turn', lang)} {turn}</span>
                                    </div>
                                    <div className="text-xs font-bold text-slate-500">{t('goal', lang)}: GDP {currentDifficulty.targetGdp}T</div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={() => setLang(l => l === 'ja' ? 'en' : 'ja')}
                                        className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors active:scale-95 flex items-center gap-1"
                                    >
                                        <IconGlobe size={18} />
                                        <span className="text-xs font-bold">{lang === 'ja' ? 'EN' : 'JA'}</span>
                                    </button>
                                    <button
                                        onClick={() => setIsMuted(!isMuted)}
                                        className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors active:scale-95"
                                    >
                                        {isMuted ? <IconVolumeX size={18} /> : <IconVolume2 size={18} />}
                                    </button>
                                    <button
                                        onClick={startGame}
                                        className="text-xs font-bold bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded-lg border border-slate-700 transition-all flex items-center gap-2 active:scale-95"
                                    >
                                        <IconRefreshCw size={14} />
                                        {gameState === 'START' ? t('start', lang) : t('reset', lang)}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">

                        {/* LEFT/CENTER COLUMN (Game Board) */}
                        <div className="lg:col-span-9 space-y-6">
                            
                            {/* 1. OPPONENT FIELD */}
                            <section>
                                <StatusPanel data={enemy} isEnemy={true} interest={getInterestForTurn(enemy)} isShaking={shake.enemy} lang={lang} />
                            </section>

                            {/* 2. MIDDLE ZONE (Deck, Event, Discard) */}
                            <section className="grid grid-cols-1 md:grid-cols-3 gap-4 min-h-[140px]">
                                {/* Discard Pile (Visual) */}
                                <div className="hidden md:flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-slate-800 bg-slate-900/30 p-4 relative group">
                                    <span className="text-xs font-bold text-slate-700 uppercase mb-2">{t('discard', lang)}</span>
                                    {lastPlayedCard ? (
                                         <div className="w-20 h-28 bg-slate-800 border border-slate-600 rounded-lg flex items-center justify-center shadow-lg relative transform group-hover:scale-110 transition-transform">
                                            <div className="text-[10px] text-center p-1">
                                                <div className="font-bold text-slate-300 mb-1 truncate">{getLoc(lastPlayedCard, 'name', lang)}</div>
                                                <div className="text-slate-500 text-[9px]">{t('label', lang)}</div>
                                            </div>
                                         </div>
                                    ) : (
                                        <div className="w-20 h-28 bg-transparent border border-slate-800 rounded-lg flex items-center justify-center opacity-30">
                                            <IconBookOpen size={20} />
                                        </div>
                                    )}
                                </div>

                                {/* Active Event (Center) */}
                                <div className="md:col-span-1">
                                    {activeEvent && gameState === 'PLAYING' ? (
                                        <div className="h-full bg-gradient-to-br from-amber-950/40 to-slate-900 border border-amber-900/50 p-4 rounded-xl flex flex-col justify-center relative overflow-hidden group">
                                            <div className="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity">
                                                <IconAlertCircle size={60} />
                                            </div>
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className="bg-amber-900/50 text-amber-500 text-[10px] font-black px-2 py-0.5 rounded uppercase tracking-wider border border-amber-900">Event</span>
                                            </div>
                                            <h3 className="font-bold text-amber-500 text-lg leading-tight mb-1">{getLoc(activeEvent, 'name', lang)}</h3>
                                            <p className="text-xs text-amber-200/70 leading-relaxed">{getLoc(activeEvent, 'description', lang)}</p>
                                        </div>
                                    ) : (
                                        <div className="h-full flex items-center justify-center text-slate-700 text-xs font-bold uppercase tracking-widest border border-slate-800 rounded-xl bg-slate-900/50">
                                            No Active Event
                                        </div>
                                    )}
                                </div>

                                {/* Deck (Visual) */}
                                <div className="hidden md:flex flex-col items-center justify-center rounded-xl border border-slate-800 bg-slate-900/50 p-4">
                                     <div className={`relative w-24 h-32 transition-transform ${gameDeck.length === 0 ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer hover:-translate-y-1'}`}>
                                        {/* Card Stack Effect */}
                                        <div className="absolute inset-0 bg-slate-800 rounded-lg border border-slate-700 translate-x-2 translate-y-2"></div>
                                        <div className="absolute inset-0 bg-slate-800 rounded-lg border border-slate-700 translate-x-1 translate-y-1"></div>
                                        <div className="absolute inset-0 bg-gradient-to-br from-slate-700 to-slate-800 rounded-lg border border-slate-600 flex items-center justify-center shadow-2xl">
                                            <div className="text-center">
                                                <IconTrendingUp className="text-cyan-900 mb-1 mx-auto" size={24} />
                                                <span className="text-[10px] font-bold text-cyan-900 uppercase tracking-widest">{t('deck', lang)}</span>
                                            </div>
                                        </div>
                                     </div>
                                     <div className="mt-3 text-center space-y-1">
                                        <div className="text-xs font-bold text-slate-400 uppercase tracking-wider">{t('deck', lang)}</div>
                                        <div className={`text-sm font-black ${gameDeck.length === 0 ? 'text-rose-400' : 'text-cyan-400'}`}>
                                            {gameDeck.length}{lang === 'en' ? ' cards' : '枚'}
                                        </div>
                                        {gameDeck.length === 0 && (
                                            <div className="text-[10px] text-rose-300">{lang === 'en' ? 'No cards to draw' : 'ドロー不可'}</div>
                                        )}
                                     </div>
                                </div>
                            </section>

                            {/* 3. PLAYER FIELD */}
                            <section>
                                <StatusPanel data={player} isEnemy={false} interest={getInterestForTurn(player)} isShaking={shake.player} lang={lang} />
                            </section>

                            {/* 4. HAND AREA */}
                            <section className="bg-slate-900/50 rounded-2xl border border-slate-800 p-4 md:p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                        <IconWallet size={16} /> {t('yourHand', lang)}
                                    </h3>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={(e) => issueBonds(e)}
                                            disabled={gameState !== 'PLAYING'}
                                            className="bg-amber-700/20 text-amber-500 border border-amber-900/50 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-amber-700/40 transition-all disabled:opacity-50 flex items-center gap-1.5 active:scale-95"
                                        >
                                            <span className="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
                                            {t('bond', lang)}
                                        </button>
                                        <button
                                            onClick={endTurn}
                                            disabled={gameState !== 'PLAYING'}
                                            className="bg-cyan-600 text-white px-5 py-1.5 rounded-lg text-xs font-bold hover:bg-cyan-500 hover:shadow-lg hover:shadow-cyan-500/20 transition-all disabled:opacity-50 flex items-center gap-2 active:scale-95"
                                        >
                                            {t('endTurn', lang)} <IconArrowRight size={14} />
                                        </button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                    {playerHand.map((card) => {
                                        const typeInfo = CARD_TYPES[card.type];
                                        const inflatedCost = calculateAdjustedCost(card.cost, player.inflation);
                                        const canAfford = player.money >= inflatedCost;
                                        const comboReadyTags = (card.combosWith ?? []).filter(tag => lastTags.includes(tag));
                                        const providesTags = getCardProvidedTags(card);
                                        const successRate = calculateSuccessRate(card, player.support);
                                        const isRisky = successRate < 100;

                                        return (
                                            <button
                                                key={card.uniqueId}
                                                onClick={(e) => playCard(card, e)}
                                                 onMouseEnter={() => setHoveredCard(card)}
                                                 onMouseLeave={() => setHoveredCard(null)}
                                                disabled={!canAfford || gameState !== 'PLAYING'}
                                                className={`
                                                    relative text-left group
                                                    flex flex-col h-full rounded-xl border-2 transition-all duration-300 overflow-hidden
                                                    ${typeInfo.baseStyle}
                                                    ${canAfford ? 'cursor-pointer hover:-translate-y-1 hover:brightness-110 active:scale-95' : 'opacity-40 cursor-not-allowed grayscale border-slate-700 bg-slate-900'}
                                                    ${comboReadyTags.length > 0 && canAfford ? 'ring-2 ring-amber-400 shadow-[0_0_20px_rgba(251,191,36,0.5)] border-amber-400 z-10 scale-[1.02]' : ''}
                                                `}
                                            >
                                                {comboReadyTags.length > 0 && canAfford && (
                                                    <div className="absolute -top-3 -right-2 bg-gradient-to-r from-yellow-400 to-orange-500 text-white text-[10px] font-black px-2 py-0.5 rounded-full shadow-lg z-20 animate-bounce">
                                                        ⚡ COMBO READY
                                                    </div>
                                                )}

                                                {/* Header */}
                                                <div className={`px-3 py-2 flex justify-between items-center ${typeInfo.headerStyle}`}>
                                                    <span className="text-[9px] font-black uppercase tracking-wider flex items-center gap-1">
                                                        {typeInfo.icon} {typeInfo.label}
                                                    </span>
                                                    <span className="font-mono text-base font-black tracking-tighter">¥{inflatedCost}</span>
                                                </div>

                                                {/* Body */}
                                                <div className="p-3 flex flex-col flex-grow bg-slate-900/40 backdrop-blur-sm">
                                                    <h4 className="font-bold text-slate-200 text-xs mb-1.5 min-h-[2.5em] flex items-center leading-snug">
                                                        {getLoc(card, 'name', lang)}
                                                    </h4>

                                                    <p className="text-[10px] text-slate-400 mb-3 flex-grow leading-relaxed line-clamp-3">
                                                        {getLoc(card, 'description', lang)}
                                                    </p>

                                                    <div className="space-y-1">
                                                         {/* Cost Info */}
                                                        {inflatedCost !== card.cost && (
                                                            <div className="text-[9px] text-amber-500 bg-amber-950/30 px-1.5 py-0.5 rounded border border-amber-900/50 flex items-center gap-1 w-max">
                                                                <IconAlertCircle size={8} />
                                                                {t('cost', lang)}: {card.cost}→{inflatedCost}
                                                            </div>
                                                        )}

                                                        {/* Success Rate Info (Only if risky or varied) */}
                                                        <div className={`text-[9px] px-1.5 py-0.5 rounded border flex items-center gap-1 w-max ${
                                                            isRisky
                                                                ? successRate < 70 ? 'text-red-400 bg-red-950/30 border-red-900/50' : 'text-orange-400 bg-orange-950/30 border-orange-900/50'
                                                                : 'text-emerald-400 bg-emerald-950/30 border-emerald-900/50'
                                                        }`}>
                                                            {isRisky && <IconAlertCircle size={8} />}
                                                            {t('successRate', lang)}: {successRate}%
                                                        </div>

                                                        {/* Tags */}
                                                        {(comboReadyTags.length > 0 || providesTags.length > 0) && (
                                                            <div className="flex flex-wrap gap-1 mt-auto pt-2">
                                                                {comboReadyTags.map(tag => (
                                                                     <span key={tag} className="bg-gradient-to-r from-amber-500/20 to-rose-500/20 text-amber-200 border border-amber-500/50 px-2 py-0.5 rounded-full text-[9px] font-black tracking-wide shadow-[0_0_10px_rgba(245,158,11,0.2)] animate-pulse">
                                                                        ★ COMBO: {tag}
                                                                     </span>
                                                                ))}
                                                                {providesTags.map(tag => (
                                                                     <span key={tag} className="bg-slate-800/80 text-cyan-200/80 border border-cyan-800/50 px-2 py-0.5 rounded-full text-[9px] font-bold tracking-wide">
                                                                        #{tag}
                                                                     </span>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </button>
                                        );
                                    })}
                                    {playerHand.length === 0 && (
                                        <div className="col-span-full py-8 flex flex-col items-center justify-center text-slate-600 border-2 border-dashed border-slate-800 rounded-xl">
                                            <IconBookOpen className="mb-2 opacity-50" size={24} />
                                            <p className="text-xs font-medium">{t('noCards', lang)}</p>
                                        </div>
                                    )}
                                </div>
                            </section>
                        </div>

                        {/* RIGHT COLUMN: LOGS & INFO */}
                        <div className="lg:col-span-3 space-y-6">

                            {/* Card Info Panel */}
                            <CardInfoPanel card={hoveredCard || lastPlayedCard} lang={lang} />

                            {/* Game Log Component */}
                            <div className="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden flex flex-col h-[350px] shadow-lg shadow-black/20">
                                <div className="bg-slate-800/50 p-3 border-b border-slate-800 flex justify-between items-center">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                        <IconRefreshCw size={12} /> {t('log', lang)}
                                    </h3>
                                    <span className="text-[10px] text-slate-600 font-mono">{t('live', lang)}</span>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-slate-900">
                                    {logs.map((log, i) => (
                                        <div key={i} className="text-xs leading-relaxed animate-fade-in">
                                            <div className="flex gap-2 text-slate-400">
                                                <span className="text-cyan-700 mt-0.5 select-none text-[8px]">●</span>
                                                <span className={`${i===0 ? 'text-slate-200 font-medium' : ''}`}>{log}</span>
                                            </div>
                                            {i === 0 && <div className="mt-2 h-px bg-gradient-to-r from-cyan-900/50 to-transparent"></div>}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Combo Guide */}
                            <ComboGuidePanel lang={lang} />

                            {/* START SCREEN / OVERLAY */}
                            {gameState === 'START' && (
                                <div className="fixed inset-0 z-[100] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4">
                                    <div className="bg-slate-800 border border-slate-700 p-8 rounded-2xl shadow-2xl max-w-lg w-full text-center relative overflow-hidden">
                                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 via-purple-500 to-rose-500"></div>

                                        <div className="bg-slate-900 inline-flex p-4 rounded-full mb-6 border border-slate-700 shadow-xl">
                                            <IconTrendingUp size={48} className="text-cyan-400" />
                                        </div>

                                        <h2 className="text-3xl font-black text-white mb-2 tracking-tighter">{t('title', lang)}</h2>
                                        <p className="text-slate-400 mb-8 font-medium">{t('subtitle', lang)}</p>

                                        {/* Ideology Selector */}
                                        <div className="mb-8 text-left">
                                            <div className="text-xs font-bold text-slate-500 uppercase mb-3 tracking-wider">{t('selectPlaystyle', lang)}</div>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                                                {Object.values(IDEOLOGIES).map(ideology => {
                                                    const isSelected = selectedIdeology === ideology.id;
                                                    const feats = getLoc(ideology, 'features', lang);
                                                    return (
                                                        <button
                                                            key={ideology.id}
                                                            onClick={() => setSelectedIdeology(ideology.id)}
                                                            className={`
                                                                p-3 rounded-xl border-2 transition-all duration-200 text-left relative overflow-hidden group h-full
                                                                ${isSelected
                                                                    ? 'border-indigo-500 bg-indigo-950/50 text-white shadow-lg shadow-indigo-900/20 scale-[1.02] z-10'
                                                                    : 'border-slate-700 bg-slate-800/50 text-slate-400 hover:border-slate-600 hover:bg-slate-800'}
                                                            `}
                                                        >
                                                            {isSelected && <div className="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>}
                                                            <div className="font-bold text-sm mb-0.5">{getLoc(ideology, 'name', lang)}</div>
                                                            <div className="text-[10px] font-bold opacity-70 mb-2 text-indigo-300">{getLoc(ideology, 'label', lang)}</div>
                                                            <div className="text-[10px] opacity-60 leading-tight mb-2">{getLoc(ideology, 'description', lang)}</div>
                                                            <div className="flex flex-wrap gap-1">
                                                                {feats.map((f, i) => (
                                                                    <span key={i} className="text-[9px] px-1.5 py-0.5 rounded bg-black/20 text-slate-300">{f}</span>
                                                                ))}
                                                            </div>
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        {/* Difficulty Selector */}
                                        <div className="mb-8 text-left">
                                            <div className="text-xs font-bold text-slate-500 uppercase mb-3 tracking-wider">{t('selectDifficulty', lang)}</div>
                                            <div className="grid grid-cols-3 gap-3 mb-4">
                                                {Object.values(DIFFICULTY_SETTINGS).map(diff => {
                                                    const isSelected = selectedDifficulty === diff.id;
                                                    return (
                                                        <button
                                                            key={diff.id}
                                                            onClick={() => setSelectedDifficulty(diff.id)}
                                                            className={`
                                                                p-3 rounded-xl border-2 transition-all duration-200 text-center relative overflow-hidden
                                                                ${isSelected
                                                                    ? 'border-cyan-500 bg-cyan-950/50 text-white shadow-lg shadow-cyan-900/20 scale-105 z-10'
                                                                    : 'border-slate-700 bg-slate-800/50 text-slate-400 hover:border-slate-600 hover:bg-slate-800'}
                                                            `}
                                                        >
                                                            {isSelected && <div className="absolute top-0 left-0 w-full h-1 bg-cyan-500"></div>}
                                                            <div className="font-bold text-sm mb-0.5">{getLoc(diff, 'label', lang)}</div>
                                                            <div className="text-[10px] opacity-70">GDP {diff.targetGdp}T</div>
                                                        </button>
                                                    );
                                                })}
                                            </div>

                                            <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700/50 min-h-[80px] flex items-center">
                                                <div>
                                                    <span className="text-xs font-bold text-cyan-400 block mb-1">
                                                        {getLoc(DIFFICULTY_SETTINGS[selectedDifficulty], 'label', lang)} Mode
                                                    </span>
                                                    <p className="text-xs text-slate-300 leading-relaxed">
                                                        {getLoc(DIFFICULTY_SETTINGS[selectedDifficulty], 'description', lang)}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <button
                                            onClick={startGame}
                                            className="w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-xl font-bold text-lg shadow-lg shadow-cyan-900/20 hover:scale-105 transition-transform active:scale-95"
                                        >
                                            {t('startGame', lang)}
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* WIN/LOSS OVERLAY (REPORT CARD) */}
                            {(gameState === 'WON' || gameState === 'LOST') && evaluation && (
                                <div className="fixed inset-0 z-[100] bg-slate-900/95 backdrop-blur-md flex items-center justify-center p-4">
                                     <div className={`relative p-8 rounded-3xl shadow-2xl max-w-lg w-full border-4 overflow-hidden ${gameState === 'WON' ? 'bg-slate-800 border-cyan-500 shadow-cyan-900/50' : 'bg-slate-800 border-rose-900 shadow-rose-900/50'}`}>

                                        {/* Background Effect */}
                                        <div className="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-black/20 to-transparent pointer-events-none"></div>

                                        {/* Header */}
                                        <div className="text-center mb-6 relative z-10">
                                            <div className="text-xs font-bold uppercase tracking-[0.2em] text-slate-500 mb-2">{t('resultReport', lang)}</div>
                                            <h2 className={`text-5xl font-black tracking-tighter mb-2 ${gameState === 'WON' ? 'text-white' : 'text-rose-500'}`}>
                                                {gameState === 'WON' ? t('victory', lang) : t('defeat', lang)}
                                            </h2>
                                            <div className={`text-sm font-bold px-4 py-1 rounded-full inline-block ${gameState === 'WON' ? 'bg-cyan-950 text-cyan-400' : 'bg-rose-950 text-rose-400'}`}>
                                                {gameState === 'WON' ? t('victoryDesc', lang) : t('defeatDesc', lang)}
                                            </div>
                                        </div>

                                        {/* Rank Circle */}
                                        <div className="flex justify-center mb-8 relative z-10">
                                            <div className="relative w-32 h-32 flex items-center justify-center">
                                                <div className={`absolute inset-0 rounded-full border-4 border-dashed animate-spin-slow opacity-30 ${evaluation.rank === 'S' ? 'border-yellow-500' : 'border-slate-600'}`} style={{ animationDuration: '10s' }}></div>
                                                <div className={`text-8xl font-black ${evaluation.rankColor} drop-shadow-2xl transform scale-110`}>
                                                    {evaluation.rank}
                                                </div>
                                                <div className={`absolute -bottom-4 bg-slate-900 border border-slate-700 px-3 py-1 rounded-lg text-xs font-bold tracking-widest ${evaluation.rankColor}`}>
                                                    {evaluation.rankLabel}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Stats Grid */}
                                        <div className="bg-slate-900/50 rounded-xl border border-slate-700/50 p-4 mb-6 grid grid-cols-2 gap-4 relative z-10">
                                            {evaluation.stats.map((stat, i) => (
                                                <div key={i} className="flex flex-col">
                                                    <span className="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">{stat.label}</span>
                                                    <div className="flex items-baseline gap-2">
                                                        <span className="text-lg font-bold text-slate-200">{stat.value}</span>
                                                        {stat.note && <span className={`text-[10px] font-bold ${stat.note.includes('S基準') || stat.note === '理想的' || stat.note === '高支持' ? 'text-emerald-400' : 'text-amber-400'}`}>{stat.note}</span>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        {/* Advice Box */}
                                        <div className="bg-indigo-900/20 border border-indigo-500/30 rounded-xl p-4 mb-8 text-left relative z-10">
                                            <div className="flex items-center gap-2 mb-2">
                                                <IconZap size={14} className="text-indigo-400" />
                                                <span className="text-xs font-bold text-indigo-300 uppercase tracking-wider">{t('nextGoal', lang)}</span>
                                            </div>
                                            <p className="text-sm text-indigo-100 leading-relaxed font-medium">
                                                {evaluation.nextGoal}
                                            </p>
                                        </div>

                                        <button
                                            onClick={startGame}
                                            className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg transition-all hover:scale-[1.02] active:scale-95 ${gameState === 'WON' ? 'bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-cyan-900/20' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                                        >
                                            {t('playAgain', lang)}
                                        </button>
                                    </div>
                                </div>
                            )}

                        </div>
                    </main>
                </div>
            );
        }

        // アプリケーションのレンダリング
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EconomicCardGame />);
    </script>
</body>
</html>
